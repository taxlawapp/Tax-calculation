<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="login.css" >
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"> <!-- مكتبة الأيقونات -->
<!-- رابط خط Cairo من Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Beiruti:wght@400;700&display=swap" rel="stylesheet"> 
  
  
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/i18n/jquery-ui-i18n.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hijri-date/dist/umd/hijri-date.min.js"></script>  
  
  
<title>حساب مقابل التأخير تجاري</title>
          <!-- لو الأيقونة بصيغة PNG -->
    <link rel="icon" type="image/png" href="https://www3.0zz0.com/2024/05/30/07/482205963.png">
    <style>
    *{
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Beiruti' , sans-serif;
    }
  
    body{
        font-family: 'Beiruti', sans-serif;            
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 5rem;
        background: linear-gradient(to right, white, #e1f5fe);      
        user-select: none;

      
    }
      
    .form{
    margin: 0px auto;          
    border-radius: 0px;
    position: relative;
    padding: 20px 20px 20px;
    background: linear-gradient(to right, white, #e1f5fe);      
    border-radius: 0px;
    text-align: center;
    box-shadow: 50%;
    animation: rotate 1.5s linear infinite;
    border-style: none;
    border: 0px solid #420c0c;
      
    }



    .form h2{
    background: linear-gradient(to right, #eaecee, #e1f5fe);/* خلفية متدرجة */      
    color: #2b0876;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0px;
    font-size: 25px;
    border: 2px solid #420c0c;
    border-radius: 0px; 
    margin-top: 40px; /* إضافة المسافة السفلية */
      
    }
    .form .input{
        text-align: center;
        margin-top: 5px;
        font-weight: 900;

    }



    .form .input .inputbox{
        
        margin-top: 5px;
    }

    .form .input .inputbox label:not(.settings-label,.toggle-all-label){
    background: ; 
    margin-top: 0px;      
    display: block;
    color: #02076e;
    margin-bottom: 2.5px;
    font-size: 22px;
    border: 0px solid #420c0c;
    margin-top: 2px;      

    }

    .form .input .inputbox label1{  
    display: block;
    color: #02076e;
    margin-bottom: 0px;
    font-size: 16px;
    margin-top: 0px;      

    }      
      
    .form .input .inputbox input:not(.settings-checkbox){
    text-align: center;
    font-weight: 900;
    width: 100%;
    background: #ffffff;
    outline: none;
    border-radius: 60px;
    padding: 6px 20px;
    font-size: 20px;
    color: #0e1ba0;
    height: 45px;
    border: 2px solid #420c0c;
    border-radius: 5px;            
    margin:1.5px 0; 
    margin-top: 0px;      

    }
      
.form .input .inputbox input:focus{
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
}
      
      
    .form-control {
    width: 100%;
    height: 45px;
    border: 2px solid #420c0c; 
    border-radius: 0px;
    padding: 0 10px;
    font-size: 18px;
    font-family: 'Beiruti' , sans-serif;
    color: #fff;
    text-align: center;
  
}      

    .forget{
        margin-top: 5px;
        color: #555;
    }

    .forget a{
        color: #ff0047;
    }

     
#textbox31 {
    margin-top: 2.5px;
    font-size: 20px;
    font-weight: bold;  
    background-color: #1a237e;
    color: #FFFF00;
    border-radius: 0px;
    width: 100%;
    height: 30px;
} 
      

  .important-notes {
    border-TOP: 3px solid #ff4d4d;
    padding: 15px 20px;
    margin: 10px 0 60px;
    border-radius: 10px;
    background-color: #fff0f0;
    box-shadow: 0 4px 8px rgba(255, 0, 0, 0.1);
    direction: rtl; /* يجعل النص من اليمين لليسار */
    text-align: right;
  }

  .important-notes label {
    display: block;
    font-size: 16px;
    font-weight: bold;
    color: #d8000c;
    margin-bottom: 8px;
  }

#textbox30 {
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 10px;
  color: #a80000;
  display: flex;
  justify-content: center;  /* يجعل النص في منتصف الإطار */
  align-items: center;
  gap: 8px;
  text-align: center;
}


  .important-notes hr {
    border: 0;
    border-top: 3px dashed #ff4d4d;
    margin: 10px 0 15px;
  }
      
      
/* كلاس الزر الأساسي */
.button {
    font-size: 17px;
    font-weight: bold;
    padding: 7.5px 75px;
    margin: 10px auto;
    border: none;
    border-radius: 5px;
    background: linear-gradient(135deg, #0277bd, #1a237e); /* لون افتراضي */
    color: white;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.3s;
    text-decoration: none;
    display: block;
    text-align: center;
}

.button:hover {
    background-color: #1a237e;
    color: #FFFF00;
    transform: scale(1.05);
    border: 2px solid white;
}

.button:active {
    transform: scale(0.95);
}

.button a {
    text-decoration: none;
    color: inherit;
}

/* ألوان مميزة لكل زر */

/* زر الرصيد */
.btn-balance {
    background: linear-gradient(135deg, #0288d1, #01579b); /* تدرج أزرق مختلف */
}
.btn-balance:hover {
    background-color: #01579b;
}

/* زر الربط */
.btn-difference {
    background: linear-gradient(135deg, #ffb74d, #f57c00); /* تدرج برتقالي */
}
.btn-difference:hover {
    background-color: #f57c00;
}

/* زر السداد */
.btn-payment {
    background: linear-gradient(135deg, #81c784, #388e3c); /* تدرج أخضر */
}
.btn-payment:hover {
    background-color: #388e3c;
}
      


      
#button5 {
    color: white; /* لون النص */
    background: red; /* لون الخلفية */
    border: none; /* إزالة الحدود */
    border-radius: 5px; /* زوايا مستديرة */
    text-decoration: none; /* إزالة التسطير عن النص */
    display: block; /* عرض الزر ككتلة */
    font-size: 17px; /* حجم الخط */
    font-weight: bold; /* وزن الخط */
    padding: 7.5px 75px; /* حجم الحشو */
    margin: 5px auto; /* هامش الزر */
    cursor: pointer; /* تحويل المؤشر إلى يد عند التحويم */
    transition: background-color 0.3s, transform 0.3s; /* تأثير الانتقال */
    text-align: center; /* توسيط النص داخل الزر */
}
  
#button5:hover {
    background-color: darkred; /* تغيير لون الخلفية عند التحويم */
    transform: scale(1.05); /* تحجيم الزر عند التحويم */
  
      } 
      

        /* استايل النص العائم */
        .floating-text {
            font-size: 18px;
            font-weight: bold;
            position: fixed;
            bottom: 27.5px;
            right: 60px; /* تعديل المسافة بين النص والأيقونة */
            background-color: #ffffff;
            color: red;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* الإخفاء الافتراضي للنص */
            margin-bottom: 50px; /* مسافة سفلية */          
        }
      
      
        /* أنماط القائمة السفلية */
        .navbar {
            position: fixed;
            bottom: 3px;
            left: 50%; /* توسيط العنصر أفقيًا */
            transform: translateX(-50%); /* توسيط العنصر بدقة */
            width: 92.5%; /* عرض العنصر */
            background: linear-gradient(135deg, #0277bd, #1a237e); /* خلفية متدرجة */
            display: flex;
            padding: 5px 15px; /* حشو داخلي */
            box-shadow: 2px 2px 2px 2px rgba(0, 0, 0, 0.1); /* ظل خفيف */
            border-radius: 22.5px; /* زوايا مستديرة */
            border-bottom: 3px solid white; /* حدود */
            z-Index:1;
        }

        .navbar .nav-item {
            flex: 1;
            text-align: center;
            color: white; /* لون النص */
            font-size: 14px; /* حجم النص */
            cursor: pointer; /* تغيير شكل المؤشر */
            padding: 5px 0; /* حشو داخلي */
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; /* تأثيرات الانتقال */
            border-width: 1px; /* حدود */
            border-style: solid;
            border-color: transparent;
        }

        .icon {
            margin-bottom: 2px; /* مسافة سفلية للأيقونة */
            font-size: 20px; /* حجم الأيقونة */
        }

        .nav-item span {
            display: block;
            font-size: 15px; /* حجم النص */
            font-weight: bold; /* وزن النص */
            text-decoration: none; /* إزالة التسطير */
        }

        .nav-item span:active {
            font-size: 20px; /* حجم النص */
            font-weight: bold; /* وزن النص */ 
        }

        .nav-item:active .icon {
          font-size: 22px; /* حجم الأيقونة */
        }  
     
        /* أنماط شعار الإشعارات */
        .notification-badge {
            position: absolute;
            top: -5px; /* المسافة من الأعلى */
            right: 87.5px; /* المسافة من اليمين */
            background-color: red; /* لون الخلفية */
            color: white; /* لون النص */
            font-size: 15px; /* حجم النص */
            padding: 2.5px 5px; /* حشو داخلي */
            border-radius: 50%; /* زوايا مستديرة */
            display: flex;
            align-items: center;
            justify-content: center;
        }   
      
        /* أنماط الوضع الليلي للقائمة */
        body.dark-mode .navbar {
            background: #121212; /* لون خلفية القائمة في الوضع الليلي */
            border-top: 2px solid #fafafa; /* حدود علوية */
        }

        body.dark-mode .navbar .nav-item {
            color: #ddd; /* لون النص في الوضع الليلي */
            border-color: transparent; /* حدود شفافة */
        }

        body.dark-mode .navbar .nav-item.home {
            border-color: #ddd; /* حدود العنصر الرئيسي */
            border: none; /* إزالة الحدود */  
        }
      
        body.dark-mode .icon {
            color: #ddd; /* لون الأيقونات في الوضع الليلي */
        }

        /* إزالة الخط تحت أسماء القوائم */
        .navbar-nav .nav-link {
            text-decoration: none;
        }
        .navbar a {
            text-decoration: none;
        } 
  
hr {
    border: none; /* إزالة الحدود الافتراضية */
    border-top: 2.5px solid red; /* تغيير سمك ولون الخط العلوي */
    margin: 10px 0; /* إضافة هوامش فوق وتحت */
    margin-bottom: 10px;  
}      

      
/* تخصيص استايل التقويم */
.ui-datepicker {
    width: 300px; /* عرض التقويم */
    border: 2px solid #ccc; /* حدود التقويم */
    border-radius: 5px; /* زوايا التقويم مستديرة */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* ظل للتقويم */
    font-family: Arial, sans-serif; /* خط التقويم */
}

.ui-datepicker-header {
    background-color: #e1f5fe; /* لون خلفية الرأس */
    border-bottom: 1px solid #0056b3; /* حدود أسفل الرأس */
    color: #fff; /* لون النص في الرأس */
    font-size: 16px; /* حجم خط النص في الرأس */
    text-align: center; /* محاذاة النص إلى الوسط */
    padding: 10px 0; /* مسافة داخل الرأس */
    border-top-left-radius: 5px; /* زاوية علوية يسارية مستديرة */
    border-top-right-radius: 5px; /* زاوية علوية يمينية مستديرة */
}

.ui-datepicker-title {
    font-weight: bold; /* جعل النص عريض */
    color: #02076e; /* لون النص للشهور */
}

.ui-datepicker-prev, .ui-datepicker-next {
    color: #fff; /* لون الأسهم */
    font-size: 16px; /* حجم خط الأسهم */
    cursor: pointer; /* إظهار المؤشر كيد عند التفاعل */
    padding: 0 10px; /* مسافة داخلية حول الأسهم */
}

.ui-datepicker-prev:hover, .ui-datepicker-next:hover {
    color: #d1ecff; /* لون الأسهم عند التفاعل */
}

.ui-datepicker-calendar {
    border-collapse: collapse; /* إزالة المسافات بين الخلايا */
    width: 100%; /* عرض التقويم بالكامل */
}

.ui-datepicker-calendar th {
    background-color: #f0f0f0; /* لون خلفية أيام الأسبوع */
    border: 1px solid #ccc; /* حدود أيام الأسبوع */
    color: #333; /* لون النص لأيام الأسبوع */
    font-weight: normal; /* وزن الخط العادي */
    font-size: 16px; /* حجم الخط */
    padding: 5px; /* مسافة داخلية لأيام الأسبوع */
}

.ui-datepicker-calendar td {
    border: 1px solid #ccc; /* حدود الأيام */
    padding: 5px; /* مسافة داخلية للأيام */
    text-align: center; /* محاذاة النص إلى الوسط */
    font-size: 16px; /* حجم الخط */
}

.ui-datepicker-calendar .ui-state-default {
    background-color: #fff; /* لون خلفية الأيام */
    color: #333; /* لون النص للأيام */
    text-decoration: none; /* إزالة التسطير تحت النص */
    border-radius: 50%; /* جعل الأيام دوائر */
    width: 30px; /* عرض الدائرة */
    height: 30px; /* ارتفاع الدائرة */
    line-height: 30px; /* ارتفاع الخط داخل الدائرة */
    display: inline-block; /* عرض كتلة داخلية لتحديد الخط في المنتصف */
    transition: background-color 0.3s, color 0.3s; /* تأثير التدرج اللوني */
    box-sizing: border-box; /* لضمان أن الدائرة تحوي الرقم في المنتصف بشكل صحيح */
    border: 1px solid transparent; /* إضافة حدود شفافة لتمكين الانتقال */
}

.ui-datepicker-calendar .ui-state-default:hover {
    background-color: #007bff; /* لون الخلفية عند التفاعل */
    color: #fff; /* لون النص عند التفاعل */
    border-color: #007bff; /* تغير لون الحدود عند التفاعل */
}

.ui-datepicker-today .ui-state-default {
    border: 1px solid #007bff; /* حدود اليوم الحالي */
    background-color: #eaf5ff; /* لون خلفية اليوم الحالي */
    color: #333; /* لون النص لليوم الحالي */
}

.ui-datepicker-week-end .ui-state-default {
    color: #c00; /* لون النص لعطلة نهاية الأسبوع */
}

.ui-datepicker-unselectable .ui-state-default {
    color: #999; /* لون النص للأيام غير القابلة للاختيار */
    cursor: not-allowed; /* تغيير المؤشر للأيام غير القابلة للاختيار */
}
      
/* تخصيص مظهر قائمة الشهر */
    .ui-datepicker-month {
        background-color: #0d47a1;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 5px;
        color: white;
    }

    /* تخصيص مظهر قائمة السنة */
    .ui-datepicker-year {
        background-color: #0d47a1;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 5px;
        color: white;
    }

    /* تخصيص مظهر القوائم المنسدلة بشكل عام */
    .ui-datepicker select.ui-datepicker-month, 
    .ui-datepicker select.ui-datepicker-year {
        width: 50%;
        font-size: 20px;
    }

#year0 {
    background-color: #1565c0;
    color: #fff;
    font-weight: 900;
    
    text-align: center;
    width: 100%;
    outline: none;
    border-radius: 60px;
    padding: 6px 20px;
    font-size: 18px;
    height: 45px;
    border: 0px solid #420c0c;
    border-radius: 5px;            
    margin:1.5px 0; 
    margin-top: 0px;      
  
} 
      
  #year0:focus{
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
}       
      
#year {
    background-color: #1565c0;
    color: #fff;
    font-weight: 900;
    
    text-align: center;
    width: 100%;
    outline: none;
    border-radius: 60px;
    padding: 6px 20px;
    font-size: 18px;
    height: 45px;
    border: 0px solid #420c0c;
    border-radius: 5px;            
    margin:1.5px 0; 
    margin-top: 0px;      
  
} 
      
  #year:focus{
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
}      

.form-control option {
  font-size: 18px;
  font-family: 'Beiruti' , sans-serif;
  color: #fff;
}       

#year1 {
    background-color: #1565c0;
    color: #fff;
    font-weight: 900;
    
    text-align: center;
    width: 100%;
    outline: none;
    border-radius: 60px;
    padding: 6px 20px;
    font-size: 18px;
    height: 45px;
    border: 0px solid #420c0c;
    border-radius: 5px;            
    margin:1.5px 0; 
    margin-top: 0px;      
  
} 
      
  #year1:focus{
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
}        

      
#month {
    background-color: #1565c0;
    color: #fff;
    font-weight: 900;   
    text-align: center;
    width: 100%;
    outline: none;
    border-radius: 60px;
    padding: 6px 20px;
    font-size: 18px;
    height: 45px;
    border: 0px solid #420c0c;
    border-radius: 5px;            
    margin:1.5px 0; 
    margin-top: 0px;      
  
} 
      
  #month:focus{
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
} 
      
      
#month1 {
    background-color: #1565c0;
    color: #fff;
    font-weight: 900;
    
    text-align: center;
    width: 100%;
    outline: none;
    border-radius: 60px;
    padding: 6px 20px;
    font-size: 18px;
    height: 45px;
    border: 0px solid #420c0c;
    border-radius: 5px;            
    margin:1.5px 0; 
    margin-top: 0px;      
  
} 
      
  #month1:focus{
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
}
      
      
.table-container {
    overflow-x: auto;
}

/* كلاس عام مشترك للجدولين */
.table-styled {
    background-color: #e1f5fe;
    color: #1a237e;
    margin-top: 5px;
    font-size: 14px;
    font-weight: bold;
    border: 2px solid #420c0c;
    box-shadow: inset -2px -2px 6px rgba(255, 255, 255, .05);
    border-collapse: collapse;
    width: 100%;
}

.table-styled th,
.table-styled td {
    border: 1px solid #ddd;
    padding: 2px;
    text-align: center;
}

.table-styled th {
    background-color: #f2f2f2;
}

/* تخصيصات إضافية حسب الحاجة */
#balanceTable {
    font-size: 13px;
}

#financialTable {
    font-size: 10px;
}

/* تمييز صف معين */
.highlight {
    background-color: #c8e6c9;
}

/* أزرار التعديل والحذف داخل الجدول */
.table-styled .editBtn,
.table-styled .deleteBtn {
    padding: 5px 10px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    border-radius: 4px;
    font-size: 14px;
}

/* زر التعديل */
.table-styled .editBtn {
    background-color: #1a237e; /* أزرق */
    color: white;
}

.table-styled .editBtn:hover {
    background-color: #1a237e;
    color: white;
}

/* زر الحذف */
.table-styled .deleteBtn {
    background-color: #dc3545; /* أحمر */
    color: white;
}

.table-styled .deleteBtn:hover {
    background-color: #c82333;
}

/* نافذة منبثقة */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
    padding-top: 60px;
}

/* محتوى النافذة المنبثقة */
.modal-content {
    background-color: #e1f5fe;
    margin: auto; /* هذه الخاصية تجعل النافذة في منتصف الشاشة */
    padding: 20px;
    border: 2px solid #1a237e;
    width: 100%;
    max-width: 300px;
    direction: rtl;
    border-radius: 15px;
    position: absolute; /* استخدام position absolute لضبط الإزاحة */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* لتحريك النافذة إلى المنتصف */
}

/* زر الإغلاق */
.close {
    position: absolute;
    top: 10px;
    left: 10px;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #d9534f;
}

/* تأثير التمرير على زر الإغلاق */
.close:hover,
.close:focus {
    color: #c9302c;
    text-decoration: none;
    cursor: pointer;
}


        .total-row {
            background-color: #f2f2f2;
            font-weight: bold;
        }      

      
        /* الخلفية الشفافة */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1; 
            display: none; 
        }
        /* نافذة الإدخال */
        #visitPrompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(to right, white, #e1f5fe);      
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 2; 
            width: 300px;
            border: 3px solid #1a237e;
        }
        h2 {
            color: #1a237e;
            font-size: 18px;
            text-align: center;
            margin-bottom: 8px; 
            font-weight: bold;
            border-bottom: 3px solid red;
        }
        p {
            color: #333;
            font-size: 18px;
            text-align: center;
            margin-bottom: 5px; 
            font-weight: bold;
        }      
        input[type="text"] {
            padding: 10px;
            width: 100%; 
            font-size: 20px;
            margin-bottom: 7.5px; 
            text-align: center;
            color: #2b0876;
            font-weight: bold;
            margin-top: 5px;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
        }      
        button {
            padding: 10px;
            text-align: center; 
            font-weight: bold;
            font-size: 18px;
            margin-top: 5px; 
            cursor: pointer;
            width: 100%; 
            border: none;
            border-radius: 5px; 
        }
        .btn-check {
            background-color: #4CAF50; 
            color: white;
        }
        .btn-paste {
            background-color: #2196F3; 
            color: white;
        }
        .btn-clear {
            background-color: #f44336; 
            color: white;
        }
        .btn-free-access {
            background-color: #ffa500;
            color: white;
            padding: 10px;
            text-align: center; 
            font-weight: bold;
            font-size: 18px;
            margin-top: 5px; 
            cursor: pointer;
            width: 100%; 
            border: none;
            border-radius: 5px;
        }
        .disabled {
            background-color: #d3d3d3;
            cursor: not-allowed;
        }
        button i {
            margin-left: 5px; 
        }
        /* تنسيق الرسائل */
        #message {
            margin-top: 10px; 
            color: red; 
            text-align: center; 
            font-weight: bold;
            font-size: 16px;
        }
        /* تنسيق رابط الواتساب */
        .whatsapp-link {
            color: blue; 
            text-decoration: underline; 
            cursor: pointer; 
            font-size: 20px; 
            font-weight: bold; 
        }
      
     #usernameDisplay {
    color: #FFFF00; /* لون النص */
    font-weight: bold; /* وزن الخط */
    font-size: 17px;  
    background-color: #0277BD; /* خلفية النص */
    border: 0px solid #ebccd1; /* حدود النص */
    padding: 10px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    border: 2px solid #1a237e; /* إضافة حد */
    margin-bottom: 5px;   
      }

  tr.رصيد { background-color: #e0f7fa; }     /* أزرق فاتح */
  tr.ربط { background-color: #fff3e0; }      /* برتقالي فاتح */
  tr.سداد { background-color: #e8f5e9; }     /* أخضر فاتح */
#textbox11 {
    background-color: #1565c0;
    color: #fff;
    font-weight: 900;   
    text-align: center;
    width: 100%;
    outline: none;
    border-radius: 60px;
    padding: 6px 20px;
    font-size: 18px;
    height: 45px;
    border: 0px solid #420c0c;
    border-radius: 5px;            
    margin:1.5px 0;   
    margin-top: 0px;      
  
}
      
     #textbox11:focus{
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
}  
      
#textbox12 {
    background-color: #1565c0;
    color: #fff;
    font-weight: 900;   
    text-align: center;
    width: 100%;
    outline: none;
    border-radius: 60px;
    padding: 6px 20px;
    font-size: 18px;
    height: 45px;
    border: 0px solid #420c0c;
    border-radius: 5px;            
    margin:1.5px 0;   
    margin-top: 0px;      
  
}
      
     #textbox12:focus{
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
}  
      
      
.disabled {
  pointer-events: none;
  opacity: 0.6;
  cursor: not-allowed;
}
      
      
        /* أنماط الشريط العلوي */
        .top-bar {
            position: fixed;
            top: 0px; /* المسافة من الأعلى */
            left: 50%; /* توسيط العنصر أفقيًا */
            transform: translateX(-50%); /* توسيط العنصر بدقة */
            width: 100%; /* عرض العنصر */
            height: 57.5px; /* ارتفاع العنصر */
            background: linear-gradient(135deg, #0277bd, #1a237e); /* خلفية متدرجة */
            display: flex;
            justify-content: space-between; /* توزيع العناصر */
            padding: 10px 15px; /* حشو داخلي */
            box-shadow: 2px 2px 2px 2px rgba(0, 0, 0, 0.1); /* ظل خفيف */
            border-radius: 0px 0px 22.5px 22.5px; /* زوايا مستديرة */
            border-bottom: 3px solid white; /* حدود */
            align-items: center; /* توسيط العناصر عموديًا */
            z-index: 1; /* ترتيب العنصر */
            color: white; /* لون النص */
        }


.top-bar .menu-icon {
    font-size: 27.5px;
    cursor: pointer;
}

.top-bar .title {
    font-size: 20px; /* حجم الخط لعناصر العنوان */
    margin-left: 20px; /* مسافة بين السهم والعنوان */
    flex-grow: 1; /* يسمح للعناصر الأخرى بالتقلص عندما تكون الشاشة صغيرة */
    text-align: center; /* توسيط العنوان */
    font-weight: bold;  

}

.top-bar .icon {
    display: none; /* إخفاء الأيقونات بعد التعديل */
}
      
  #discount, #discount200 {
    display: inline-block;
    background: ; 
    margin-top: 0px;      
    color: #02076e;
    margin-bottom: 2.5px;
    font-size: 22px;
    vertical-align: middle;
  }

  #discount200 {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
      
      

/* تنسيق نافذة الرسائل المعدلة */
.message-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: white;
    padding: 25px 30px;
    border-radius: 16px;
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.18);
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 10003; /* أعلى من طبقة التعتيم */
    max-width: 85%;
    width: fit-content;
    min-width: 260px;
    max-width: 320px;
    text-align: center;
    border-top: 5px solid;
}

.message-popup.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

/* تنسيق الأيقونة */
.message-icon {
    font-size: 26px;
    margin-bottom: 2.5px;
    transition: all 0.3s;
}

/* تنسيق الرسالة */
.message-content {
    font-size: 20px;
    line-height: 1.0;
    font-weight: bold; 
    color: #333;
}

/* ألوان وأنواع الرسائل */
.message-popup.info {
    border-color: #4285f4;
    background: linear-gradient(145deg, #f7faff, #e8f1fe);
}
.message-popup.warning {
    border-color: #fbbc05;
    background: linear-gradient(145deg, #fff9e6, #fff2cc);
}
.message-popup.error {
    border-color: #ea4335;
    background: linear-gradient(145deg, #ffefed, #ffe5e3);
}
.message-popup.success {
    border-color: #34a853;
    background: linear-gradient(145deg, #f0f9f2, #e6f5e9);
}

/* ألوان الأيقونات */
.message-popup.info .message-icon { color: #4285f4; }
.message-popup.warning .message-icon { color: #fbbc05; }
.message-popup.error .message-icon { color: #ea4335; }
.message-popup.success .message-icon { color: #34a853; }

/* تأثيرات الحركة */
.message-popup.show .message-icon {
    animation: float 2s ease-in-out infinite;
}
      
        /* طبقة التعتيم */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(3px);
            pointer-events: none;
        }
        .popup-overlay.show {
            opacity: 1;
            display: block;
            pointer-events: auto;
        }

        .settings-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            width: 90%;
            max-width: 400px;
            display: none;
            animation: fadeInUp 0.3s ease-out;
            border: 5px solid #ddd;
        }

        .settings-popup.show {
            display: block;
        }

        .settings-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .settings-header h3 {
            margin: 0;
            font-size: 20px;
            color: #1a237e;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: bold;
        }

        .settings-content {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 12px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        .settings-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }

        .settings-label i {
            font-size: 18px;
            width: 22px;
            text-align: center;
        }

        .settings-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-checkbox {
            -webkit-appearance: none;
            appearance: none;
            width: 26px;
            height: 26px;
            border: 2px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .settings-checkbox:checked {
            background-color: #0277bd;
            border-color: #0277bd;
        }

        .settings-checkbox:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
        }

        .toggle-all {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-all-label {
            font-weight: bold;
            color: #1a237e;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .settings-footer {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .settings-footer a {
            flex: 1;
            padding: 10px 20px;
            font-size: 18px;
            border-radius: 8px;
            max-width: none;
        }

        /* ألوان خاصة بكل نوع من الرسائل */
        .info { 
            color: #0277bd; 
            border-left-color: #0277bd;
            background: #e3f2fd;
        }
        .success { 
            color: #2e7d32; 
            border-left-color: #2e7d32;
            background: #e8f5e9;
        }
        .warning { 
            color: #ff8f00; 
            border-left-color: #ff8f00;
            background: #fff8e1;
        }
        .error { 
            color: #c62828; 
            border-left-color: #c62828;
            background: #ffebee;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -55%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 400px) {
            .settings-popup {
                padding: 15px;
            }
            
            .settings-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .settings-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .settings-select {
                width: 100%;
            }
        }

        #durationInfo {
            background-color: #1565c0;
            color: #fff;
            font-weight: 900;
            text-align: center;
            width: 100%;
            outline: none;
            border-radius: 60px;
            padding: 6px 20px;
            font-size: 18px;
            height: 45px;
            border: 0px solid #420c0c;
            border-radius: 5px;            
            margin:1.5px 0; 
            margin-top: 0px;      
        } 
              
        #durationInfo:focus{
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
        }
              
        #durationSuccess {
            background-color: #1565c0;
            color: #fff;
            font-weight: 900;
            text-align: center;
            width: 100%;
            outline: none;
            border-radius: 60px;
            padding: 6px 20px;
            font-size: 18px;
            height: 45px;
            border: 0px solid #420c0c;
            border-radius: 5px;            
            margin:1.5px 0; 
            margin-top: 0px;      
        } 
              
        #durationSuccess:focus{
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
        }
              
        #durationWarning {
            background-color: #1565c0;
            color: #fff;
            font-weight: 900;
            text-align: center;
            width: 100%;
            outline: none;
            border-radius: 60px;
            padding: 6px 20px;
            font-size: 18px;
            height: 45px;
            border: 0px solid #420c0c;
            border-radius: 5px;            
            margin:1.5px 0; 
            margin-top: 0px;      
        } 
              
        #durationWarning:focus{
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
        }
              
        #durationError {
            background-color: #1565c0;
            color: #fff;
            font-weight: 900;
            text-align: center;
            width: 100%;
            outline: none;
            border-radius: 60px;
            padding: 6px 20px;
            font-size: 18px;
            height: 45px;
            border: 0px solid #420c0c;
            border-radius: 5px;            
            margin:1.5px 0; 
            margin-top: 0px;      
        } 
              
        #durationError:focus{
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.50);
        }
      
      
        :root {
            --transition: all 0.3s ease;
        }
        
        /* زر العائمة الرئيسي */
        .floating-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        
        .floating-btn {
            bottom: 42.5px;
            right: -20px;
            width: 47.5px;
            height: 47.5px;
            background: linear-gradient(135deg, #0277bd, #1a237e); /* خلفية متدرجة */
            color: white;
            border-radius: 50%;
            display: ;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            border: none;
            outline: none;
            position: relative;
            z-index: 1001;
        }
        
        .floating-btn i {
            font-size: 28px;
            transition: var(--transition);
        }
        
        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 15px rgba(67, 97, 238, 0.3);
        }
        
        .floating-btn.active {
            transform: rotate(135deg);
            background: linear-gradient(135deg, #f72585, #b5179e);
        }
        
        /* تأثير النبض */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(67, 97, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* القائمة المنبثقة */
        .floating-menu {
            position: absolute;
            bottom: 95px;
            right: -12.5px;
            width: 230px;
            background: linear-gradient(to right, white, #e1f5fe);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: var(--transition);
            padding: 15px;
            z-index: 1000;
            border: 3px solid #ddd; /* حدود */
        }
        
        .floating-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
      
        /* إضافة هذا لمنع التمرير عند ظهور القائمة */
       .body-no-scroll {
         overflow: hidden;
         position: fixed;
         width: 100%;
         height: 100%;
        }   
      
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }      
        
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;          
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2.5px solid #eee;
        }
        
        .menu-header h3 {
            color: #2b2d42;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin: 0;
        }
        
        .close-btn {
            position: absolute;
            top: 12px;
            left: -87.5px;
            background: none;
            border: none;
            color: #999;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            padding: 0;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: #f72585;
            transform: rotate(90deg);
        }
        
        .menu-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .menu-item {
            padding: 10px 8px;
            margin: 2.5px 0;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .menu-item:hover {
            background-color: rgba(67, 97, 238, 0.1);
            transform: translateX(-5px);
        }
        
        .menu-item i {
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, #4895ef, #4361ee);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .menu-item.gold i {
            background: linear-gradient(135deg, #ffb700, #ffd700);
        }
        
        .menu-item a {
            color: #2b2d42;
            text-decoration: none;
            font-weight: 500;
            flex-grow: 1;
            font-size: 16px;
            font-weight: bold;
        }
        
        .menu-item .badge {
            background-color: #f72585;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 2.5px;
        }
        
        .gold-badge {
            background: gold;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-right: 1.5px;
            font-weight: bold;
        }
        
        /* تأثيرات دخول العناصر */
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .menu-item {
            animation: slideIn 0.3s forwards;
            opacity: 0;
        }
        
        .menu-item:nth-child(1) { animation-delay: 0.1s; }
        .menu-item:nth-child(2) { animation-delay: 0.2s; }
        .menu-item:nth-child(3) { animation-delay: 0.3s; }
        .menu-item:nth-child(4) { animation-delay: 0.4s; }
        .menu-item:nth-child(5) { animation-delay: 0.5s; }
        .menu-item:nth-child(6) { animation-delay: 0.6s; }
        .menu-item:nth-child(7) { animation-delay: 0.7s; }
        .menu-item:nth-child(8) { animation-delay: 0.8s; }      

      
      
    .color-palette {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 12.5px;
        background: #f5f5f5;
        border-radius: 8px;
        margin-left: 0px;
        max-width: 385px;
      margin-top: 2.5px;
      margin-bottom: 2.5px;
      border: 2.5px solid #212121;
    }
    
    .color-option {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s ease;
    }
    
    .color-option:hover {
        border-color: #333;
        transform: scale(1.1);
    }
    
    .color-option.selected {
        border-color: #333;
        transform: scale(1.2);
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    
    #textbox8.highlighted, 
    #textbox6.highlighted,
    #textbox5.highlighted, 
    #textbox4.highlighted {
        background-color: var(--tax-highlight-color, #FFFF99);
        transition: background-color 0.3s ease;
    }  
      
      
        .modal1 {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85); /* خلفية أكثر عتامة */
            z-index: 9999; /* أعلى قيمة لضمان ظهوره فوق كل شيء */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px); /* تأثير ضبابي للخلفية */
        }
        
        .modal1-content {
            width: 90%;
            max-width: 900px;
            background-color: transparent; /* خلفية شفافة */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            position: relative;
        }
        
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* نسبة 16:9 */
            height: 0;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }       
    </style>
  
    <body onload="checkStoredVisitID()">
      
<div class="top-bar">
    <div class="menu-icon" id="menuIcon" onclick="toggleSidebar()">
        <i class="fas fa-arrow-right" onclick="window.location.href='https://taxlawapp.github.io/Tax-calculation/Tax-calculation.html'"></i> <!-- سهم العودة -->
    </div>
    <div class="title">
        حساب مقابل التأخير تجاري ق 91 لسنة 2005
    </div>
</div>

<!-- القائمة السفلية -->
<div class="navbar">
    <a href="https://taxlawapp.github.io/home/Login.html" class="nav-item">
        <i class="fas fa-user icon"></i>
        <span>حسابي</span>
    </a>
    <a href="https://taxlawapp.github.io/home/pro.html" class="nav-item">
        <i class="fas fa-crown icon" style="color: gold;"></i>
        <span>برو</span>
    </a>     
    <a href="https://taxlawapp.github.io/home/home.html" class="nav-item home">
        <i class="fas fa-home icon"></i>
        <span>الرئيسية</span>
    </a>
    <a href="https://youtube.com/@taxlawapp" class="nav-item">
        <i class="fab fa-youtube icon"></i>
        <span>قناتي</span>
    </a>
    <a href="https://taxlawapp.github.io/home/Settings.html" class="nav-item">
        <i class="fas fa-ellipsis-h icon"></i>
        <span>المزيد</span>
    </a>      
</div>
    
      
    <span style="display:none;" id="usernameDisplay"></span> <!-- عرض اسم المستخدم هنا -->     
      
    <!-- الخلفية الشفافة -->
    <div id="overlay"></div>

    <!-- نافذة إدخال معرف الزيارة -->
    <div id="visitPrompt">
        <h2>حساب مقابل التأخير ( تجاري ) | القانون 91 لسنة 2005 وتعديلاته</h2>
        <p>يرجي إدخال معرف إستخدام الشاشة :</p>
        <input type="text" id="visitIDInput" placeholder="أدخل معرف الزيارة الخاص بك">
        <button class="btn-free-access" id="freeAccessBtn" onclick="firstFreeAccess()"> مجاناً <i class="fas fa-user"></i></button>      
        <button class="btn-check" onclick="checkVisitID()"> التحقق <i class="fas fa-check"></i></button>
        <button class="btn-paste" onclick="pasteVisitID()"> لصق <i class="fas fa-paste"></i></button>
        <button class="btn-clear" onclick="clearVisitID()"> إفراغ <i class="fas fa-trash-alt"></i></button>
        <div id="message"></div> <!-- ديف لعرض الرسائل -->
        <div id="contactMessage" style="text-align: center; margin-top: 10px;"></div>
    </div>

    <!-- محتوى الصفحة المخفي -->
    <div id="pageContent" style="display: none;"> 
      
        <div class="form outer">

            <h2>حساب مقابل التأخير ( تجاري ) | القانون 91 لسنة 2005 وتعديلاته</h2>
 
          <div class="input">
              
                    <div class="row inputbox">
                    <div class="col-md-6">
                                      <label id="textbox31">١ ) البيانات الأساسية</label>              
          
<div class="date-picker">
          
            <div class="input">
              
                <div class="row inputbox">
                    <div class="col-md-6">
                    <label for="name">الكيـــان القانـــوني :</label> 
                        <select  class="form-control" id="textbox11" onchange="show2()" placeholder="" type="text">
                        <option>-- اختر من القائمة الكيان القانوني --</option>
                        <option>أفراد | أشخاص طبيعية</option>
                        <option>شركات | أشخاص إعتبارية</option>
                        </select>               
                                  
                         <div class="row inputbox">
                    <div class="col-md-6">
        <label for="name">تاريخ حساب مقابل التأخير :</label>
        <input class="dete" type="" id="endDate" readonly onclick="showPopup('notice-date')" placeholder="أدخل تاريخ حساب مقابل التأخير">                      
                    </div>  
                           
                      
<a id="addtaxBalanceBtn" class="button btn-balance"><i class="fas fa-plus-circle"></i> إضافة رصيد سابق </a> <!-- زر تنفيذي مع أيقونة إضافة جديدة -->                  
                  
<a id="addTaxDifferenceBtn" class="button btn-difference"><i class="fas fa-plus-circle"></i> إضافة ربط جديد </a> <!-- زر تنفيذي مع أيقونة إضافة جديدة -->
<a id="addPaymentBtn" class="button btn-payment"><i class="fas fa-plus-circle"></i> إضافة سداد جديد</a> <!-- زر تنفيذي مع أيقونة سداد -->
                  
<table id="balanceTable" class="table-styled">
  <thead>
    <tr>
      <th>م</th>
      <th>البيان</th>
      <th>السنة</th>
      <th>التاريخ</th>
      <th>المبلغ</th>
      <th>تعديل</th>
      <th>حذف</th>
    </tr>
  </thead>
  <tbody>
    <!-- الصفوف ستتم إضافتها هنا تلقائيًا -->
  </tbody>
  <tfoot>
  <tr class="total-row">
  <td colspan="4">الإجمالي :</td>
  <td id="totalbalance">0</td>
  <td colspan="6"></td>
   </tr>
   </tfoot>  
</table>  

            <input type="checkbox" style="display:;" id="discount200" name="discount200">                           
            <label style="display:;" id="discount">تم خصم مبلغ (200 جنية) من قبل :</label>                            
 
                  
                          <a onclick="calculateFinalTax()" id="button4" class="button"><i class="fas fa-check-circle"></i> إحسب مقابل التأخير</a> <!-- زر تنفيذي مع أيقونة تحقق -->
                           
               <table id="financialTable" class="table-styled">
                <thead>
                    <tr>
                        <th>بداية الفترة</th>
                        <th>نهاية الفترة</th>
                        <th>البيان</th>
                        <th>الشهور</th>
                        <th>معدل الفائدة</th>
                        <th>مبلغ الربط</th>
                        <th>مبلغ السداد</th>
                        <th>الرصيد</th>
                        <th>مقابل التأخير</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- سيتم إضافة الصفوف هنا -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="8">الإجمالي :</td>
                        <td id="totalDelayAmount">0</td>
                    </tr>
                </tfoot>
            </table>                           
                           
                  
                <div class="row">
                <div class="col-md-6">
                <label for="name">إجمالي الضريبة المستحقة (الأصل) :</label>
                <input class="form-control" disabled="" id="textbox5" placeholder="" readonly="" type="text" />
                        </div> 
                                    
                                       
                <div class="row">
                <div class="col-md-6">
                <label for="name">إجمالي مقابل التأخير (الحالي) :</label>
                <input class="form-control" disabled="" id="textbox4" placeholder="" readonly="" type="text" />
                        </div> 
                  

                <div class="row inputbox">
                    <div class="col-md-6">
                    <label for="name">نسبة تجاوز مقابل التأخير :</label> 
                        <select  class="form-control" id="textbox12" onchange="show1()" placeholder="" type="text">
                        <option>-- اختر من القائمة نسبة التجاوز --</option>
                        <option>المادة 45 مكرر</option>
                        <option>0%</option>
                        <option>100%</option>
                        <option>90%</option>
                        <option>75.5%</option>
                        <option>70%</option>
                        <option>65%</option>
                        <option>50%</option>
                        <option>30%</option>  
                        </select>
                      
                      
<div class="row">
  <div class="col-md-6">
    <label for="textbox8">قيمة التجاوز :</label>
    <input class="form-control" disabled id="textbox9" readonly type="text" />
  </div>
</div>  
                      
                      
<div class="row">
  <div class="col-md-6">
    <label for="textbox8">صافي مقابل التأخير بعد التجاوز :</label>
    <input class="form-control" disabled id="textbox10" readonly type="text" />
  </div>
</div>                       
                  
<div class="row">
  <div class="col-md-6">
    <label for="textbox6">إجمالي المبالغ المستحقة (أصل + مقابل) :</label>
    <input class="form-control" disabled id="textbox6" readonly type="text" />
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <label for="textbox7">إجمالي المسدد (أصل + مقابل) :</label>
    <input class="form-control" disabled id="textbox7" readonly type="text" />
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <label for="textbox8">صافي المبالغ المستحقة :</label>
    <input class="form-control" disabled id="textbox8" readonly type="text" />
  </div>
</div>
                


<div id="BalanceModal" class="modal">
    <div class="modal-content">
        <span id="closeBalanceModal" class="close">❌</span>

        <label for="year0">السنة :</label>
        <select id="year0">
            <option>-- اختر من القائمة السنة الضريبية --</option>          
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
            <option value="2015">2015</option>
            <option value="2014">2014</option>
            <option value="2013">2013</option>
            <option value="2012">2012</option>
            <option value="2011">2011</option>
            <option value="2010">2010</option>
            <option value="2009">2009</option>
            <option value="2008">2008</option>
            <option value="2007">2007</option>
            <option value="2006">2006</option>
            <option value="2005">2005</option>
        </select>

        <label for="linkYear">سنة الربط :</label>
        <input type="number" id="linkYear">

        <label for="dueDate">تاريخ استحقاق الرصيد :</label>
        <input type="text" id="dueDate" placeholder="">

        <label for="taxBalance">الرصيد :</label>
        <input type="number" id="taxBalance">

        <a id="saveBalanceBtn" class="button">
            <i class="fas fa-plus-circle"></i> إضافة الرصيد
        </a>
    </div>
</div>
                  
                  
<div id="taxDifferenceModal" class="modal">
    <div class="modal-content">
        <span id="closeTaxDifferenceModal" class="close">❌</span>
        <label for="year">السنة :</label>
        <select id="year">
            <option>-- اختر من القائمة السنة الضريبية --</option>          
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
            <option value="2015">2015</option>
            <option value="2014">2014</option>
            <option value="2013">2013</option>
            <option value="2012">2012</option>
            <option value="2011">2011</option>
            <option value="2010">2010</option>
            <option value="2009">2009</option>
            <option value="2008">2008</option>
            <option value="2007">2007</option>
            <option value="2006">2006</option>
            <option value="2005">2005</option>
        </select>
        <label for="linkYear">سنة الربط :</label>
        <input type="number" id="linkYear1">

        <label for="dueDate">تاريخ استحقاق الربط :</label>
        <input type="text" id="dueDate1" placeholder="">
      
        <label for="taxAmount">مبلغ الربط :</label>
        <input type="number" id="taxAmount">
    <a  id="saveTaxDifferenceBtn" class="button"><i class="fas fa-plus-circle"></i> إضافة الربط </a> <!-- زر تنفيذي مع أيقونة تحقق -->     
    </div>
</div>

  
  
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span id="closePaymentModal" class="close">❌</span>
        <label for="year">السنة :</label>
        <select id="year1">
            <option>-- اختر من القائمة السنة الضريبية --</option>          
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
            <option value="2015">2015</option>
            <option value="2014">2014</option>
            <option value="2013">2013</option>
            <option value="2012">2012</option>
            <option value="2011">2011</option>
            <option value="2010">2010</option>
            <option value="2009">2009</option>
            <option value="2008">2008</option>
            <option value="2007">2007</option>
            <option value="2006">2006</option>
            <option value="2005">2005</option>
        </select>
        <label for="linkYear">سنة السداد :</label>
        <input type="number" id="linkYear2">

        <label for="dueDate">تاريخ السداد :</label>
        <input type="text" id="dueDate2" placeholder="">
        <label for="paymentAmount">مبلغ السداد :</label>
        <input type="number" id="paymentAmount">
    <a  id="savePaymentBtn" class="button"><i class="fas fa-plus-circle"></i> إضافة السداد </a> <!-- زر تنفيذي مع أيقونة تحقق -->      </div>
</div>                  
                                    
  
    <a  onclick="clearFields()" class="button" id="button5"><i class="fas fa-times-circle"></i> إفراغ البيانات</a>   

                                                    
<!-- معلومات هامة -->
<div class="important-notes">
  <label id="textbox30">ملاحظات هامة جداً :</label>
  <hr />
<label id="textbox32" style="font-size: 18px;">١) تاريخ الرصيد هو آخر تاريخ كان الرصيد فيه أكبر من أو يساوي 200 جنيه في التسوية السابقة.</label>
<label id="textbox33" style="font-size: 18px;">٢) يتم تعديل الرصيد بإضافة المستحق أول الشهر التالي لتاريخ الاستحقاق.</label>
<label id="textbox34" style="font-size: 18px;">٣) يتم خصم المسدد من أصل الضريبة أولاً.</label>
</div>                                        

      </div></div></div></div></div></div></div></div></div></div></div></div></div>

              
                 

    <!-- الخلفية المعتمة -->
    <div class="overlay" id="overlay"></div>                 
                      
    <!-- زر الفعل العائم والقائمة -->
    <div class="floating-container">
        <div class="floating-menu" id="floatingMenu">
            <div class="menu-header">
            <h3>روابط هامة للمستخدم :</h3>
                <button class="close-btn" id="closeMenu">❌</button>    
            </div>
            <ul class="menu-items">
                <li class="menu-item" onclick="openSettings()" style="cursor: pointer;">
                  <i class="fas fa-cog"></i>
                  <a>الإعدادات الخاصة بالشاشة</a>
                </li>
               <li class="menu-item" onclick="openVideoPopup()" style="cursor: pointer;">
                  <i class="fas fa-lightbulb"></i>
                  <a>فيديو إستخدام الشاشة</a>
                </li>              
               <li class="menu-item">
                  <i class="fas fa-lightbulb"></i>
                  <a href="https://taxlawapp.github.io/home/ideas.html">تقديم الإقتراحات للتطوير</a>
                </li>
              <li class="menu-item">
                  <i class="fas fa-exclamation-triangle"></i>
                  <a href="https://taxlawapp.github.io/home/problems.html">الإبلاغ الأخطاء المكتشفة</a>
                </li>              
                <li class="menu-item">
                    <i class="fas fa-share-alt"></i>
                    <a href="https://taxlawapp.github.io/home/Share-app.html">شارك التطبيق لأصدقائك</a>
                </li>
                <li class="menu-item">
                    <i class="fas fa-star-half-alt"></i>
                    <a href="https://play.google.com/store/apps/details?id=com.mrizk.taxlawapp">تقييم التطبيق عـ المتجر</a>
                </li>
            </ul>
        </div>
        
        <button class="floating-btn pulse" id="mainButton">
            <i class="fas fa-plus"></i>
        </button>
    </div>
  
<!-- النص العائم -->
<div class="floating-text" id="floatingText">
    إضغط هنا لعرض المزايا والإعدادات 
</div>                       

    <!-- نافذة الفيديو المنبثقة -->
    <div id="videoModal" class="modal1">
        <div class="modal1-content">
            <span class="close-btn" onclick="closeVideoPopup()"></span>
            <div class="video-container">
                <iframe id="youtubeVideo" src="" frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen></iframe>
            </div>
        </div>
    </div>                      
                      

      
    <!-- طبقة التعتيم -->
      <div id="popupOverlay" class="popup-overlay"></div>
    
<!-- النافذة المنبثقة للرسائل -->
<div id="messagePopup" class="message-popup">
    <div class="message-icon" id="messageIcon"></div>
    <div class="message-content" id="messageContent"></div>
</div>                     
                      
<!-- زر فتح الإعدادات -->
    <div id="customPopup" class="popup">
        <div class="popup-content">
            <div class="popup-icon" id="popupIcon"></div>
            <div class="popup-message" id="popupMessage"></div>
        </div>
    </div>

    <div id="popupSettings" class="settings-popup">
        <div class="settings-header">
            <h3><i class="fas fa-sliders-h"></i> إعدادات شاشة | مقابل التأخير تجاري</h3>
        </div>
        
        <div class="settings-content">
          
<div class="toggle-all">
    <input type="checkbox" class="settings-checkbox" id="defaultSettingsEnabled" onchange="handleDefaultSettingsToggle()" checked>
    <label class="toggle-all-label">
        <i class="fas fa-cog"></i>
        <span>تفعيل عدم إفراغ الحقول الأساسية</span>
    </label>
</div> 


<div class="toggle-all">
  <input type="checkbox" class="settings-checkbox" id="autoSetTodayDate" onchange="handleTodayDateToggle()" checked>
  <label class="toggle-all-label">
    <i class="fas fa-calendar-day"></i>
    <span>تفعيل تاريخ مقابل التأخير اليوم تلقائيًا</span>
  </label>
</div>
          
<!-- زر تمييز حقول احتساب الضريبة -->
<div class="toggle-all">
    <input type="checkbox" class="settings-checkbox" id="highlightTaxFieldsEnabled" onchange="handleHighlightTaxFieldsToggle()" checked>
    <label class="toggle-all-label">
        <i class="fas fa-highlighter"></i>
        <span>تمييز لون حقول إحتساب الضريبة</span>
    </label>
</div>
          
    <!-- ألوان التمييز (مخفية بشكل افتراضي) -->
    <div class="color-palette" id="taxFieldsColorPalette" style="display: none; margin-top: 10px;">
        <div class="color-option" data-color="#FFFF99" style="background-color: #FFFF99;" onclick="selectTaxHighlightColor(this)" title="أصفر فاتح"></div>      
        <div class="color-option" data-color="#E0FFFF" style="background-color: #E0FFFF;" onclick="selectTaxHighlightColor(this)" title="سماوي فاتح"></div>
        <div class="color-option" data-color="#FFCC99" style="background-color: #FFCC99;" onclick="selectTaxHighlightColor(this)" title="برتقالي فاتح"></div>
        <div class="color-option" data-color="#99CCFF" style="background-color: #99CCFF;" onclick="selectTaxHighlightColor(this)" title="أزرق فاتح"></div>
        <div class="color-option" data-color="#99FF99" style="background-color: #99FF99;" onclick="selectTaxHighlightColor(this)" title="أخضر فاتح"></div>
        <div class="color-option" data-color="#FF99FF" style="background-color: #FF99FF;" onclick="selectTaxHighlightColor(this)" title="وردي فاتح"></div>
        <div class="color-option" data-color="#CC99FF" style="background-color: #CC99FF;" onclick="selectTaxHighlightColor(this)" title="بنفسجي فاتح"></div>
        <div class="color-option" data-color="#FF9999" style="background-color: #FF9999;" onclick="selectTaxHighlightColor(this)" title="أحمر فاتح"></div>      
    </div>          
          
            <div class="toggle-all">
                <input type="checkbox" class="settings-checkbox" id="popupEnabled" onchange="toggleAllMessages()">
                <label class="toggle-all-label">
                    <i class="fas fa-bell"></i>
                    <span>تفعيل إختفاء جميع الرسائل التنبهية</span>
                </label>
            </div>
          
            <div class="toggle-all">
            <input type="checkbox" class="settings-checkbox" id="resetAllDurations" onchange="resetAllDurations()">
                <label class="toggle-all-label">
                    <i class="fas fa-sliders-h"></i>
                    <span>ضبط إختفاء جميع الرسائل التنبهية</span>
                </label>
            </div>          
          
            

          
            <div class="settings-item">
                <label class="settings-label">
                    <i class="fas fa-info-circle info"></i>
                    <span>التحكم فـ ظهور / ومدة إختفاء رسائل المعلومات (Info) :</span>
                </label>
                <div class="settings-controls">
                    <select class="settings-select" id="durationInfo">
                        <option value="1000" selected>1 ثانية</option> <!-- ✅ الافتراضي -->
                        <option value="2500">2.5 ثانية</option>
                        <option value="5000">5 ثواني</option>
                        <option value="10000">10 ثواني</option>
                        <option value="15000">15 ثانية</option>
                        <option value="30000">30 ثانية</option>
                    </select>
                    <input type="checkbox" class="settings-checkbox" id="enableInfo" onchange="updateSettings('info')">
                </div>
            </div>

            <div class="settings-item">
                <label class="settings-label">
                    <i class="fas fa-check-circle success"></i>
                    <span>التحكم فـ ظهور / ومدة إختفاء رسائل النجاح (Success) :</span>
                </label>
                <div class="settings-controls">
                    <select class="settings-select" id="durationSuccess">
                        <option value="1000" selected>1 ثانية</option> <!-- ✅ الافتراضي -->
                        <option value="2500">2.5 ثانية</option>
                        <option value="5000">5 ثواني</option>
                        <option value="10000">10 ثواني</option>
                        <option value="15000">15 ثانية</option>
                        <option value="30000">30 ثانية</option>
                    </select>
                    <input type="checkbox" class="settings-checkbox" id="enableSuccess" onchange="updateSettings('success')">
                </div>
            </div>

            <div class="settings-item">
                <label class="settings-label">
                    <i class="fas fa-exclamation-triangle warning"></i>
                    <span>التحكم فـ ظهور / ومدة إختفاء رسائل التحذير (Warning) :</span>
                </label>
                <div class="settings-controls">
                    <select class="settings-select" id="durationWarning">
                        <option value="1000" selected>1 ثانية</option> <!-- ✅ الافتراضي -->           
                        <option value="2500">2.5 ثانية</option>
                        <option value="5000">5 ثواني</option>
                        <option value="10000">10 ثواني</option>
                        <option value="15000">15 ثانية</option>
                        <option value="30000">30 ثانية</option>
                    </select>
                    <input type="checkbox" class="settings-checkbox" id="enableWarning" onchange="updateSettings('warning')">
                </div>
            </div>

            <div class="settings-item">
                <label class="settings-label">
                    <i class="fas fa-times-circle error"></i>
                    <span>التحكم فـ ظهور / ومدة إختفاء رسائل الخطأ (Error) :</span>
                </label>
                <div class="settings-controls">
                    <select class="settings-select" id="durationError">
                        <option value="1000" selected>1 ثانية</option> <!-- ✅ الافتراضي -->
                        <option value="2500">2.5 ثانية</option>
                        <option value="5000">5 ثواني</option>
                        <option value="10000">10 ثواني</option>
                        <option value="15000">15 ثانية</option>
                        <option value="30000">30 ثانية</option>
                    </select>
                    <input type="checkbox" class="settings-checkbox" id="enableError" onchange="updateSettings('error')">
                </div>
            </div>


  
        </div>

        <div class="settings-footer">
            <a onclick="saveSettings()" class="button"><i class="fas fa-save"></i> حفظ</a>
            <a onclick="closeSettings()" class="button" style="background: linear-gradient(135deg, #e53935, #c62828);"><i class="fas fa-times"></i> إغلاق</a>
        </div>
    </div>
</div>

<script>   
// كود يستخدم في شاشات إحتساب مقابل التأخير فقط لفصل النوافذ المنبثقة      
function isolateModalStyles() {
    // عزل أنماط النوافذ
    document.querySelectorAll('.modal:not(.settings-popup):not(.modal1)').forEach(modal => {
        Object.assign(modal.style, {
            display: 'none',
            position: 'fixed',
            zIndex: '1000',
            left: '0',
            top: '0',
            width: '100%',
            height: '100%',
            backgroundColor: 'rgba(0,0,0,0.4)',
            paddingTop: '60px'
        });
    });

    // عزل أنماط المحتوى
    document.querySelectorAll('.modal-content:not(.settings-content):not(.modal1-content)').forEach(content => {
        Object.assign(content.style, {
            backgroundColor: '#e1f5fe',
            margin: 'auto',
            padding: '20px',
            border: '2px solid #1a237e',
            width: '100%',
            maxWidth: '300px',
            borderRadius: '15px',
            position: 'absolute',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)'
        });
    });

    // عزل أنماط أزرار الإغلاق
    document.querySelectorAll('.close:not(.popup-close):not(.settings-close):not(.close-btn)').forEach(btn => {
        Object.assign(btn.style, {
            position: 'absolute',
            top: '10px',
            left: '10px',
            color: '#d9534f',
            fontSize: '20px',
            cursor: 'pointer'
        });
    });
}

// استدعاء الدالة عند تحميل الصفحة
window.addEventListener('DOMContentLoaded', isolateModalStyles);      
      
// كود عدم افراغ الحقول الاساسية       
function setDefaultFormValues() {
    // الكيان القانوني: أفراد | أشخاص طبيعية
    const legalEntitySelect = document.getElementById('textbox11');
    if (legalEntitySelect) {
        for (let i = 0; i < legalEntitySelect.options.length; i++) {
            if (legalEntitySelect.options[i].text.includes('أفراد | أشخاص طبيعية')) {
                legalEntitySelect.selectedIndex = i;
                break;
            }
        }
    }
  
    // نسبة التجاوز: المادة 45 مكرر  
    const overrideSelect  = document.getElementById('textbox12');
    if (overrideSelect  ) {
        for (let i = 0; i < overrideSelect .options.length; i++) {
            if (overrideSelect .options[i].text.includes('المادة 45 مكرر')) {
                overrideSelect .selectedIndex = i;
                break;
            }
        }
    }  
}
// استدعاء الدالة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', setDefaultFormValues);
    
// دالة للتحكم في تفعيل وإلغاء افراغ الحقول الاساسية
function handleDefaultSettingsToggle() {
    // الحصول على عنصر خانة الاختيار
    const defaultSettingsCheckbox = document.getElementById('defaultSettingsEnabled');
    const isChecked = defaultSettingsCheckbox.checked;
    
    // حفظ الحالة في التخزين المحلي عند التفعيل أو إزالتها عند الإلغاء
    if (isChecked) {
        localStorage.setItem('defaultSettingsEnabled', 'true');
    } else {
        localStorage.removeItem('defaultSettingsEnabled');
    }
    
    // تحضير الرسالة المناسبة حسب الحالة
    const message = isChecked 
        ? "تم تفعيل عدم إفراغ حقول الإدخال الأساسية" 
        : "تم إلغاء تفعيل إفراغ حقول الإدخال الأساسية";
    
    // نوع الرسالة (نجاح للمسح، معلومة للتأكيد)
    const messageType = isChecked ? 'info' : 'success';
    
    // عرض الرسالة المنبثقة
    showMessage(message, messageType, 1000, true);

    // تأخير تنفيذ العمليات لضمان ظهور الرسالة
    setTimeout(() => {
        if (isChecked) {
            setDefaultFormValues(); // تعيين القيم الافتراضية
        } else {
            resetAllSelectsToFirstOption(); // إعادة تعيين الحقول
        }
    }, 300);
}

// دالة لتعيين القيم الافتراضية للنموذج
function setDefaultFormValues() {
    // تعيين الكيان القانوني: أفراد | أشخاص طبيعية
    setSelectValue('textbox11', 'أفراد | أشخاص طبيعية');
  
    // تعيين نسبة التجاوز: المادة 45 مكرر
    setSelectValue('textbox12', 'المادة 45 مكرر');  
}

// العناصر
function setSelectValue(id, searchText) {
    const selectElement = document.getElementById(id);
    if (selectElement) {
        for (let i = 0; i < selectElement.options.length; i++) {
            if (selectElement.options[i].text.includes(searchText)) {
                selectElement.selectedIndex = i;
                break;
            }
        }
    }
}


// دالة لإعادة تعيين جميع حقول select إلى الخيار الأول
function resetAllSelectsToFirstOption() {
    const selectIds = ['textbox11', 'textbox12'];
    
    selectIds.forEach(id => {
        const selectElement = document.getElementById(id);
        if (selectElement && selectElement.options.length > 0) {
            selectElement.selectedIndex = 0;
        }
    });
}

// تهيئة الصفحة عند التحميل
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('defaultSettingsEnabled');
    
    if (checkbox) {
        // التحقق من وجود إعدادات محفوظة مسبقاً
        const isDefaultEnabled = localStorage.getItem('defaultSettingsEnabled') === 'true';
        
        // تعيين حالة الخانة حسب التخزين المحلي
        checkbox.checked = isDefaultEnabled;
        
        if (isDefaultEnabled) {
            // إذا كانت مفعلة مسبقاً، تعيين القيم بدون عرض الرسالة
            setDefaultFormValues();
        } else {
            // إذا لم تكن مفعلة، تفعيلها تلقائياً وعرض الرسالة
            checkbox.checked = true;
            localStorage.setItem('defaultSettingsEnabled', 'true');
            showMessage("تم تفعيل عدم إفراغ حقول الإدخال الأساسية", 'info', 1000, true);
            setDefaultFormValues();
        }
    }
});


// دالة لتعيين تاريخ اليوم في حقل endDate
function setTodayDateForEndDate() {
    const today = new Date();
    const formattedDate = today.getFullYear() + '/' + 
        String(today.getMonth() + 1).padStart(2, '0') + '/' + 
        String(today.getDate()).padStart(2, '0');

    const endDateInput = document.getElementById('endDate');
    if (endDateInput) {
        endDateInput.value = formattedDate;
    }
}

function handleTodayDateToggle() {
  const dateCheckbox = document.getElementById('autoSetTodayDate');
  const isChecked = dateCheckbox.checked;

  if (isChecked) {
    localStorage.setItem('autoSetTodayDate', 'true');
    setTodayDateForEndDate();
    showMessage("تم تعيين تاريخ اليوم تلقائيًا لتاريخ مقابل التأخير", 'info', 1000, true);
  } else {
    localStorage.setItem('autoSetTodayDate', 'false'); // ✅ احفظ false بدلًا من حذف المفتاح
    const endDateInput = document.getElementById('endDate');
    if (endDateInput) endDateInput.value = '';
    showMessage("تم تعطيل التعيين التلقائي لتاريخ مقابل التأخير", 'success', 1000, true);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const savedDateSetting = localStorage.getItem('autoSetTodayDate');
  const dateCheckbox = document.getElementById('autoSetTodayDate');

  if (dateCheckbox) {
    dateCheckbox.checked = savedDateSetting === 'true';

    // مستمع التغيير
    dateCheckbox.addEventListener('change', handleTodayDateToggle);

    if (dateCheckbox.checked) {
      setTodayDateForEndDate();
    }
  }
});


      
// اعدادات الاختفاء الاساسية 
function resetAllDurations(suppressMessage = false) {
    const resetCheckbox = document.getElementById('resetAllDurations');
    const durationSelects = [
        document.getElementById('durationInfo'),
        document.getElementById('durationSuccess'),
        document.getElementById('durationWarning'),
        document.getElementById('durationError')
    ];

    if (resetCheckbox.checked) {
        // ضبط جميع المدد إلى 1 ثانية (الخيار الأول) وإقفالها
        durationSelects.forEach(select => {
            if (select) {
                select.selectedIndex = 0;
                select.disabled = true;
            }
        });
        
        // حفظ الحالة في التخزين المحلي
        localStorage.setItem('resetAllDurations', 'true');
        
        // عرض الرسالة فقط إذا لم يتم كتمها
        if (!suppressMessage) {
            showMessage('تم ضبط اعدادات إختفاء الرسائل بعد 1 ثانية تلقائي', 'success', 1000, true);
        }
    } else {
        // إعادة فتح جميع المدد
        durationSelects.forEach(select => {
            if (select) select.disabled = false;
        });
        
        // حذف الحالة من التخزين المحلي
        localStorage.removeItem('resetAllDurations');
        
        // عرض الرسالة فقط إذا لم يتم كتمها
        if (!suppressMessage) {
            showMessage('تم إلغاء الإختفاء الإفتراضي يمكنك ضبط كل رسالة علي حدة', 'info', 1000, true);
        }
    }
}

// تهيئة العنصر عند تحميل الصفحة (بدون عرض الرسالة)
function initializeResetCheckbox() {
    const resetCheckbox = document.getElementById('resetAllDurations');
    if (localStorage.getItem('resetAllDurations') === 'true') {
        resetCheckbox.checked = true;
        resetAllDurations(true); // نمرر true لكتم الرسالة
    }
}

// استدعاء الدالة عند تحميل الصفحة
window.addEventListener('DOMContentLoaded', initializeResetCheckbox);
      
// دالة عرض الرسائل المنبثقة المعدلة (من الجافا الأول)
function showMessage(message, type = 'info', duration = 1000, isSystemMessage = false) {
    // إذا كانت رسالة نظامية، لا تطبق عليها قواعد الإخفاء
    if (!isSystemMessage && (messageSettings.hideAll || !messageSettings.enabledTypes[type])) {
        return;
    }

    const popup = document.getElementById('messagePopup');
    const icon = document.getElementById('messageIcon');
    const content = document.getElementById('messageContent');
    const overlay = document.getElementById('popupOverlay');

    // تعيين المحتوى والنوع
    content.textContent = message;
    popup.className = `message-popup ${type}`;
    
    // تعيين الأيقونة المناسبة
    const icons = {
        'info': 'fas fa-info-circle',
        'success': 'fas fa-check-circle',
        'warning': 'fas fa-exclamation-triangle',
        'error': 'fas fa-times-circle'
    };
    icon.className = `message-icon ${icons[type] || icons['info']}`;

    // عرض الرسالة وطبقة التعتيم
    popup.classList.add('show');
    overlay.classList.add('show');

    // إخفاء تلقائي بعد المدة المحددة
    setTimeout(() => {
        popup.classList.remove('show');
        // إخفاء طبقة التعتيم فقط إذا لم تكن هناك نوافذ أخرى مفتوحة
        if (!document.querySelector('.popup.show') && 
            !document.querySelector('.settings-popup.show')) {
            overlay.classList.remove('show');
        }
    }, duration);
}

// دالة إخفاء الرسالة المنبثقة
function hideMessage() {
    const popup = document.getElementById('messagePopup');
    const overlay = document.getElementById('popupOverlay');
    
    if (popup) popup.classList.remove('show');
    if (overlay) overlay.classList.remove('show');
}

// كائن إعدادات الرسائل
const messageSettings = {
    hideAll: false,
    durations: {
        info: 1000,
        success: 1000,
        warning: 1000,
        error: 1000
    },
    enabledTypes: {
        info: true,
        success: true,
        warning: true,
        error: true
    }
};

// تحميل الإعدادات من localStorage
function loadMessageSettings() {
    const savedSettings = localStorage.getItem('messageSettings');
    if (savedSettings) {
        try {
            Object.assign(messageSettings, JSON.parse(savedSettings));
        } catch (e) {
            console.error('Error loading message settings:', e);
        }
    }
}

// حفظ الإعدادات في localStorage
function saveMessageSettings() {
    localStorage.setItem('messageSettings', JSON.stringify(messageSettings));
}

// اعدادات تلوين حقول احتساب الضريبة      
const taxFieldsIds = ['textbox8', 'textbox6', 'textbox4', 'textbox5'];
    
// عند تحميل الصفحة، تحميل التفضيلات من التخزين المحلي
document.addEventListener('DOMContentLoaded', function() {
    loadTaxHighlightSettings();
    loadMessageSettings();
});
    
// تبديل تمييز الحقول
function handleHighlightTaxFieldsToggle() {
    const checkbox = document.getElementById('highlightTaxFieldsEnabled');
    const colorPalette = document.getElementById('taxFieldsColorPalette');
    
    if (checkbox.checked) {
        colorPalette.style.display = 'flex';
        
        // تطبيق اللون المحفوظ إذا كان موجوداً
        const savedColor = localStorage.getItem('taxHighlightColor');
        if (savedColor) {
            applyHighlightColor(savedColor);
            selectColorOption(savedColor);
        } else {
            // لون افتراضي إذا لم يكن هناك لون محفوظ
            applyHighlightColor('#FFFF99');
            selectColorOption('#FFFF99');
        }
    } else {
        colorPalette.style.display = 'none';
        removeHighlightFromFields();
    }
    
    // حفظ الحالة في التخزين المحلي
    localStorage.setItem('taxHighlightEnabled', checkbox.checked);
}
    
// اختيار لون التمييز
function selectTaxHighlightColor(element) {
    const color = element.getAttribute('data-color');
    applyHighlightColor(color);
    selectColorOption(color);
    
    // حفظ اللون المختار في التخزين المحلي
    localStorage.setItem('taxHighlightColor', color);
}
    
// تطبيق لون التمييز على الحقول
function applyHighlightColor(color) {
    taxFieldsIds.forEach(id => {
        const field = document.getElementById(id);
        if (field) {
            field.style.setProperty('--tax-highlight-color', color);
            field.classList.add('highlighted');
        }
    });
}
    
// إزالة التمييز من الحقول
function removeHighlightFromFields() {
    taxFieldsIds.forEach(id => {
        const field = document.getElementById(id);
        if (field) {
            field.classList.remove('highlighted');
        }
    });
}
    
// تحديد خيار اللون في لوحة الألوان
function selectColorOption(color) {
    const colorOptions = document.querySelectorAll('.color-option');
    colorOptions.forEach(option => {
        if (option.getAttribute('data-color') === color) {
            option.classList.add('selected');
        } else {
            option.classList.remove('selected');
        }
    });
}
    
// تحميل إعدادات التمييز من التخزين المحلي
function loadTaxHighlightSettings() {
    const savedState = localStorage.getItem('taxHighlightEnabled');
    const checkbox = document.getElementById('highlightTaxFieldsEnabled');
    const colorPalette = document.getElementById('taxFieldsColorPalette');
    
    if (savedState !== null) {
        checkbox.checked = savedState === 'true';
        
        if (checkbox.checked) {
            colorPalette.style.display = 'flex';
            
            const savedColor = localStorage.getItem('taxHighlightColor');
            if (savedColor) {
                applyHighlightColor(savedColor);
                selectColorOption(savedColor);
            } else {
                applyHighlightColor('#FFFF99');
                selectColorOption('#FFFF99');
            }
        }
    } else {
        // الحالة الافتراضية عند عدم وجود إعدادات محفوظة
        checkbox.checked = true;
        colorPalette.style.display = 'flex';
        applyHighlightColor('#FFFF99');
        selectColorOption('#FFFF99');
    }
}

// دالة عرض الفيديو المنبثق       
function openVideoPopup() {
    const modal = document.getElementById('videoModal');
    const videoFrame = document.getElementById('youtubeVideo');
    
    // تعيين رابط فيديو يوتيوب
    videoFrame.src = "https://www.youtube.com/embed/t3ZBj9mNGWo?autoplay=1";
    
    modal.style.display = "flex";
    setTimeout(() => {
        modal.classList.add('active');
    }, 10);
    
    // منع التمرير عند فتح النافذة
    document.body.style.overflow = 'hidden';
    closeFloatingMenu();
}

function closeVideoPopup() {
    const modal = document.getElementById('videoModal');
    const videoFrame = document.getElementById('youtubeVideo');
    
    modal.classList.remove('active');
    setTimeout(() => {
        videoFrame.src = "";
        modal.style.display = "none";
    }, 300);
    
    // إعادة التمرير عند الإغلاق
    document.body.style.overflow = 'auto';
}

// إغلاق النافذة عند النقر خارجها
window.onclick = function(event) {
    const modal = document.getElementById('videoModal');
    if (event.target == modal) {
        closeVideoPopup();
    }
}

// إغلاق النافذة عند الضغط على زر ESC
document.onkeydown = function(evt) {
    evt = evt || window.event;
    if (evt.keyCode == 27) {
        closeVideoPopup();
    }
};  

// إعدادات الرسائل المنبثقة
function updateMessageSettings(type) {
    const checkbox = document.getElementById('enable' + capitalize(type));
    const isChecked = checkbox.checked;
    
    messageSettings.enabledTypes[type] = isChecked;
    
    updateHideAllCheckbox();
    
    saveMessageSettings();
    
    const typeInArabic = getTypeInArabic(type);
    const message = isChecked ? "تم تفعيل إخفاء رسائل " + typeInArabic : "تم إلغاء إخفاء رسائل " + typeInArabic;
    showMessage(message, isChecked ? 'info' : type, 1000, true);
}

function toggleAllMessages() {
    const isChecked = document.getElementById('popupEnabled').checked;
    
    // عرض الرسالة أولاً قبل تطبيق الإعدادات
    const message = isChecked ? "تم تفعيل إخفاء كافة أنواع الرسائل" : "تم إلغاء إخفاء كافة أنواع الرسائل";
    showMessage(message, isChecked ? 'info' : 'success', 1000, true);
    
    // تطبيق الإعدادات بعد عرض الرسالة
    messageSettings.hideAll = isChecked;
    
    if (isChecked) {
        messageSettings.enabledTypes.info = false;
        messageSettings.enabledTypes.success = false;
        messageSettings.enabledTypes.warning = false;
        messageSettings.enabledTypes.error = false;
    } else {
        messageSettings.enabledTypes.info = true;
        messageSettings.enabledTypes.success = true;
        messageSettings.enabledTypes.warning = true;
        messageSettings.enabledTypes.error = true;
    }
    
    saveMessageSettings();
}

function updateHideAllCheckbox() {
    const allDisabled = !messageSettings.enabledTypes.info && 
                      !messageSettings.enabledTypes.success && 
                      !messageSettings.enabledTypes.warning && 
                      !messageSettings.enabledTypes.error;
    
    document.getElementById('popupEnabled').checked = allDisabled;
    messageSettings.hideAll = allDisabled;
    
    if (allDisabled) {
        showMessage("تم تفعيل إخفاء كافة أنواع الرسائل تلقائياً", "info", 1000, true);
    }
}

function getTypeInArabic(type) {
    const types = {
        'info': 'المعلومات',
        'success': 'النجاح',
        'warning': 'التحذير',
        'error': 'الخطأ'
    };
    return types[type] || type;
}

function capitalize(txt) {
    return txt.charAt(0).toUpperCase() + txt.slice(1);
}

function openSettings() {
    document.getElementById("popupSettings").style.display = "block";
    
    setTimeout(function() {
        document.getElementById("popupOverlay").classList.add("show");
    }, 50);
}

function closeSettings() {
    document.getElementById("popupSettings").style.display = "none";
    document.getElementById("popupOverlay").classList.remove("show");
}

// تهيئة الرسائل عند تحميل الصفحة
initMessagePopup();

function initMessagePopup() {
    // إنشاء العناصر إذا لم تكن موجودة
    if (!document.getElementById('messagePopup')) {
        const popup = document.createElement('div');
        popup.id = 'messagePopup';
        popup.className = 'message-popup';
        popup.innerHTML = `
            <div class="message-icon" id="messageIcon"></div>
            <div class="message-content" id="messageContent"></div>
        `;
        document.body.appendChild(popup);
    }
    
    // تحميل الإعدادات المحفوظة
    loadMessageSettings();
}
</script>
                      
 
 <script>
let popupSettings = {
    hideAll: false,
    durations: {
        info: 1000,
        success: 1000,
        warning: 1000,
        error: 1000
    },
    hiddenTypes: {
        info: false,
        success: false,
        warning: false,
        error: false
    }
};

// تحميل الإعدادات عند بدء التشغيل
function loadSettings() {
    const savedSettings = localStorage.getItem('popupSettings');
    if (savedSettings) {
        try {
            const parsedSettings = JSON.parse(savedSettings);
            
            popupSettings = {
                hideAll: parsedSettings.hideAll !== undefined ? parsedSettings.hideAll : false,
                durations: {
                    info: parsedSettings.durations?.info || 1000,
                    success: parsedSettings.durations?.success || 1000,
                    warning: parsedSettings.durations?.warning || 1000,
                    error: parsedSettings.durations?.error || 1000
                },
                hiddenTypes: {
                    info: parsedSettings.hiddenTypes?.info || false,
                    success: parsedSettings.hiddenTypes?.success || false,
                    warning: parsedSettings.hiddenTypes?.warning || false,
                    error: parsedSettings.hiddenTypes?.error || false
                }
            };
            
            updateUIFromSettings();
            
        } catch (e) {
            console.error('Failed to parse saved settings', e);
            saveSettingsToLocalStorage();
        }
    } else {
        saveSettingsToLocalStorage();
    }
}

// تحديث واجهة المستخدم من الإعدادات
function updateUIFromSettings() {
    document.getElementById('durationInfo').value = popupSettings.durations.info;
    document.getElementById('durationSuccess').value = popupSettings.durations.success;
    document.getElementById('durationWarning').value = popupSettings.durations.warning;
    document.getElementById('durationError').value = popupSettings.durations.error;
    
    document.getElementById('enableInfo').checked = popupSettings.hiddenTypes.info;
    document.getElementById('enableSuccess').checked = popupSettings.hiddenTypes.success;
    document.getElementById('enableWarning').checked = popupSettings.hiddenTypes.warning;
    document.getElementById('enableError').checked = popupSettings.hiddenTypes.error;
    
    document.getElementById('popupEnabled').checked = popupSettings.hideAll;
}

// حفظ الإعدادات في التخزين المحلي
function saveSettingsToLocalStorage() {
    localStorage.setItem('popupSettings', JSON.stringify(popupSettings));
}

// دالة عرض الرسائل من الجافا الأول
function showMessage(message, type = 'info', duration = 1000, isSystemMessage = false) {
    // إذا كانت رسالة نظامية، لا تطبق عليها قواعد الإخفاء
    if (!isSystemMessage && (popupSettings.hideAll || popupSettings.hiddenTypes[type])) {
        return;
    }

    const popup = document.getElementById('messagePopup');
    const icon = document.getElementById('messageIcon');
    const content = document.getElementById('messageContent');
    const overlay = document.getElementById('popupOverlay');

    // تعيين المحتوى والنوع
    content.textContent = message;
    popup.className = `message-popup ${type}`;
    
    // تعيين الأيقونة المناسبة
    const icons = {
        'info': 'fas fa-info-circle',
        'success': 'fas fa-check-circle',
        'warning': 'fas fa-exclamation-triangle',
        'error': 'fas fa-times-circle'
    };
    icon.className = `message-icon ${icons[type] || icons['info']}`;

    // عرض الرسالة وطبقة التعتيم
    popup.classList.add('show');
    overlay.classList.add('show');

    // إخفاء تلقائي بعد المدة المحددة
    setTimeout(() => {
        popup.classList.remove('show');
        // إخفاء طبقة التعتيم فقط إذا لم تكن هناك نوافذ أخرى مفتوحة
        if (!document.querySelector('.popup.show') && 
            !document.querySelector('.settings-popup.show')) {
            overlay.classList.remove('show');
        }
    }, duration);
}

function openSettings() {
    document.getElementById('popupSettings').classList.add('show');
    document.getElementById('popupOverlay').classList.add('show');
    loadSettings();
}

function closeSettings() {
    document.getElementById('popupSettings').classList.remove('show');
    document.getElementById('popupOverlay').classList.remove('show');
}

function saveSettings() {
    popupSettings.durations.info = parseInt(document.getElementById('durationInfo').value) || 1000;
    popupSettings.durations.success = parseInt(document.getElementById('durationSuccess').value) || 1000;
    popupSettings.durations.warning = parseInt(document.getElementById('durationWarning').value) || 1000;
    popupSettings.durations.error = parseInt(document.getElementById('durationError').value) || 1000;
    
    popupSettings.hiddenTypes.info = document.getElementById('enableInfo').checked;
    popupSettings.hiddenTypes.success = document.getElementById('enableSuccess').checked;
    popupSettings.hiddenTypes.warning = document.getElementById('enableWarning').checked;
    popupSettings.hiddenTypes.error = document.getElementById('enableError').checked;
    
    popupSettings.hideAll = document.getElementById('popupEnabled').checked;

    saveSettingsToLocalStorage();
    showMessage("تم حفظ الإعدادات بنجاح", "success", 1000, true);
    
    setTimeout(closeSettings, 1000);
    closeFloatingMenu();
}

function updateSettings(type) {
    const checkbox = document.getElementById('enable' + capitalize(type));
    const isChecked = checkbox.checked;
    
    popupSettings.hiddenTypes[type] = isChecked;
    
    updateHideAllCheckbox();
    
    saveSettingsToLocalStorage();
    
    const typeInArabic = getTypeInArabic(type);
    const message = isChecked ? "تم تفعيل إخفاء رسائل " + typeInArabic : "تم إلغاء إخفاء رسائل " + typeInArabic;
    showMessage(message, isChecked ? 'info' : type, 1000, true);
}

function toggleAllMessages() {
    const isChecked = document.getElementById('popupEnabled').checked;
    
    // عرض الرسالة أولاً قبل تطبيق الإعدادات
    const message = isChecked ? "تم تفعيل إخفاء كافة أنواع الرسائل" : "تم إلغاء إخفاء كافة أنواع الرسائل";
    showMessage(message, isChecked ? 'info' : 'success', 1000, true);
    
    // تطبيق الإعدادات بعد عرض الرسالة
    popupSettings.hideAll = isChecked;
    
    if (isChecked) {
        popupSettings.hiddenTypes.info = true;
        popupSettings.hiddenTypes.success = true;
        popupSettings.hiddenTypes.warning = true;
        popupSettings.hiddenTypes.error = true;
    } else {
        popupSettings.hiddenTypes.info = false;
        popupSettings.hiddenTypes.success = false;
        popupSettings.hiddenTypes.warning = false;
        popupSettings.hiddenTypes.error = false;
    }
    
    updateUIFromSettings();
    saveSettingsToLocalStorage();
}

function updateHideAllCheckbox() {
    const allChecked = popupSettings.hiddenTypes.info && 
                      popupSettings.hiddenTypes.success && 
                      popupSettings.hiddenTypes.warning && 
                      popupSettings.hiddenTypes.error;
    
    document.getElementById('popupEnabled').checked = allChecked;
    popupSettings.hideAll = allChecked;
    
    if (allChecked) {
        showMessage("تم تفعيل إخفاء كافة أنواع الرسائل تلقائياً", "info", 1000, true);
    }
}

function getTypeInArabic(type) {
    const types = {
        'info': 'المعلومات',
        'success': 'النجاح',
        'warning': 'التحذير',
        'error': 'الخطأ'
    };
    return types[type] || type;
}

function capitalize(txt) {
    return txt.charAt(0).toUpperCase() + txt.slice(1);
}

// تحميل الإعدادات عند بدء التشغيل
window.addEventListener('DOMContentLoaded', loadSettings);

// إغلاق النافذة عند النقر خارجها
document.addEventListener('click', function(event) {
    const settingsPopup = document.getElementById('popupSettings');
    const overlay = document.getElementById('popupOverlay');
    
    // تحقق مما إذا كانت النافذة ظاهرة (بأي طريقة عرض)
    const isPopupVisible = settingsPopup.classList.contains('show') || 
                         settingsPopup.style.display === 'block';
    
    // تحقق من النقر خارج النافذة وخارج أي عناصر متعلقة بها
    if (isPopupVisible && 
        !event.target.closest('#popupSettings') && 
        !event.target.closest('[onclick*="openSettings"]') &&
        event.target !== settingsPopup) {
        
        closeSettings();
    }
});

// تهيئة الرسائل عند تحميل الصفحة
initMessagePopup();

function initMessagePopup() {
    // إنشاء العناصر إذا لم تكن موجودة
    if (!document.getElementById('messagePopup')) {
        const popup = document.createElement('div');
        popup.id = 'messagePopup';
        popup.className = 'message-popup';
        popup.innerHTML = `
            <div class="message-icon" id="messageIcon"></div>
            <div class="message-content" id="messageContent"></div>
        `;
        document.body.appendChild(popup);
    }
    
    // إنشاء طبقة التعتيم إذا لم تكن موجودة
    if (!document.getElementById('popupOverlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'popupOverlay';
        overlay.className = 'popup-overlay';
        document.body.appendChild(overlay);
    }
}

      
      
function openSettings() {
document.getElementById("popupSettings").style.display = "block";
  
  setTimeout(function() {
    document.getElementById("popupOverlay").classList.add("show");
  }, 50);
}

function closeSettings() {
  document.getElementById("popupSettings").style.display = "none";
  document.getElementById("popupOverlay").classList.remove("show");
}      
    </script>               
                      
    <script>
        // عناصر DOM
        const mainButton = document.getElementById('mainButton');
        const floatingMenu = document.getElementById('floatingMenu');
        const closeMenu = document.getElementById('closeMenu');
        const overlay = document.getElementById('overlay');

        // تبديل القائمة المنبثقة
        mainButton.addEventListener('click', function(e) {
            e.stopPropagation();
            this.classList.toggle('active');
            floatingMenu.classList.toggle('active');
            
            if (floatingMenu.classList.contains('active')) {
                // إظهار الخلفية المعتمة ومنع التمرير
                overlay.style.display = 'block';
                document.body.classList.add('body-no-scroll');
                document.addEventListener('click', closeMenuOutside);
            } else {
                // إخفاء الخلفية المعتمة وتمكين التمرير
                overlay.style.display = 'none';
                document.body.classList.remove('body-no-scroll');
                document.removeEventListener('click', closeMenuOutside);
            }
        });
        
        // إغلاق القائمة عند النقر على الزر المغلق
        closeMenu.addEventListener('click', function() {
            closeFloatingMenu();
        });
        
function closeMenuOutside(e) {
    const settingsPopup = document.getElementById('popupSettings');
    const videoModal = document.getElementById('videoModal');
    
    const isSettingsVisible = settingsPopup.classList.contains('show') || 
                            settingsPopup.style.display === 'block';
    
    const isVideoVisible = videoModal.style.display === 'block' || 
                         getComputedStyle(videoModal).display === 'block';

    // حالة خاصة: إذا كانت نافذة الفيديو ظاهرة، أغلق القائمة فوراً
    if (isVideoVisible) {
        closeFloatingMenu();
        return; // نخرج من الدالة فوراً بعد الإغلاق
    }
    
    // الحالة العامة: لا تغلق القائمة إذا كانت نافذة الإعدادات ظاهرة
    if (!isSettingsVisible && !floatingMenu.contains(e.target) && e.target !== mainButton) {
        closeFloatingMenu();
    }
}
        
        function closeFloatingMenu() {
            mainButton.classList.remove('active');
            floatingMenu.classList.remove('active');
            overlay.style.display = 'none';
            document.body.classList.remove('body-no-scroll');
            document.removeEventListener('click', closeMenuOutside);
        }


        // إزالة تأثير النبض بعد 5 ثواني
        setTimeout(() => {
            mainButton.classList.remove('pulse');
        }, 5000);

document.addEventListener("DOMContentLoaded", function () {
    showFloatingText(); // استدعاء الدالة عند تحميل الصفحة

    // تكرار إظهار النص العائم كل 30 ثانية
    setInterval(function() {
        showFloatingText();
    }, 30000);
});

// دالة لإظهار النص العائم
function showFloatingText() {
    var floatingText = document.getElementById("floatingText");
    floatingText.style.display = "block";

    // إخفاء النص العائم بعد 5 ثواني
    setTimeout(function() {
        floatingText.style.display = "none";
    }, 5000);
}    
 </script>                      
                         
                           

              
                      
<script>
  function checkBalanceTable() {
    const tableBody = document.querySelector("#balanceTable tbody");
    const checkbox = document.getElementById("discount200");
    
    if (tableBody && tableBody.rows.length > 0) {
      checkbox.disabled = false; // تفعيل الـ checkbox
    } else {
      checkbox.disabled = true; // تعطيل الـ checkbox
      checkbox.checked = false; // إعادة التحديد إلى غير محدد
    }
  }

  checkBalanceTable(); // يمكن استدعاؤها أيضا في نهاية تحميل الصفحة
</script>                      
                   
<script>
 function show1() {
  const select = document.getElementById("textbox12");
  const selectedValue = select.value.trim();
  const resultBox = document.getElementById("textbox9");   // حاصل الضرب
  const diffBox = document.getElementById("textbox10");    // الفرق
  const baseValueStr = document.getElementById("textbox4").value.trim();

  // في حال الخيار الافتراضي للقائمة
  if (selectedValue === "" || selectedValue === "-- اختر من القائمة نسبة التجاوز --") {
    resultBox.value = "";
    diffBox.value = "";
    document.getElementById("textbox6").value = "";
    document.getElementById("textbox8").value = "";

    // استدعاء الدوال المطلوبة
    calculateFinalTax();

    return;
  }

  // تحقق من صحة baseValue
  if (baseValueStr === "" || isNaN(baseValueStr)) {
    resultBox.value = "";
    diffBox.value = "";
    document.getElementById("textbox6").value = "";
    document.getElementById("textbox8").value = "";
    return;
  }

const baseValue = parseFloat(baseValueStr);
let multiplied, difference;

if (selectedValue === "المادة 45 مكرر") {
  const total = parseFloat(document.getElementById("totalbalance").innerText) || 0;
  const totalDelay = parseFloat(document.getElementById("totalDelayAmount").innerText) || 0;
  multiplied = totalDelay - total;
  multiplied = multiplied < 0 ? 0 : multiplied; // إذا كانت النتيجة سالبة يتم تعيينها إلى 0
} else if (selectedValue === "0%") {
  multiplied = 0;
} else if (selectedValue.endsWith('%')) {
  const percentage = parseFloat(selectedValue.replace('%', '')) / 100;
  multiplied = baseValue * percentage;
} else {
  resultBox.value = "";
  diffBox.value = "";
  document.getElementById("textbox6").value = "";
  document.getElementById("textbox8").value = "";
  return;
}

resultBox.value = multiplied.toFixed(0);

  if (resultBox.value !== "") {
    difference = baseValue - multiplied;
    diffBox.value = difference.toFixed(0);

    // حساب textbox6 = difference + textbox5
    const delay = difference || 0;
    const principal = parseFloat(document.getElementById("textbox5").value) || 0;
    const totalDue = delay + principal;
    document.getElementById("textbox6").value = totalDue.toFixed(0);

    // حساب textbox8 = textbox7 - textbox6
    const totalAmount = parseFloat(document.getElementById("textbox7").value) || 0;
    const remaining = totalDue - totalAmount;
    document.getElementById("textbox8").value = remaining.toFixed(0);
  } else {
    diffBox.value = "";
    document.getElementById("textbox6").value = "";
    document.getElementById("textbox8").value = "";
  }
}



function show2() {
  const legalEntity = document.getElementById("textbox11").value;

  // حذف كل صفوف tbody في جدول financialTable
  const financialTable = document.getElementById("financialTable");
  if (financialTable) {
    const tbody = financialTable.tBodies[0];
    if (tbody) {
      while (tbody.rows.length > 0) {
        tbody.deleteRow(0);
        checkBalanceTable();
      }
    }
  }

  // حذف كل صفوف tbody في جدول balanceTable
  const balanceTable = document.getElementById("balanceTable");
  if (balanceTable) {
    const tbody = balanceTable.tBodies[0];
    if (tbody) {
      while (tbody.rows.length > 0) {
        tbody.deleteRow(0);
      }
    }
  }

  // لم تعد هناك حاجة لإخفاء الصفوف لأنها تم حذفها

  // إعادة تعيين الحقول النصية
  document.getElementById('textbox5').value = '';
  document.getElementById('textbox4').value = '';
  document.getElementById('textbox9').value = '';
  document.getElementById('textbox10').value = '';
  document.getElementById('textbox6').value = '';
  document.getElementById('textbox7').value = '';
  document.getElementById('textbox8').value = '';
  document.getElementById('endDate').value = '';

  // إعادة تعيين قائمة نسبة التجاوز
  const selectElem = document.getElementById('textbox12');
  if (selectElem) selectElem.selectedIndex = 0;

  // إعادة تعيين الإجمالي في جدول financialTable
  const totalDelayAmount = document.getElementById("totalDelayAmount");
  if (totalDelayAmount) {
    totalDelayAmount.textContent = "0";
  }

  // إعادة تعيين الإجمالي في جدول balanceTable
  const totalBalance = document.getElementById("totalbalance");
  if (totalBalance) {
    totalBalance.textContent = "0";
  }
  
  // ✅ إعادة تفعيل زر "إضافة رصيد سابق" إذا كان معطلاً
  const addBtn = document.getElementById("addtaxBalanceBtn");
  if (addBtn.hasAttribute("disabled")) {
    addBtn.removeAttribute("disabled");
    addBtn.classList.remove("disabled");
  }
    const checkbox = document.getElementById("discount200");
      checkbox.disabled = true; // تعطيل الـ checkbox
      checkbox.checked = false; // إعادة التحديد إلى غير محدد
  
}
  
  
function showPopup(id) {
  const legalEntity = document.getElementById("endDate").value;

  // حذف كل صفوف tbody في جدول financialTable
  const financialTable = document.getElementById("financialTable");
  if (financialTable) {
    const tbody = financialTable.tBodies[0];
    if (tbody) {
      while (tbody.rows.length > 0) {
        tbody.deleteRow(0);
        checkBalanceTable();
      }
    }
  }

  // حذف كل صفوف tbody في جدول balanceTable
  const balanceTable = document.getElementById("balanceTable");
  if (balanceTable) {
    const tbody = balanceTable.tBodies[0];
    if (tbody) {
      while (tbody.rows.length > 0) {
        tbody.deleteRow(0);
      }
    }
  }

  // إعادة تعيين الحقول النصية
  document.getElementById('textbox5').value = '';
  document.getElementById('textbox4').value = '';
  document.getElementById('textbox9').value = '';
  document.getElementById('textbox10').value = '';
  document.getElementById('textbox6').value = '';
  document.getElementById('textbox7').value = '';
  document.getElementById('textbox8').value = '';

  // التعامل مع التاريخ حسب التفعيل
  const autoDateCheckbox = document.getElementById("autoSetTodayDate");
  const endDateField = document.getElementById('endDate');
  if (autoDateCheckbox && !autoDateCheckbox.checked) {
    // ❌ إذا لم يكن مفعلاً، يتم مسح التاريخ
    endDateField.value = '';
  }
  // ✅ أما إذا كان مفعلاً، لا يتم تغيير القيمة إطلاقًا

  // إعادة تعيين قائمة نسبة التجاوز
  const selectElem = document.getElementById('textbox12');
  if (selectElem) selectElem.selectedIndex = 0;

  // إعادة تعيين الإجمالي في جدول financialTable
  const totalDelayAmount = document.getElementById("totalDelayAmount");
  if (totalDelayAmount) {
    totalDelayAmount.textContent = "0";
  }

  // إعادة تعيين الإجمالي في جدول balanceTable
  const totalBalance = document.getElementById("totalbalance");
  if (totalBalance) {
    totalBalance.textContent = "0";
  }

  // إعادة تفعيل زر "إضافة رصيد سابق" إذا كان معطلاً
  const addBtn = document.getElementById("addtaxBalanceBtn");
  if (addBtn && addBtn.hasAttribute("disabled")) {
    addBtn.removeAttribute("disabled");
    addBtn.classList.remove("disabled");
  }

  // إعادة تعيين حالة checkbox الخصم
  const checkbox = document.getElementById("discount200");
  checkbox.disabled = true;
  checkbox.checked = false;

  // ❌ لا تركيز على أي زر أو حقل هنا (تم إلغاء التركيز تمامًا)
}

</script>
                   
<script>
// 🔹 العناصر الخاصة بنموذج الرصيد السابق
const balanceModal = document.getElementById("BalanceModal"); // النموذج المنبثق للرصيد
const addBalanceBtn = document.getElementById("addtaxBalanceBtn"); // زر الإضافة للرصيد
const closeBalanceModal = document.getElementById("closeBalanceModal"); // زر الإغلاق للرصيد
const saveBalanceBtn = document.getElementById("saveBalanceBtn"); // زر الحفظ للرصيد

// العناصر الخاصة بنموذج الفرق الضريبي
const modal = document.getElementById("taxDifferenceModal"); // النموذج المنبثق للفرق الضريبي
const addTaxDifferenceBtn = document.getElementById("addTaxDifferenceBtn"); // زر إضافة الفرق الضريبي
const closeModal = document.getElementsByClassName("close")[0]; // زر إغلاق نموذج الفرق الضريبي
const saveTaxDifferenceBtn = document.getElementById("saveTaxDifferenceBtn"); // زر حفظ الفرق الضريبي
const financialTableBody = document.querySelector("#financialTable tbody"); // جسم جدول البيانات المالية
const totalDelayAmountCell = document.getElementById("totalDelayAmount"); // خلية إجمالي المبالغ المتأخرة

// العناصر الخاصة بنموذج السداد
const paymentModal = document.getElementById("paymentModal"); // النموذج المنبثق للسداد
const addPaymentBtn = document.getElementById("addPaymentBtn"); // زر إضافة سداد جديد
const closePaymentModal = document.getElementsByClassName("close")[1]; // زر إغلاق نموذج السداد
const savePaymentBtn = document.getElementById("savePaymentBtn"); // زر حفظ السداد الجديد

let lastBalance = 0; // متغير لتخزين الرصيد السابق

// ✅ دالة التحقق من اختيار الكيان القانوني
function validateLegalEntity() {
  const textbox11 = document.getElementById("textbox11");
  if (!textbox11 || textbox11.value === "-- اختر من القائمة الكيان القانوني --") {
    showMessage("يرجي إختيار الكيان القانوني.", 'error');
    if (textbox11) textbox11.focus();
    return false;
  }
  return true;
}

// ✅ دالة التحقق من إدخال تاريخ حساب مقابل التأخير
function validateEndDate() {
  const endDateInput = document.getElementById("endDate");
  if (!endDateInput || endDateInput.value === "") {
    showMessage("يرجي إدخال تاريخ حساب مقابل التأخير.", 'error');
    if (endDateInput) endDateInput.focus();
    return false;
  }
  return true;
}

// عرض نموذج الرصيد عند الضغط على زر الإضافة بعد التحقق من الكيان القانوني وتاريخ التأخير
addBalanceBtn.onclick = function () {
  if (validateLegalEntity() && validateEndDate()) {
    balanceModal.style.display = "block";
  }
};

// عرض نموذج الفرق الضريبي عند الضغط على زر الإضافة بعد التحقق من الكيان القانوني وتاريخ التأخير
addTaxDifferenceBtn.onclick = function() {
  if (validateLegalEntity() && validateEndDate()) {
    modal.style.display = "block";
  }
};

// عرض نموذج السداد عند الضغط على زر الإضافة بعد التحقق من الكيان القانوني وتاريخ التأخير
addPaymentBtn.onclick = function() {
  if (validateLegalEntity() && validateEndDate()) {
    paymentModal.style.display = "block";
  }
};

// زر إغلاق نموذج الرصيد
document.getElementById("closeBalanceModal").onclick = function () {
  document.getElementById("BalanceModal").style.display = "none";
};

// زر إغلاق نموذج الفرق الضريبي
document.getElementById("closeTaxDifferenceModal").onclick = function () {
  document.getElementById("taxDifferenceModal").style.display = "none";
};

// زر إغلاق نموذج السداد
document.getElementById("closePaymentModal").onclick = function () {
  document.getElementById("paymentModal").style.display = "none";
};



// العناصر الرئيسية
const modals = {
  balance: {
    modal: document.getElementById("BalanceModal"),
    openBtn: document.getElementById("addtaxBalanceBtn"),
    closeBtn: document.getElementById("closeBalanceModal")
  },
  tax: {
    modal: document.getElementById("taxDifferenceModal"),
    openBtn: document.getElementById("addTaxDifferenceBtn"),
    closeBtn: document.getElementsByClassName("close")[0]
  },
  payment: {
    modal: document.getElementById("paymentModal"),
    openBtn: document.getElementById("addPaymentBtn"),
    closeBtn: document.getElementsByClassName("close")[1]
  }
};

// العناصر العائمة
const floatingElements = {
  menu: document.getElementById("floatingMenu"),
  button: document.getElementById("mainButton"),
  text: document.getElementById("floatingText")
};

// دالة التحقق من صحة المدخلات
function validateInputs() {
  const textbox11 = document.getElementById("textbox11");
  const endDateInput = document.getElementById("endDate");
  
  if (!textbox11 || textbox11.value === "-- اختر من القائمة الكيان القانوني --") {
    showMessage("يرجي إختيار الكيان القانوني.", 'error');
    textbox11?.focus();
    return false;
  }
  
  if (!endDateInput || endDateInput.value === "") {
    showMessage("يرجي إدخال تاريخ حساب مقابل التأخير.", 'error');
    endDateInput?.focus();
    return false;
  }
  
  return true;
}

// دالة التحقق من وجود نوافذ مفتوحة
function checkOpenModals() {
  return Object.values(modals).some(m => 
    m.modal && m.modal.style.display === "block"
  );
}

// دالة إدارة حالة التمرير والعناصر العائمة
function manageUIState() {
  const shouldHide = checkOpenModals();
  
  document.body.style.overflow = shouldHide ? "hidden" : "auto";
  
  Object.values(floatingElements).forEach(el => {
    if (el) {
      // لا تخفي النص العائم إذا كان مؤقت الإخفاء لم ينته بعد
      if (el.id === "floatingText" && !shouldHide && !el.dataset.autoHideCompleted) {
        return;
      }
      el.style.display = shouldHide ? "none" : "";
    }
  });
}

// دالة لإخفاء النص العائم بعد 5 ثوان
function autoHideFloatingText() {
  const floatingText = floatingElements.text;
  if (!floatingText) return;
  
  // تأكد من ظهور النص العائم أولاً
  floatingText.style.display = "block";
  
  // إخفاء النص بعد 5 ثوان
  setTimeout(() => {
    if (!checkOpenModals()) { // فقط إذا لم تكن هناك نوافذ مفتوحة
      floatingText.style.display = "none";
      floatingText.dataset.autoHideCompleted = "true";
    }
  }, 5000);
}

// مراقبة تغييرات النوافذ باستخدام MutationObserver
function setupModalObservers() {
  Object.values(modals).forEach(({modal}) => {
    if (!modal) return;
    
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(mutation => {
        if (mutation.attributeName === 'style') {
          manageUIState();
        }
      });
    });
    
    observer.observe(modal, {
      attributes: true,
      attributeFilter: ['style']
    });
  });
}

// إعداد أحداث النوافذ
function setupModalEvents() {
  Object.values(modals).forEach(({modal, openBtn, closeBtn}) => {
    // فتح النافذة
    if (openBtn) {
      openBtn.addEventListener("click", () => {
        if (validateInputs()) {
          modal.style.display = "block";
          manageUIState();
        }
      });
    }
    
    // إغلاق النافذة
    if (closeBtn) {
      closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
        manageUIState();
      });
    }
  });
}

// تهيئة المراقبة والأحداث
document.addEventListener("DOMContentLoaded", () => {
  setupModalObservers();
  setupModalEvents();
  autoHideFloatingText(); // تشغيل إخفاء النص العائم بعد التحميل
  manageUIState(); // التأكد من الحالة الأولية
});

// إغلاق النوافذ عند النقر خارجها
window.addEventListener("click", (event) => {
  Object.values(modals).forEach(({modal}) => {
    if (event.target === modal) {
      modal.style.display = "none";
      manageUIState();
    }
  });
});
</script>      
      
<script>  
// حساب سنة وتاريخ استحقاق الرصيد   
document.getElementById("year0").addEventListener("change", function () {
    const selectedYear = parseInt(this.value);
    const linkYearInput = document.getElementById("linkYear");
    const dueDateInput = document.getElementById("dueDate");
    const taxpayerType = document.getElementById("textbox11").value;

    if (!isNaN(selectedYear)) {
        const linkYear = selectedYear + 1;
        linkYearInput.value = linkYear;

        let day, month;

        // تحديد يوم وشهر الاستحقاق حسب نوع الممول
        if (taxpayerType === "شركات | أشخاص إعتبارية") {
            day = 30;
            month = 3; // أبريل = 3 لأن JavaScript يبدأ من 0
        } else {
            day = 31;
            month = 2; // مارس = 2
        }

        // التحقق من صلاحية اليوم (مثلاً: فبراير قد لا يحتوي 31)
        const date = new Date(linkYear, month, day);
        if (date.getDate() !== day) {
            day = new Date(linkYear, month + 1, 0).getDate(); // آخر يوم في الشهر
        }

        // تنسيق التاريخ النهائي بالشكل dd/mm/yyyy
        const formattedDate = `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${linkYear}`;
        dueDateInput.value = formattedDate;

        document.getElementById("taxBalance").focus();
    } else {
        linkYearInput.value = "";
        dueDateInput.value = "";
    }
});

// عند فقدان التركيز من حقل dueDate → إعادة تنسيق التاريخ
document.getElementById("dueDate").addEventListener("blur", function () {
    const input = this.value;
    const parsedDate = parseDateFlexible(input);
    if (parsedDate) {
        // ✅ التنسيق: dd/mm/yyyy
        const formatted = `${String(parsedDate.getDate()).padStart(2, '0')}/${String(parsedDate.getMonth() + 1).padStart(2, '0')}/${parsedDate.getFullYear()}`;
        this.value = formatted;
    }
});

// دالة تحليل تواريخ مرنة مثل: 15-10-2020 أو 2020/10/15
function parseDateFlexible(input) {
    const parts = input.match(/\d+/g);
    if (!parts || parts.length < 3) return null;

    let day, month, year;

    if (parts[0].length === 4) {
        // الحالة: yyyy/mm/dd أو yyyy-mm-dd
        year = parseInt(parts[0]);
        month = parseInt(parts[1]) - 1;
        day = parseInt(parts[2]);
    } else if (parts[2].length === 4) {
        // الحالة: dd/mm/yyyy أو dd-mm-yyyy
        day = parseInt(parts[0]);
        month = parseInt(parts[1]) - 1;
        year = parseInt(parts[2]);
    } else {
        return null; // غير قادر على تحديد التاريخ
    }

    const date = new Date(year, month, day);
    return isNaN(date.getTime()) ? null : date;
}



// ✅ التحقق من صحة التاريخ عند فقدان التركيز على حقل dueDate
document.getElementById("dueDate").addEventListener("blur", function () {
    const input = this.value.trim();
    const parts = input.split("/");

    if (parts.length === 3) {
        let day = parseInt(parts[0], 10);
        let month = parseInt(parts[1], 10);
        let year = parseInt(parts[2], 10);

        if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
            // التحقق من آخر يوم صالح في هذا الشهر
            const lastDay = new Date(year, month, 0).getDate();

            if (day > lastDay) {
                day = lastDay; // تصحيح اليوم
            }

            // إعادة تنسيق التاريخ بعد التصحيح
            this.value = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
        }
    }
});

 
  
// حساب سنة وتاريخ استحقاق الربط   
// عند تغيير سنة الإقرار في الحقل "year"
document.getElementById("year").addEventListener("change", function () {
    const selectedYear = parseInt(this.value);
    const linkYearInput = document.getElementById("linkYear1");
    const dueDateInput = document.getElementById("dueDate1");
    const taxpayerType = document.getElementById("textbox11").value;

    if (!isNaN(selectedYear)) {
        const linkYear = selectedYear + 1;
        linkYearInput.value = linkYear;

        let day, month;

        if (taxpayerType === "شركات | أشخاص إعتبارية") {
            day = 30;
            month = 3; // أبريل = 3 لأن JavaScript يبدأ من 0
        } else {
            day = 31;
            month = 2; // مارس = 2
        }

        // التحقق من صلاحية اليوم (مثلاً: فبراير قد لا يحتوي 31)
        const date = new Date(linkYear, month, day);
        if (date.getDate() !== day) {
            day = new Date(linkYear, month + 1, 0).getDate(); // آخر يوم في الشهر
        }

        // تنسيق التاريخ النهائي dd/mm/yyyy
        const formattedDate = `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${linkYear}`;
        dueDateInput.value = formattedDate;

        document.getElementById("taxAmount").focus();
    } else {
        linkYearInput.value = "";
        dueDateInput.value = "";
    }
});

// ✅ إعادة تنسيق أي تاريخ يتم إدخاله يدويًا في dueDate1
document.getElementById("dueDate1").addEventListener("blur", function () {
    const input = this.value;
    const parsedDate = parseDateFlexible(input);
    if (parsedDate) {
        const formatted = `${String(parsedDate.getDate()).padStart(2, '0')}/${String(parsedDate.getMonth() + 1).padStart(2, '0')}/${parsedDate.getFullYear()}`;
        this.value = formatted;
    }
});

// ✅ دالة عامة لتحليل أي صيغة تاريخ (yyyy-mm-dd أو dd/mm/yyyy وغيرها)
function parseDateFlexible(input) {
    const parts = input.match(/\d+/g);
    if (!parts || parts.length < 3) return null;

    let day, month, year;

    if (parts[0].length === 4) {
        // yyyy/mm/dd
        year = parseInt(parts[0]);
        month = parseInt(parts[1]) - 1;
        day = parseInt(parts[2]);
    } else if (parts[2].length === 4) {
        // dd/mm/yyyy
        day = parseInt(parts[0]);
        month = parseInt(parts[1]) - 1;
        year = parseInt(parts[2]);
    } else {
        return null; // تاريخ غير معروف
    }

    const date = new Date(year, month, day);
    return isNaN(date.getTime()) ? null : date;
}


// ✅ التحقق من صحة التاريخ عند فقدان التركيز على حقل dueDate1
document.getElementById("dueDate1").addEventListener("blur", function () {
    const input = this.value.trim();
    const parts = input.split("/");

    if (parts.length === 3) {
        let day = parseInt(parts[0], 10);
        let month = parseInt(parts[1], 10);
        let year = parseInt(parts[2], 10);

        if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
            // الحصول على آخر يوم في الشهر المحدد
            const lastDay = new Date(year, month, 0).getDate();

            if (day > lastDay) {
                day = lastDay; // تصحيح اليوم إذا تجاوز الحد
            }

            // إعادة تنسيق التاريخ بشكل صحيح
            this.value = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
        }
    }
});



  
// حساب سنة وتاريخ استحقاق السداد   
document.getElementById("year1").addEventListener("change", function () {
    const selectedYear = parseInt(this.value);
    const linkYearInput = document.getElementById("linkYear2");
    const dueDateInput = document.getElementById("dueDate2");
    const taxpayerType = document.getElementById("textbox11").value;

    if (!isNaN(selectedYear)) {
        const linkYear = selectedYear + 1;
        linkYearInput.value = linkYear;

        let day, month;

        if (taxpayerType === "شركات | أشخاص إعتبارية") {
            day = 30;
            month = 3; // أبريل = 3 لأن JavaScript يبدأ من 0
        } else {
            day = 31;
            month = 2; // مارس = 2
        }

        // التحقق من صلاحية اليوم
        const date = new Date(linkYear, month, day);
        if (date.getDate() !== day) {
            day = new Date(linkYear, month + 1, 0).getDate(); // آخر يوم في الشهر
        }

        const formattedDate = `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${linkYear}`;
        dueDateInput.value = formattedDate;

        document.getElementById("paymentAmount").focus();
    } else {
        linkYearInput.value = "";
        dueDateInput.value = "";
    }
});

// ✅ إعادة تنسيق التاريخ عند فقدان التركيز من dueDate2
document.getElementById("dueDate2").addEventListener("blur", function () {
    const input = this.value;
    const parsedDate = parseDateFlexible(input);
    if (parsedDate) {
        const formatted = `${String(parsedDate.getDate()).padStart(2, '0')}/${String(parsedDate.getMonth() + 1).padStart(2, '0')}/${parsedDate.getFullYear()}`;
        this.value = formatted;
    }
});

// ✅ دالة عامة لتحليل تواريخ مرنة من صيغ متعددة
function parseDateFlexible(input) {
    const parts = input.match(/\d+/g);
    if (!parts || parts.length < 3) return null;

    let day, month, year;

    if (parts[0].length === 4) {
        // الحالة: yyyy/mm/dd
        year = parseInt(parts[0]);
        month = parseInt(parts[1]) - 1;
        day = parseInt(parts[2]);
    } else if (parts[2].length === 4) {
        // الحالة: dd/mm/yyyy
        day = parseInt(parts[0]);
        month = parseInt(parts[1]) - 1;
        year = parseInt(parts[2]);
    } else {
        return null; // غير صالح
    }

    // التأكد من صحة اليوم في الشهر
    const lastDay = new Date(year, month + 1, 0).getDate();
    if (day > lastDay) day = lastDay;

    const date = new Date(year, month, day);
    return isNaN(date.getTime()) ? null : date;
}



// حساب الاجمالي في الجدول 
function updateTotalBalance() {
  let total = 0;
  const rows = balanceTableBody.querySelectorAll("tr");

  rows.forEach(row => {
    const amount = parseFloat(row.cells[4].innerText.replace(/,/g, ''));
    const type = row.getAttribute("data-type");

    if (!isNaN(amount)) {
      if (type === "رصيد" || type === "ربط") {
        total += amount;
      } else if (type === "سداد") {
        total -= amount;
      }
    }
  });

  document.getElementById("totalbalance").innerText = total.toFixed(0);
}

  
  
// اضافة البيانات الي الجدول   
let balanceTableBody = document.querySelector("#balanceTable tbody"); // جسم الجدول الموحد
let balanceRowCount = 1;
let editingRow = null; // لمعرفة الصف الجاري تعديله

// دالة لإضافة صف إلى الجدول الموحد مع الفرز والتمييز اللوني
function addRowToTable(typeText, yearValue, linkYear, dueDate, amount, source) {
  const newRow = document.createElement("tr");
  newRow.setAttribute("data-year", yearValue); // لتسهيل الفرز
  newRow.setAttribute("data-type", source);    // لتحديد اللون لاحقًا

  // تلوين الصف حسب النوع
  if (source === "رصيد") {
    newRow.style.backgroundColor = "#DAF7A6"; // أخضر مائي فاتح
  } else if (source === "ربط") {
    newRow.style.backgroundColor = "#d2b4de"; // أصفر كريمي فاتح
  } else if (source === "سداد") {
    newRow.style.backgroundColor = "#abebc6"; // وردي فاتح
  }

  newRow.innerHTML = `
    <td></td>
    <td>${typeText} ${yearValue}</td>
    <td>${linkYear}</td>
    <td>${dueDate}</td>
    <td>${amount}</td>
    <td><button class="editBtn">تعديل</button></td>
    <td><button class="deleteBtn">حذف</button></td>
  `;

// دالة محسنة لعرض نافذة تأكيد منبثقة
function showConfirmDialog(message) {
  return new Promise((resolve) => {
    // العناصر العائمة (يجب تعريفها خارج الدالة إذا كانت موجودة بالفعل)
    const floatingElements = {
      menu: document.getElementById("floatingMenu"),
      button: document.getElementById("mainButton"),
      text: document.getElementById("floatingText")
    };
    
    // تعطيل التمرير وإخفاء العناصر العائمة
    document.body.style.overflow = "hidden";
    Object.values(floatingElements).forEach(el => {
      if (el) el.style.display = "none";
    });
    
    // إنشاء العناصر الأساسية
    const dialog = document.createElement('div');
    dialog.className = 'custom-confirm-dialog';
    dialog.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      text-align: center;
      max-width: 75%;
      width: 300px;
      border-top: 5px solid #ff6b6b;
      animation: fadeIn 0.2s ease-out;
    `;
    
    // رسالة النافذة
    const messageEl = document.createElement('p');
    messageEl.textContent = message;
    messageEl.style.cssText = `
      margin: 0 0 7.5px 0;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      line-height: 1.2;
    `;
    
    // أيقونة استفهام
    const icon = document.createElement('i');
    icon.className = 'fas fa-question-circle';
    icon.style.cssText = `
      font-size: 32px;
      color: #ff6b6b;
      margin-bottom: 10px;
      display: block;
    `;
    
    // حاوية الأزرار
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = `
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 2.5px;
    `;
    
    // زر التأكيد (نعم)
    const confirmBtn = document.createElement('button');
    confirmBtn.innerHTML = '<i class="fas fa-check"></i> نعم';
    confirmBtn.style.cssText = `
      padding: 10px 17.5px;
      background: linear-gradient(to right, #4285f4, #5b9bf8);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 70px;
      font-size: 18px;
      font-weight: bold;      
    `;
    
    // زر الإلغاء (لا)
    const cancelBtn = document.createElement('button');
    cancelBtn.innerHTML = '<i class="fas fa-times"></i> لا';
    cancelBtn.style.cssText = `
      padding: 10px 17.5px;
      background: linear-gradient(to right, #f44336, #ff6659);;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 70px;
      font-size: 18px;
      font-weight: bold;
    `;
    
    // تأثيرات hover للأزرار
    confirmBtn.onmouseenter = () => confirmBtn.style.transform = 'scale(1.02)';
    confirmBtn.onmouseleave = () => confirmBtn.style.transform = 'scale(1)';
    cancelBtn.onmouseenter = () => cancelBtn.style.transform = 'scale(1.02)';
    cancelBtn.onmouseleave = () => cancelBtn.style.transform = 'scale(1)';
    
    // إضافة العناصر إلى DOM
    dialog.appendChild(icon);
    dialog.appendChild(messageEl);
    btnContainer.appendChild(confirmBtn);
    btnContainer.appendChild(cancelBtn);
    dialog.appendChild(btnContainer);
    document.body.appendChild(dialog);
    
    // طبقة overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
      z-index: 999;
      backdrop-filter: blur(1px);
      animation: fadeIn 0.2s ease-out;
    `;
    document.body.appendChild(overlay);
    
    // دالة استعادة حالة الواجهة
    const restoreUIState = () => {
      document.body.style.overflow = "auto";
      Object.values(floatingElements).forEach(el => {
        if (el && el.id !== "floatingText") {
          el.style.display = "";
        }
        // لا نستعيد النص العائم إذا كان مؤقت الإخفاء لم ينته بعد
        if (el && el.id === "floatingText" && !el.dataset.autoHideCompleted) {
          return;
        }
      });
    };
    
    // معالجة الأحداث
    const handleClose = (result) => {
      dialog.style.animation = 'fadeOut 0.2s ease-out';
      overlay.style.animation = 'fadeOut 0.2s ease-out';
      setTimeout(() => {
        document.body.removeChild(dialog);
        document.body.removeChild(overlay);
        restoreUIState();
      }, 200);
      resolve(result);
    };
    
    confirmBtn.onclick = () => handleClose(true);
    cancelBtn.onclick = () => handleClose(false);
    
    // إضافة أنيميشن إذا لم يكن موجوداً
    if (!document.getElementById('dialog-animations')) {
      const style = document.createElement('style');
      style.id = 'dialog-animations';
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; transform: translate(-50%, -48%); }
          to { opacity: 1; transform: translate(-50%, -50%); }
        }
        @keyframes fadeOut {
          from { opacity: 1; transform: translate(-50%, -50%); }
          to { opacity: 0; transform: translate(-50%, -48%); }
        }
      `;
      document.head.appendChild(style);
    }
  });
}  
  
// حدث حذف الصف
newRow.querySelector(".deleteBtn").onclick = async function () {
  const description = newRow.cells[1].textContent.trim(); // البيان
  const amount = newRow.cells[4].textContent.trim();      // المبلغ
  const addBtn = document.getElementById("addtaxBalanceBtn");

  const confirmDelete = await showConfirmDialog(`هل ترغب في حذف البيان المدخل :  ${description}  بمبلغ ${amount} جنية \u061F`);
  
  if (confirmDelete) {
    // ✅ المستخدم وافق على الحذف
    showMessage(`تم حذف البيان المدخل : ${description}  بمبلغ ${amount} جنية`, 'success');
    
    // احذف الصف
    newRow.remove();
    sortAndUpdateTable();
    clearAllFields();
    updateTotalBalance();
    checkBalanceTable();
    applyDiscountIfNoYearlyBalance();
    
    // تحقق بعد الحذف: هل يوجد صف "رصيد حتى سنة"؟
    const balanceTable = document.getElementById("balanceTable");
    const rows = balanceTable.querySelectorAll("tbody tr");

    let hasBalanceRow = false;
    rows.forEach(row => {
      const desc = row.cells[1].textContent.trim();
      if (desc.startsWith("رصيد حتى سنة")) {
        hasBalanceRow = true;
      }
    });

    if (!hasBalanceRow) {
      // ✅ لا يوجد صف "رصيد" → فعّل الزر
      addBtn.removeAttribute("disabled");
      addBtn.classList.remove("disabled");
    } else {
      // ✅ يوجد صف رصيد → عطّل الزر
      addBtn.setAttribute("disabled", true);
      addBtn.classList.add("disabled");
    }
  } else {
    // ❌ المستخدم رفض الحذف
    let caption = "تم إلغاء عملية الحذف.";
    showMessage(caption, 'error');
  }
};



// حدث تعديل الصف
newRow.querySelector(".editBtn").onclick = async function () {
  editingRow = newRow;
  const year = newRow.getAttribute("data-year");
  const type = newRow.getAttribute("data-type");
  const description = newRow.cells[1].textContent.trim();
  const currentAmount = newRow.cells[4].textContent.trim(); // تغيير الاسم من oldAmount إلى currentAmount

  // إظهار نافذة تأكيد التعديل مع القيمة الحالية
  const confirmEdit = await showConfirmDialog(`هل ترغب في تعديل البيان المدخل: ${description} بمبلغ ${currentAmount} جنية \u061F`);
  
  if (!confirmEdit) {
    showMessage("تم إلغاء عملية التعديل", 'info');
    return;
  }

  // دالة للتحقق من التعديل بعد الإدخال
  const setupModificationCheck = (modal, amountFieldId, row) => {
    const originalAmount = row.cells[4].textContent.trim();
    
    const checkModification = () => {
      const newAmount = document.getElementById(amountFieldId).value.trim();
      
      if (newAmount !== originalAmount) {
        showMessage(`تم تعديل المبلغ من ${currentAmount} إلى ${newAmount} جنيه`, 'success');
        // تحديث القيمة في الخلية مباشرة بعد التعديل
        row.cells[4].textContent = newAmount;
      }
    };

    // إضافة مستمع لحدث الإرسال
    modal.addEventListener('submit', checkModification);
    
    // إزالة المستمع عند إغلاق النافذة
    const closeButtons = modal.querySelectorAll('[data-dismiss="modal"], .close');
    closeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        modal.removeEventListener('submit', checkModification);
      });
    });
  };

  if (type === "رصيد") {
    // تعبئة البيانات بالقيمة الحالية
    document.getElementById("year0").value = year;
    document.getElementById("linkYear").value = newRow.cells[2].textContent.trim();
    document.getElementById("dueDate").value = newRow.cells[3].textContent.trim();
    document.getElementById("taxBalance").value = currentAmount; // استخدام القيمة الحالية
    
    // إعداد التحقق من التعديل
    setupModificationCheck(balanceModal, 'taxBalance', newRow);
    
    // إظهار النافذة
    balanceModal.style.display = "block";
    balanceModal.style.animation = "fadeIn 0.3s ease-out";
    setTimeout(() => document.getElementById("linkYear").focus(), 100);
    
  } else if (type === "ربط") {
    // تعبئة البيانات بالقيمة الحالية
    document.getElementById("year").value = year;
    document.getElementById("linkYear1").value = newRow.cells[2].textContent.trim();
    document.getElementById("dueDate1").value = newRow.cells[3].textContent.trim();
    document.getElementById("taxAmount").value = currentAmount; // استخدام القيمة الحالية
    
    // إعداد التحقق من التعديل
    const taxDiffModal = document.getElementById("taxDifferenceModal");
    setupModificationCheck(taxDiffModal, 'taxAmount', newRow);
    
    // إظهار النافذة
    taxDiffModal.style.display = "block";
    taxDiffModal.style.animation = "fadeIn 0.3s ease-out";
    setTimeout(() => document.getElementById("linkYear1").focus(), 100);
    
  } else {
    // تعبئة البيانات بالقيمة الحالية
    document.getElementById("year1").value = year;
    document.getElementById("linkYear2").value = newRow.cells[2].textContent.trim();
    document.getElementById("dueDate2").value = newRow.cells[3].textContent.trim();
    document.getElementById("paymentAmount").value = currentAmount; // استخدام القيمة الحالية
    
    // إعداد التحقق من التعديل
    const paymentModal = document.getElementById("paymentModal");
    setupModificationCheck(paymentModal, 'paymentAmount', newRow);
    
    // إظهار النافذة
    paymentModal.style.display = "block";
    paymentModal.style.animation = "fadeIn 0.3s ease-out";
    setTimeout(() => document.getElementById("linkYear2").focus(), 100);
  }
  
  // إضافة تأثيرات للواجهة إذا لم تكن موجودة
  if (!document.getElementById('modal-animations')) {
    const style = document.createElement('style');
    style.id = 'modal-animations';
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }
    `;
    document.head.appendChild(style);
  }
};
  
  balanceTableBody.appendChild(newRow);
  sortAndUpdateTable(); // فرز وتحديث أرقام الصفوف بعد الإضافة
    const checkbox = document.getElementById("discount200");
      checkbox.disabled = true; // تعطيل الـ checkbox
      checkbox.checked = false; // إعادة التحديد إلى غير محدد

}

// دالة فرز الصفوف حسب السنة وتصحيح أرقام الصفوف
// دالة تحويل النص إلى تاريخ
function parseDate(dateStr) {
  const parts = dateStr.split("/");
  if (parts.length === 3) {
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1;
    const year = parseInt(parts[2], 10);
    return new Date(year, month, day);
  }
  return null;
}

// دالة تحويل التاريخ إلى نص بصيغة dd/mm/yyyy
function formatDate(date) {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

// دالة فرز الجدول حسب التاريخ ثم حسب نوع البيان
function sortAndUpdateTable() {
  const balanceTableBody = document.querySelector("#balanceTable tbody");
  const rows = Array.from(balanceTableBody.querySelectorAll("tr"));

  const typeOrder = {
    "رصيد": 1,
    "سداد": 2,
    "ربط": 3
  };

  rows.sort((a, b) => {
    const dateA = parseDate(a.cells[3].innerText.trim());
    const dateB = parseDate(b.cells[3].innerText.trim());

    if (dateA && dateB) {
      if (dateA.getTime() !== dateB.getTime()) {
        return dateA - dateB;
      }
    } else if (dateA && !dateB) {
      return -1;
    } else if (!dateA && dateB) {
      return 1;
    }

    const typeA = a.cells[1].innerText.trim();
    const typeB = b.cells[1].innerText.trim();
    return (typeOrder[typeA] || 99) - (typeOrder[typeB] || 99);
  });

  rows.forEach((row, index) => {
    balanceTableBody.appendChild(row);
    row.cells[0].innerText = index + 1;
  });

  balanceRowCount = rows.length + 1;

  updateTotalBalance(); // تحديث الإجمالي
  clearAllFields();     // مسح الحقول
  updateTotalBalance(); // تأكيد التحديث بعد الفرز
}



// حفظ بيانات الرصيد
saveBalanceBtn.onclick = function () {
  const year = document.getElementById("year0");
  const linkYear = document.getElementById("linkYear").value;
  const dueDate = document.getElementById("dueDate").value;
  const taxBalance = document.getElementById("taxBalance");

  if (year.value === "-- اختر من القائمة السنة الضريبية --") {
    let caption ="يرجي اختيار السنة الضريبية.";
    showMessage( caption, 'error');    
    year.focus();
    return;
  }

  if (taxBalance.value === "") {
    let caption ="يرجي إدخال قيمة الرصيد.";
    showMessage( caption, 'error');     
    taxBalance.focus();
    return;
  }

  if (editingRow) {
    editingRow.cells[1].innerText = `رصيد حتى سنة ${year.value}`;
    editingRow.cells[2].innerText = linkYear;
    editingRow.cells[3].innerText = dueDate;
    editingRow.cells[4].innerText = taxBalance.value;
    editingRow.setAttribute("data-year", year.value);
    editingRow.setAttribute("data-type", "رصيد");
    editingRow.style.backgroundColor = "#DAF7A6"; // اللون الأزرق مجددًا
    editingRow = null;
    sortAndUpdateTable(); // إعادة الفرز بعد التعديل
    // ✅ تعطيل زر "إضافة رصيد سابق"
    const addBtn = document.getElementById("addtaxBalanceBtn");
    addBtn.setAttribute("disabled", true);
    addBtn.classList.add("disabled");  
  } else {
    // ✅ إضافة صف الرصيد
    addRowToTable("رصيد حتى سنة", year.value, linkYear, dueDate, taxBalance.value, "رصيد");

    // ✅ تعطيل زر "إضافة رصيد سابق"
    const addBtn = document.getElementById("addtaxBalanceBtn");
    addBtn.setAttribute("disabled", true);
    addBtn.classList.add("disabled");
  }

  // ✅ إغلاق المودال وتنظيف الحقول
  balanceModal.style.display = "none";
  year.selectedIndex = 0;
  document.getElementById("linkYear").value = "";
  document.getElementById("dueDate").value = "";
  taxBalance.value = "";
};

// كود اعادة تفعيل زر اضافة الرصيد  
document.getElementById("addtaxBalanceBtn").onclick = function (e) {
  // إذا كان الزر معطلاً، لا تفعل شيئًا
  if (this.hasAttribute("disabled")) {
    e.preventDefault();
    return;
  }

  // ✅ التحقق من الكيان القانوني وتاريخ التأخير
  if (validateLegalEntity() && validateEndDate()) {
    balanceModal.style.display = "block";
  }
};

  
  
// حفظ بيانات الربط
document.getElementById("saveTaxDifferenceBtn").onclick = function () {
  const year = document.getElementById("year");
  const linkYear = document.getElementById("linkYear1").value;
  const dueDate = document.getElementById("dueDate1").value;
  const taxAmount = document.getElementById("taxAmount");

  if (year.value === "-- اختر من القائمة السنة الضريبية --") {
    let caption ="يرجي اختيار السنة الضريبية.";
    showMessage( caption, 'error');     
    year.focus();
    return;
  }

  if (taxAmount.value === "") {
    let caption ="يرجي إدخال مبلغ الربط.";
    showMessage( caption, 'error');     
    taxAmount.focus();
    return;
  }

  if (editingRow) {
    editingRow.cells[1].innerText = `ربط عن سنة ${year.value}`;
    editingRow.cells[2].innerText = linkYear;
    editingRow.cells[3].innerText = dueDate;
    editingRow.cells[4].innerText = taxAmount.value;
    editingRow.setAttribute("data-year", year.value);
    editingRow.setAttribute("data-type", "ربط");
    editingRow.style.backgroundColor = "#d2b4de"; // اللون البرتقالي مجددًا
    editingRow = null;
    sortAndUpdateTable(); // إعادة الفرز بعد التعديل
    // ✅ تعطيل زر "إضافة رصيد سابق"
    const addBtn = document.getElementById("addtaxBalanceBtn");
    addBtn.setAttribute("disabled", true);
    addBtn.classList.add("disabled");  
  } else {
    addRowToTable("ربط عن سنة", year.value, linkYear, dueDate, taxAmount.value, "ربط");
    
    // ✅ تعطيل زر "إضافة رصيد سابق"
    const addBtn = document.getElementById("addtaxBalanceBtn");
    addBtn.setAttribute("disabled", true);
    addBtn.classList.add("disabled");    
  }

  document.getElementById("taxDifferenceModal").style.display = "none";
  year.selectedIndex = 0;
  document.getElementById("linkYear1").value = "";
  document.getElementById("dueDate1").value = "";
  taxAmount.value = "";
};

document.getElementById("savePaymentBtn").onclick = function () {
  const rows = Array.from(balanceTableBody.querySelectorAll("tr"));
  const hasAnyRow = rows.length > 0;
  const hasBalance = rows.some(row => row.getAttribute("data-type") === "رصيد");
  const hasLink = rows.some(row => row.getAttribute("data-type") === "ربط");

  // إذا لم يكن هناك أي صف، أو لا يوجد رصيد ولا ربط → منع الإضافة
  if (!hasAnyRow || (!hasBalance && !hasLink)) {
    let caption ="يرجي إضافة الربط أولا.";
    showMessage( caption, 'error');      
    

    // تفريغ الحقول قبل إغلاق نافذة السداد
    document.getElementById("year1").selectedIndex = 0;
    document.getElementById("linkYear2").value = "";
    document.getElementById("dueDate2").value = "";
    document.getElementById("paymentAmount").value = "";

    // إغلاق نافذة السداد وفتح نافذة الربط
    document.getElementById("paymentModal").style.display = "none";
    document.getElementById("taxDifferenceModal").style.display = "block";
    return;
  }

  // باقي بيانات السداد
  const year = document.getElementById("year1");
  const linkYear = document.getElementById("linkYear2").value;
  const dueDate = document.getElementById("dueDate2").value;
  const paymentAmount = document.getElementById("paymentAmount");

  if (year.value === "-- اختر من القائمة السنة الضريبية --") {
    let caption ="يرجي اختيار السنة الضريبية.";
    showMessage( caption, 'error');    
    year.focus();
    return;
  }

  if (paymentAmount.value === "") {
    let caption ="يرجي إدخال مبلغ السداد.";
    showMessage( caption, 'error');     
    paymentAmount.focus();
    return;
  }

  if (editingRow) {
    editingRow.cells[1].innerText = `سداد عن سنة ${year.value}`;
    editingRow.cells[2].innerText = linkYear;
    editingRow.cells[3].innerText = dueDate;
    editingRow.cells[4].innerText = paymentAmount.value;
    editingRow.setAttribute("data-year", year.value);
    editingRow.setAttribute("data-type", "سداد");
    editingRow.style.backgroundColor = "#abebc6";
    editingRow = null;
    sortAndUpdateTable();
    // ✅ تعطيل زر "إضافة رصيد سابق"
    const addBtn = document.getElementById("addtaxBalanceBtn");
    addBtn.setAttribute("disabled", true);
    addBtn.classList.add("disabled");  
  } else {
    addRowToTable("سداد عن سنة", year.value, linkYear, dueDate, paymentAmount.value, "سداد");
    
    // ✅ تعطيل زر "إضافة رصيد سابق"
    const addBtn = document.getElementById("addtaxBalanceBtn");
    addBtn.setAttribute("disabled", true);
    addBtn.classList.add("disabled");
  }

  // إغلاق النافذة وتفريغ الحقول
  document.getElementById("paymentModal").style.display = "none";
  year.selectedIndex = 0;
  document.getElementById("linkYear2").value = "";
  document.getElementById("dueDate2").value = "";
  paymentAmount.value = "";
};

</script>
     
<script>
const interestRates = {
    2005: 12.00,
    2006: 12.00,
    2007: 11.00,
    2008: 11.00,
    2009: 13.50,
    2010: 10.50,
    2011: 10.50,
    2012: 11.50,
    2013: 11.50,
    2014: 10.75,
    2015: 11.75,
    2016: 11.75,
    2017: 17.25,
    2018: 21.25,
    2019: 19.25,
    2020: 14.75,
    2021: 10.75,
    2022: 10.75,
    2023: 18.75,
    2024: 21.75,
    2025: 29.75,
};

function parseDate(dateStr) {
    const parts = dateStr.split("/");
    if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        return new Date(year, month, day);
    }
    return null;
}

function formatDate(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function getStartOfNextMonth(date) {
    const year = date.getMonth() === 11 ? date.getFullYear() + 1 : date.getFullYear();
    const month = (date.getMonth() + 1) % 12;
    return new Date(year, month, 1);
}

function isLeapYear(year) {
    return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
}

  
  
function calculateFinalTax() {
  // التحقق من الكيان القانوني
  if (!validateLegalEntity()) return;

  // التحقق من إدخال تاريخ نهاية الفترة
  if (!validateEndDate()) return;
  
  const rows = Array.from(balanceTableBody.querySelectorAll("tr"));
  const hasAnyRow = rows.length > 0;
  const hasBalance = rows.some(row => row.getAttribute("data-type") === "رصيد");
  const hasLink = rows.some(row => row.getAttribute("data-type") === "ربط");
  const hasPayment = rows.some(row => row.getAttribute("data-type") === "سداد");

  // إذا لم يكن هناك أي صف، أو لا يوجد أي من (رصيد أو ربط أو سداد) → منع الإضافة
  if (!hasAnyRow || (!hasBalance && !hasLink && !hasPayment)) {
    let caption = "يرجى إضافة بيانات الرصيد أو الربط أو السداد أولا.";
    showMessage(caption, 'error');
    return;
  }
  
    const balanceRows = Array.from(document.querySelectorAll('#balanceTable tbody tr'));
    const financialTableBody = document.querySelector('#financialTable tbody');

    financialTableBody.innerHTML = '';

    let totalDelay = 0;
    let previousBalance = 0;
    let previousEndDate = null;
    let lastProcessedYear = null;
    const processedYears = new Set();
    let firstBalanceAdded = false;
    const yearsWithMultipleDates = new Set();

    // تحديد السنوات التي تحتوي على أكثر من تاريخ
    const yearDateCounts = {};
    balanceRows.forEach(row => {
        const dateStr = row.cells[3].innerText.trim();
        const inputDate = parseDate(dateStr);
        if (inputDate) {
            const year = inputDate.getFullYear();
            yearDateCounts[year] = (yearDateCounts[year] || 0) + 1;
            if (yearDateCounts[year] > 1) {
                yearsWithMultipleDates.add(year);
            }
        }
    });

    // تحديد ما إذا كان هناك صف رصيد ليس الأول في الجدول
    let hasBalanceNotFirst = false;
    for (let i = 1; i < balanceRows.length; i++) {
        const description = balanceRows[i].cells[1].innerText.trim();
        if (/رصيد/i.test(description)) {
            hasBalanceNotFirst = true;
            break;
        }
    }

    // تحديد السنوات التي لا تبدأ بـ 01/01
    const yearsWithNonJanStart = new Set();
    balanceRows.forEach((row, index) => {
        const dateStr = row.cells[3].innerText.trim();
        const inputDate = parseDate(dateStr);
        if (inputDate) {
            const year = inputDate.getFullYear();
            // إذا كانت السنة تحتوي على أكثر من تاريخ وأول تاريخ ليس 01/01
            if (yearsWithMultipleDates.has(year) && 
                (inputDate.getMonth() !== 0 || inputDate.getDate() !== 1)) {
                // التحقق إذا كان هذا هو أول صف لهذه السنة
                let isFirstRowForYear = true;
                for (let i = 0; i < index; i++) {
                    const prevDateStr = balanceRows[i].cells[3].innerText.trim();
                    const prevInputDate = parseDate(prevDateStr);
                    if (prevInputDate && prevInputDate.getFullYear() === year) {
                        isFirstRowForYear = false;
                        break;
                    }
                }
                if (isFirstRowForYear) {
                    yearsWithNonJanStart.add(year);
                }
            }
        }
    });

    for (let i = 0; i < balanceRows.length; i++) {
        const row = balanceRows[i];
        const description = row.cells[1].innerText.trim();
        const dateStr = row.cells[3].innerText.trim();
        const amount = parseFloat(row.cells[4].innerText.trim()) || 0;
        const inputDate = parseDate(dateStr);
        if (!inputDate || isNaN(inputDate)) continue;

        const year = inputDate.getFullYear();
        const isSpecialYear = yearsWithMultipleDates.has(year) && hasBalanceNotFirst;
        const isTwoDatesInSameYear = yearsWithMultipleDates.has(year) && yearDateCounts[year] === 2;

        // معالجة السنوات التي لا تبدأ بـ 01/01
        if (yearsWithNonJanStart.has(year)) {
            // التحقق إذا كان هذا هو أول صف لهذه السنة
            let isFirstRowForYear = true;
            for (let j = 0; j < i; j++) {
                const prevDateStr = balanceRows[j].cells[3].innerText.trim();
                const prevInputDate = parseDate(prevDateStr);
                if (prevInputDate && prevInputDate.getFullYear() === year) {
                    isFirstRowForYear = false;
                    break;
                }
            }
            
            if (isFirstRowForYear) {
                // إضافة صف من 01/01 إلى التاريخ الحالي
                const startPeriod = new Date(year, 0, 1);
                const endPeriod = new Date(inputDate.getFullYear(), inputDate.getMonth(), inputDate.getDate());
                
                const months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                             (endPeriod.getMonth() - startPeriod.getMonth()) + 1;
                const rate = interestRates[year] || 0;
                
                if (previousBalance > (firstBalanceAdded ? 200 : 0)) {
                    const delayAmount = ((previousBalance - (firstBalanceAdded ? 200 : 0)) * rate * months) / 12 / 100;
                    totalDelay += delayAmount;

                    const gapRow = document.createElement('tr');
                    gapRow.innerHTML = `
                        <td>${formatDate(startPeriod)}</td>
                        <td>${formatDate(endPeriod)}</td>
                        <td></td>
                        <td>${months}/12</td>
                        <td>${rate.toFixed(2)}%</td>
                        <td>0</td>
                        <td>0</td>
                        <td>${previousBalance.toFixed(0)}</td>
                        <td>${delayAmount.toFixed(2)}</td>
                    `;
                    financialTableBody.appendChild(gapRow);
                }
                
                // متابعة معالجة الصف الأصلي كالمعتاد
                yearsWithNonJanStart.delete(year);
            }
        }

        if (/رصيد/i.test(description) && !firstBalanceAdded) {
            firstBalanceAdded = true;
        }
      

        // إضافة السنوات المفقودة
        if (lastProcessedYear !== null && year > lastProcessedYear + 1 && !isSpecialYear && !isTwoDatesInSameYear) {
            for (let missingYear = lastProcessedYear + 1; missingYear < year; missingYear++) {
                if (!processedYears.has(missingYear)) {
                    const startOfYear = new Date(missingYear, 0, 1);
                    const endOfYear = new Date(missingYear, 11, 31);
                    const rate = interestRates[missingYear] || 0;
                    let delayAmount = 0;

                    if (previousBalance > (firstBalanceAdded ? 200 : 0)) {
                        delayAmount = ((previousBalance - (firstBalanceAdded ? 200 : 0)) * rate * 12) / 12 / 100;
                        totalDelay += delayAmount;
                    }

                    const missingYearRow = document.createElement('tr');
                    missingYearRow.innerHTML = `
                        <td>${formatDate(startOfYear)}</td>
                        <td>${formatDate(endOfYear)}</td>
                        <td></td>
                        <td>12/12</td>
                        <td>${rate.toFixed(2)}%</td>
                        <td>0</td>
                        <td>0</td>
                        <td>${previousBalance.toFixed(0)}</td>
                        <td>${delayAmount.toFixed(2)}</td>
                    `;
                    financialTableBody.appendChild(missingYearRow);
                    processedYears.add(missingYear);
                }
            }
        }

        lastProcessedYear = year;

        // معالجة خاصة للسنوات التي تحتوي على تاريخين فقط
        if (isTwoDatesInSameYear) {
            // الحالة 1: ربط في نفس السنة
if (/ربط/i.test(description)) {
    const startPeriod = getStartOfNextMonth(inputDate);
    let endPeriod = new Date(year, 11, 31);
    let deduct200 = firstBalanceAdded; // الافتراضي

    // البحث عن أول "رصيد حتى سنة" أو "سداد" في نفس السنة
    for (let j = i + 1; j < balanceRows.length; j++) {
        const nextRow = balanceRows[j];
        const nextDateStr = nextRow.cells[3].innerText.trim();
        const nextInputDate = parseDate(nextDateStr);
        const nextDescription = nextRow.cells[1].innerText.trim();

        if (!nextInputDate || nextInputDate.getFullYear() !== year) continue;

        if (/رصيد حتى سنة/i.test(nextDescription)) {
            endPeriod = nextInputDate;
            deduct200 = false; // لا نخصم 200 جنيه
            break;
        }

        if (/سداد/i.test(nextDescription)) {
            endPeriod = new Date(nextInputDate.getFullYear(), nextInputDate.getMonth(), 0);
            deduct200 = false; // لا نخصم 200 جنيه
            break;
        }
    }

    const months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                 (endPeriod.getMonth() - startPeriod.getMonth()) + 1;
    const rate = interestRates[year] || 0;

    const linkAmount = amount;
    const balance = previousBalance + linkAmount;

    const deduction = deduct200 ? 200 : 0;

    if (balance > deduction) {
        const delayAmount = ((balance - deduction) * rate * months) / 12 / 100;
        totalDelay += delayAmount;

        const linkRow = document.createElement('tr');
        linkRow.innerHTML = `
            <td>${formatDate(startPeriod)}</td>
            <td>${formatDate(endPeriod)}</td>
            <td>${description}</td>
            <td>${months}/12</td>
            <td>${rate.toFixed(2)}%</td>
            <td>${linkAmount.toFixed(0)}</td>
            <td>${deduction}</td>
            <td>${balance.toFixed(0)}</td>
            <td>${delayAmount.toFixed(2)}</td>
        `;
        financialTableBody.appendChild(linkRow);
    }

    previousBalance = balance;
    previousEndDate = endPeriod;
    continue;
}

          
            
            // الحالة 2: رصيد في نفس السنة
            else if (/رصيد/i.test(description)) {
                // بداية الفترة: أول يوم من الشهر التالي لتاريخ الرصيد
                const startPeriod = getStartOfNextMonth(inputDate);
                // نهاية الفترة: نهاية الشهر السابق لتاريخ السداد أو نفس تاريخ الربط
                let endPeriod = null;
                
                // البحث عن تاريخ السداد أو الربط التالي في نفس السنة
                if (i < balanceRows.length - 1) {
                    const nextRow = balanceRows[i+1];
                    const nextDateStr = nextRow.cells[3].innerText.trim();
                    const nextInputDate = parseDate(nextDateStr);
                    const nextDescription = nextRow.cells[1].innerText.trim();
                    
                    if (nextInputDate && nextInputDate.getFullYear() === year) {
                        if (/سداد/i.test(nextDescription)) {
                            endPeriod = new Date(nextInputDate.getFullYear(), nextInputDate.getMonth(), 0);
                        } else if (/ربط/i.test(nextDescription)) {
                            endPeriod = nextInputDate;
                        }
                    }
                }
                
                // إذا لم يتم العثور على تاريخ سداد أو ربط، نستخدم نهاية السنة
                if (!endPeriod) {
                    endPeriod = new Date(year, 11, 31);
                }
                
                const months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                             (endPeriod.getMonth() - startPeriod.getMonth()) + 1;
                const rate = interestRates[year] || 0;
                
                const linkAmount = amount;
                const balance = previousBalance + linkAmount;
                
                if (balance > (firstBalanceAdded ? 200 : 0)) {
                    const delayAmount = ((balance - (firstBalanceAdded ? 200 : 0)) * rate * months) / 12 / 100;
                    totalDelay += delayAmount;

                    const balanceRow = document.createElement('tr');
                    balanceRow.innerHTML = `
                        <td>${formatDate(startPeriod)}</td>
                        <td>${formatDate(endPeriod)}</td>
                        <td>${description}</td>
                        <td>${months}/12</td>
                        <td>${rate.toFixed(2)}%</td>
                        <td>${linkAmount.toFixed(0)}</td>
                        <td>0</td>
                        <td>${balance.toFixed(0)}</td>
                        <td>${delayAmount.toFixed(2)}</td>
                    `;
                    financialTableBody.appendChild(balanceRow);
                }

                previousBalance = balance;
                previousEndDate = endPeriod;
                continue;
            }
            
            // الحالة 3: سداد في نفس السنة
            else if (/سداد/i.test(description)) {
                // تحديد بداية الفترة بناءً على نوع الصف السابق
                let startPeriod;
                let apply200Deduction = firstBalanceAdded; // هل نطبق خصم 200 جنيه؟
                
                // التحقق من الصف السابق
                if (i > 0) {
                    const prevRow = balanceRows[i-1];
                    const prevDescription = prevRow.cells[1].innerText.trim();
                    
                    if (/ربط/i.test(prevDescription)) {
                        // إذا كان الصف السابق ربطًا: أول يوم من الشهر التالي لتاريخ السداد
                        startPeriod = new Date(previousEndDate.getFullYear(), previousEndDate.getMonth() + 1, 1);

                        // تطبيق خصم 200 جنيه لصف السداد هذا وجميع الصفوف التالية
                        apply200Deduction = true;
                    } else {
                        // إذا كان الصف السابق رصيدًا أو أي شيء آخر: أول يوم من الشهر الحالي للسداد
                        startPeriod = inputDate;
                    }
                } else {
                    // إذا كان الصف الأول سدادًا (حالة غير متوقعة): أول يوم من الشهر الحالي للسداد
                    startPeriod = new Date(inputDate.getFullYear(), inputDate.getMonth(), 1);
                }
                
                // نهاية الفترة: 31/12 نهاية السنة الحالية
                const endPeriod = new Date(year, 11, 31);
                
                const months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                             (endPeriod.getMonth() - startPeriod.getMonth()) + 1;
                const rate = interestRates[year] || 0;
                
                const paymentAmount = amount;
                const balance = previousBalance - paymentAmount;
                
                // حساب التأخير مع تطبيق خصم 200 جنيه إذا لزم الأمر
                const delayAmount = apply200Deduction 
                    ? ((balance - 200) > 0 ? ((balance - 200) * rate * months) / 12 / 100 : 0)
                    : (balance > 0 ? (balance * rate * months) / 12 / 100 : 0);
                
                totalDelay += delayAmount;

                const paymentRow = document.createElement('tr');
                paymentRow.innerHTML = `
                    <td>${formatDate(startPeriod)}</td>
                    <td>${formatDate(endPeriod)}</td>
                    <td>${description}</td>
                    <td>${months}/12</td>
                    <td>${rate.toFixed(2)}%</td>
                    <td>0</td>
                    <td>${paymentAmount.toFixed(0)}</td>
                    <td>${balance.toFixed(0)}</td>
                    <td>${delayAmount.toFixed(2)}</td>
                `;
                financialTableBody.appendChild(paymentRow);

                previousBalance = balance;
                previousEndDate = endPeriod;
                processedYears.add(year);
                
                // إذا كان الصف السابق ربطًا، نفعّل خصم 200 جنيه لجميع الصفوف التالية
                if (apply200Deduction && !firstBalanceAdded) {
                    firstBalanceAdded = true;
                }
                
                continue;
            }
        }
      
      
      
      
      
       
        // معالجة خاصة للسنوات التي تحتوي على أكثر من تاريخ ويوجد قبلها سنوات مضافة
        if (isSpecialYear) {
            let startPeriod, endPeriod, months, rate, descriptionText;
            let linkAmount = 0;
            let paymentAmount = 0;
            let balance = previousBalance;

if (/ربط/i.test(description) && i < balanceRows.length - 1) {
    // بداية الفترة: أول يوم من الشهر التالي لتاريخ الربط
    startPeriod = getStartOfNextMonth(inputDate);

    const nextRow = balanceRows[i + 1];

    if (nextRow) {
        const nextDescription = nextRow.cells[1].innerText.trim(); // البيان في العمود الثاني (index 1)
        const nextDate = parseDate(nextRow.cells[3].innerText.trim()); // التاريخ في العمود الرابع (index 3)

        const afterNextRow = balanceRows[i + 2];
        const afterNextDescription = afterNextRow ? afterNextRow.cells[1].innerText.trim() : ''; // البيان في العمود 1

// ✅ إذا كان الربط يليه سداد ثم رصيد، فـ نهاية الفترة = تاريخ السداد
if (/سداد/i.test(nextDescription) && /رصيد/i.test(afterNextDescription)) {
    endPeriod = new Date(nextDate); // استخدام تاريخ السداد نفسه
}
        // باقي الحالات الطبيعية:
        else if (/سداد/i.test(nextDescription)) {
            endPeriod = nextDate;
        } else if (/رصيد/i.test(nextDescription)) {
            endPeriod = nextDate;
        } else {
            endPeriod = new Date(year, 11, 31); // نهاية السنة
        }
    } else {
        endPeriod = new Date(year, 11, 31); // نهاية السنة
    }

    // حساب عدد الأشهر بين بداية ونهاية الفترة
    months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
             (endPeriod.getMonth() - startPeriod.getMonth()) + 1;

    // سعر الفائدة حسب السنة
    rate = interestRates[year] || 0;

    // قيمة الربط
    linkAmount = amount;

    // تحديث الرصيد
    balance = previousBalance + linkAmount;

    // إذا كان الرصيد بعد الربط أكبر من الحد المعفى (200 جنيه)
    if (balance > (firstBalanceAdded ? 200 : 0)) {
        const delayAmount = ((balance - (firstBalanceAdded ? 200 : 0)) * rate * months) / 12 / 100;
        totalDelay += delayAmount;

        // إنشاء صف جديد في جدول النتائج
        const linkRow = document.createElement('tr');
        linkRow.innerHTML = `
            <td>${formatDate(startPeriod)}</td>
            <td>${formatDate(endPeriod)}</td>
            <td>${description}</td>
            <td>${months}/12</td>
            <td>${rate.toFixed(2)}%</td>
            <td>${linkAmount.toFixed(0)}</td>
            <td>0</td>
            <td>${balance.toFixed(0)}</td>
            <td>${delayAmount.toFixed(2)}</td>
        `;
        financialTableBody.appendChild(linkRow);
    }

    previousBalance = balance;
    previousEndDate = endPeriod;
    continue;
}


else if (/رصيد/i.test(description)) {
    // تصحيح فترة الرصيد لتبدأ من أول الشهر التالي لآخر تاريخ معالجة
    if (previousEndDate) {
        startPeriod = getStartOfNextMonth(previousEndDate);

        // بشكل افتراضي: نهاية الفترة تكون آخر يوم في نفس شهر تاريخ البداية
        endPeriod = new Date(startPeriod.getFullYear(), startPeriod.getMonth() + 1, 0);

        // التحقق من الصف التالي
        const nextRow = balanceRows[i + 1];
        if (nextRow) {
            const nextDescription = nextRow.cells[1].innerText.trim();
            const nextDate = parseDate(nextRow.cells[3].innerText.trim());

            if (/ربط|سداد/i.test(nextDescription)) {
                // نهاية الفترة تكون نفس تاريخ الصف التالي إذا كان "ربط" أو "سداد"
                endPeriod = nextDate;
            } else if (nextDate.getFullYear() > year || i === balanceRows.length - 1) {
                // إذا كان الصف التالي في سنة مختلفة أو لا يوجد صف بعده، تكون نهاية الفترة 31/12
                endPeriod = new Date(year, 11, 31);
            }
        } else {
            // لا يوجد صف بعده، نهاية الفترة 31/12
            endPeriod = new Date(year, 11, 31);
        }

        months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                 (endPeriod.getMonth() - startPeriod.getMonth()) + 1;
        rate = interestRates[year] || 0;

        linkAmount = amount;
        balance = previousBalance + linkAmount;

        if (balance > (firstBalanceAdded ? 200 : 0)) {
            const delayAmount = ((balance - (firstBalanceAdded ? 200 : 0)) * rate * months) / 12 / 100;
            totalDelay += delayAmount;

            const balanceRow = document.createElement('tr');
            balanceRow.innerHTML = `
                <td>${formatDate(startPeriod)}</td>
                <td>${formatDate(endPeriod)}</td>
                <td>${description}</td>
                <td>${months}/12</td>
                <td>${rate.toFixed(2)}%</td>
                <td>${linkAmount.toFixed(0)}</td>
                <td>0</td>
                <td>${balance.toFixed(0)}</td>
                <td>${delayAmount.toFixed(2)}</td>
            `;
            financialTableBody.appendChild(balanceRow);
        }
    }

    previousBalance = balance;
    previousEndDate = endPeriod;
    continue;
}

else if (/سداد/i.test(description)) {
    // تحقق أولاً: هل الصف السابق "ربط" والصف التالي "رصيد"
    const prevRow = balanceRows[i - 1];
    const nextRow = balanceRows[i + 1];

    const prevDescription = prevRow ? prevRow.cells[1].innerText.trim() : "";
    const nextDescription = nextRow ? nextRow.cells[1].innerText.trim() : "";
    const nextDate = nextRow ? parseDate(nextRow.cells[3].innerText.trim()) : null;

    let customHandled = false;

    if (/ربط/i.test(prevDescription) && /رصيد/i.test(nextDescription) && nextDate && nextDate > inputDate) {
        // ✅ الحالة الخاصة: بين ربط ورصيد
    startPeriod = getStartOfNextMonth(inputDate); // ✅ أول يوم من الشهر التالي لتاريخ السداد
        endPeriod = nextDate;

        months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                 (endPeriod.getMonth() - startPeriod.getMonth()) + 1;

        rate = interestRates[year] || 0;
        paymentAmount = amount;
        balance = previousBalance - paymentAmount;

        if (balance > (firstBalanceAdded ? 200 : 0)) {
            const delayAmount = ((balance - (firstBalanceAdded ? 200 : 0)) * rate * months) / 12 / 100;
            totalDelay += delayAmount;

            const paymentRow = document.createElement('tr');
            paymentRow.innerHTML = `
                <td>${formatDate(startPeriod)}</td>
                <td>${formatDate(endPeriod)}</td>
                <td>${description}</td>
                <td>${months}/12</td>
                <td>${rate.toFixed(2)}%</td>
                <td>0</td>
                <td>${paymentAmount.toFixed(0)}</td>
                <td>${balance.toFixed(0)}</td>
                <td>${delayAmount.toFixed(2)}</td>
            `;
            financialTableBody.appendChild(paymentRow);
        }

        previousBalance = balance;
        previousEndDate = endPeriod;
        processedYears.add(year);
        customHandled = true;
        continue;
    }

    // ✅ إذا لم تتحقق الحالة المخصصة أعلاه، نُنفذ الكود العادي كما هو:
    if (!customHandled && previousEndDate) {
        startPeriod = getStartOfNextMonth(previousEndDate);
        endPeriod = new Date(year, 11, 31); // 31 ديسمبر من السنة الحالية

        if (startPeriod.getFullYear() > year) {
            continue;
        }

        if (startPeriod.getFullYear() < year) {
            startPeriod = new Date(year, 0, 1);
        }

        months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                 (endPeriod.getMonth() - startPeriod.getMonth()) + 1;

        rate = interestRates[year] || 0;
        paymentAmount = amount;
        balance = previousBalance - paymentAmount;

        if (balance > (firstBalanceAdded ? 200 : 0)) {
            const delayAmount = ((balance - (firstBalanceAdded ? 200 : 0)) * rate * months) / 12 / 100;
            totalDelay += delayAmount;

            const paymentRow = document.createElement('tr');
            paymentRow.innerHTML = `
                <td>${formatDate(startPeriod)}</td>
                <td>${formatDate(endPeriod)}</td>
                <td>${description}</td>
                <td>${months}/12</td>
                <td>${rate.toFixed(2)}%</td>
                <td>0</td>
                <td>${paymentAmount.toFixed(0)}</td>
                <td>${balance.toFixed(0)}</td>
                <td>${delayAmount.toFixed(2)}</td>
            `;
            financialTableBody.appendChild(paymentRow);
        }

        previousBalance = balance;
        previousEndDate = endPeriod;
        processedYears.add(year);
        continue;
    }
}

        }

      
      
       
      
      
        // معالجة خاصة للسنوات التي تحتوي على أكثر من تاريخ ولا يوجد قبلها سنوات مضافة
        if (isSpecialYear) {
            let startPeriod, endPeriod, months, rate;
            let linkAmount = 0;
            let paymentAmount = 0;
            let balance = previousBalance;

            if (/ربط/i.test(description)) {
                startPeriod = getStartOfNextMonth(inputDate);
                const nextRow = balanceRows[i + 1];
                if (nextRow) {
                    const nextDescription = nextRow.cells[2].innerText.trim();
                    const nextDate = parseDate(nextRow.cells[3].innerText.trim());
                    if (/سداد/i.test(nextDescription)) {
                        endPeriod = nextDate;
                    } else if (/رصيد/i.test(nextDescription)) {
                        endPeriod = nextDate;
                    } else {
                        endPeriod = new Date(year, 11, 31); // نهاية السنة
                    }
                } else {
                    endPeriod = new Date(year, 11, 31); // نهاية السنة
                }

                months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                         (endPeriod.getMonth() - startPeriod.getMonth()) + 1;
                rate = interestRates[year] || 0;
                linkAmount = amount;
                balance = previousBalance + linkAmount;

                if (balance > (firstBalanceAdded ? 200 : 0)) {
                    const delayAmount = ((balance - (firstBalanceAdded ? 200 : 0)) * rate * months) / 12 / 100;
                    totalDelay += delayAmount;

                    const linkRow = document.createElement('tr');
                    linkRow.innerHTML = `
                        <td>${formatDate(startPeriod)}</td>
                        <td>${formatDate(endPeriod)}</td>
                        <td>${description}</td>
                        <td>${months}/12</td>
                        <td>${rate.toFixed(2)}%</td>
                        <td>${linkAmount.toFixed(0)}</td>
                        <td>0</td>
                        <td>${balance.toFixed(0)}</td>
                        <td>${delayAmount.toFixed(2)}</td>
                    `;
                    financialTableBody.appendChild(linkRow);
                }

                previousBalance = balance;
                previousEndDate = endPeriod;
                continue;
            }

            else if (/رصيد/i.test(description)) {
                startPeriod = getStartOfNextMonth(inputDate);

                const nextRow = balanceRows[i + 1];
                if (nextRow) {
                    const nextDescription = nextRow.cells[2].innerText.trim();
                    const nextDate = parseDate(nextRow.cells[3].innerText.trim());
                    if (/سداد/i.test(nextDescription)) {
                        endPeriod = new Date(nextDate.getFullYear(), nextDate.getMonth(), 0); // نهاية الشهر السابق
                    } else if (/ربط/i.test(nextDescription)) {
                        endPeriod = nextDate;
                    } else {
                        endPeriod = new Date(year, 11, 31);
                    }
                } else {
                    endPeriod = new Date(year, 11, 31);
                }

                months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                         (endPeriod.getMonth() - startPeriod.getMonth()) + 1;
                rate = interestRates[year] || 0;
                linkAmount = amount;
                balance = previousBalance + linkAmount;

                if (balance > (firstBalanceAdded ? 200 : 0)) {
                    const delayAmount = ((balance - (firstBalanceAdded ? 200 : 0)) * rate * months) / 12 / 100;
                    totalDelay += delayAmount;

                    const balanceRow = document.createElement('tr');
                    balanceRow.innerHTML = `
                        <td>${formatDate(startPeriod)}</td>
                        <td>${formatDate(endPeriod)}</td>
                        <td>${description}</td>
                        <td>${months}/12</td>
                        <td>${rate.toFixed(2)}%</td>
                        <td>${linkAmount.toFixed(0)}</td>
                        <td>0</td>
                        <td>${balance.toFixed(0)}</td>
                        <td>${delayAmount.toFixed(2)}</td>
                    `;
                    financialTableBody.appendChild(balanceRow);
                }

                previousBalance = balance;
                previousEndDate = endPeriod;
                continue;
            }

            else if (/سداد/i.test(description)) {
                startPeriod = new Date(inputDate.getFullYear(), inputDate.getMonth(), 1);
                endPeriod = new Date(year, 11, 31);

                months = (endPeriod.getFullYear() - startPeriod.getFullYear()) * 12 +
                         (endPeriod.getMonth() - startPeriod.getMonth()) + 1;
                rate = interestRates[year] || 0;
                paymentAmount = amount;
                balance = previousBalance - paymentAmount;

                if (balance > (firstBalanceAdded ? 200 : 0)) {
                    const delayAmount = ((balance - (firstBalanceAdded ? 200 : 0)) * rate * months) / 12 / 100;
                    totalDelay += delayAmount;

                    const paymentRow = document.createElement('tr');
                    paymentRow.innerHTML = `
                        <td>${formatDate(startPeriod)}</td>
                        <td>${formatDate(endPeriod)}</td>
                        <td>${description}</td>
                        <td>${months}/12</td>
                        <td>${rate.toFixed(2)}%</td>
                        <td>0</td>
                        <td>${paymentAmount.toFixed(0)}</td>
                        <td>${balance.toFixed(0)}</td>
                        <td>${delayAmount.toFixed(2)}</td>
                    `;
                    financialTableBody.appendChild(paymentRow);
                }

                previousBalance = balance;
                previousEndDate = endPeriod;
                processedYears.add(year);
                continue;
            }
        }

// التعامل مع صفوف السداد العادية
if (/سداد/i.test(description) && !isSpecialYear && !isTwoDatesInSameYear) {
    // استخراج تاريخ السداد من الجدول الأصلي balanceTable
    const originalDateText = row.cells[3]?.textContent?.trim();
    const originalDate = originalDateText ? parseDate(originalDateText) : null;

    if (!originalDate) continue; // تخطى الصف لو التاريخ غير صالح

    const year = originalDate.getFullYear();
    const month = originalDate.getMonth(); // شهر السداد (من 0 إلى 11)

    const startOfYear = new Date(year, 0, 1); // 01/01
    const endOfPaymentDate = originalDate; // نهاية الفترة الأولى: نفس تاريخ السداد
    const startOfNextMonth = new Date(year, month + 1, 1); // بداية الفترة الثانية: أول يوم من الشهر التالي
    const endOfYear = new Date(year, 11, 31); // 31/12
    const rate = interestRates[year] || 0;

    // حساب عدد شهور الفترة الأولى (من 01/01 إلى تاريخ السداد)
    const gapMonths = (month + (originalDate.getDate() > 1 ? 1 : 0)); // تقريبي، لأغراض الفائدة الشهرية
    let delayAmountBeforePayment = 0;
    if (gapMonths > 0 && previousBalance > (firstBalanceAdded ? 200 : 0)) {
        delayAmountBeforePayment = ((previousBalance - (firstBalanceAdded ? 200 : 0)) * rate * gapMonths) / 12 / 100;
        totalDelay += delayAmountBeforePayment;

        const gapRow = document.createElement('tr');
        gapRow.innerHTML = `
            <td>${formatDate(startOfYear)}</td>
            <td>${formatDate(endOfPaymentDate)}</td>
            <td></td>
            <td>${gapMonths}/12</td>
            <td>${rate.toFixed(2)}%</td>
            <td>0</td>
            <td>0</td>
            <td>${previousBalance.toFixed(0)}</td>
            <td>${delayAmountBeforePayment.toFixed(2)}</td>
        `;
        financialTableBody.appendChild(gapRow);
    }

    // الفترة الثانية: من أول الشهر التالي لتاريخ السداد إلى نهاية السنة
    const remainingMonths = 12 - (month + 1);
    const paymentAmount = amount;
    const newBalance = previousBalance - paymentAmount;
    let delayAmount = 0;

    if (remainingMonths > 0 && newBalance > (firstBalanceAdded ? 200 : 0)) {
        delayAmount = ((newBalance - (firstBalanceAdded ? 200 : 0)) * rate * remainingMonths) / 12 / 100;
        totalDelay += delayAmount;
    }

    const paymentRow = document.createElement('tr');
    paymentRow.innerHTML = `
        <td>${formatDate(startOfNextMonth)}</td>
        <td>${formatDate(endOfYear)}</td>
        <td>${description}</td>
        <td>${remainingMonths}/12</td>
        <td>${rate.toFixed(2)}%</td>
        <td>0</td>
        <td>${paymentAmount.toFixed(0)}</td>
        <td>${newBalance.toFixed(0)}</td>
        <td>${delayAmount.toFixed(2)}</td>
    `;
    financialTableBody.appendChild(paymentRow);

    processedYears.add(year);
    previousBalance = newBalance;
    previousEndDate = endOfYear;
    continue;
}



        // صف الفجوة العادي
        if (previousEndDate && !processedYears.has(year) && !isSpecialYear && !isTwoDatesInSameYear) {
            const gapStart = new Date(inputDate.getFullYear(), 0, 1);
            const gapEnd = new Date(inputDate.getFullYear(), inputDate.getMonth(), inputDate.getDate());

            const monthsGap = (gapEnd.getFullYear() - gapStart.getFullYear()) * 12 +
                              (gapEnd.getMonth() - gapStart.getMonth()) + 1;

            const rate = interestRates[gapStart.getFullYear()] || 0;
            let delayAmount = 0;

            if (previousBalance > (firstBalanceAdded ? 200 : 0)) {
                delayAmount = ((previousBalance - (firstBalanceAdded ? 200 : 0)) * rate * monthsGap) / 12 / 100;
                totalDelay += delayAmount;
            }

            const gapRow = document.createElement('tr');
            gapRow.innerHTML = `
                <td>${formatDate(gapStart)}</td>
                <td>${formatDate(gapEnd)}</td>
                <td></td>
                <td>${monthsGap}/12</td>
                <td>${rate.toFixed(2)}%</td>
                <td>0</td>
                <td>0</td>
                <td>${previousBalance.toFixed(0)}</td>
                <td>${delayAmount.toFixed(2)}</td>
            `;
            financialTableBody.appendChild(gapRow);
            processedYears.add(year);
        }

        // الفترة الرئيسية
        if (!isSpecialYear && !isTwoDatesInSameYear) {
            const startDate = getStartOfNextMonth(inputDate);
            const endDate = new Date(startDate.getFullYear(), 11, 31);
            const months = (endDate.getFullYear() - startDate.getFullYear()) * 12 +
                           (endDate.getMonth() - startDate.getMonth()) + 1;
            const interestRate = interestRates[startDate.getFullYear()] || 0;

            let linkAmount = 0;
            if (/ربط|رصيد/i.test(description)) {
                linkAmount = amount;
                if (/رصيد/i.test(description) && !firstBalanceAdded) {
                    firstBalanceAdded = true;
                }
            }

            const balance = previousBalance + linkAmount;
            let delayAmount = 0;
            if (balance > (firstBalanceAdded ? 200 : 0)) {
                delayAmount = ((balance - (firstBalanceAdded ? 200 : 0)) * interestRate * months) / 12 / 100;
                totalDelay += delayAmount;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${formatDate(startDate)}</td>
                <td>${formatDate(endDate)}</td>
                <td>${description}</td>
                <td>${months}/12</td>
                <td>${interestRate.toFixed(2)}%</td>
                <td>${linkAmount.toFixed(0)}</td>
                <td>0</td>
                <td>${balance.toFixed(0)}</td>
                <td>${delayAmount.toFixed(2)}</td>
            `;
            financialTableBody.appendChild(tr);
            processedYears.add(year);

            previousBalance = balance;
            previousEndDate = endDate;
        }
    }

// إضافة السنوات المتبقية حتى تاريخ الانتهاء
    if (lastProcessedYear !== null) {
        const endDateInput = document.getElementById('endDate').value.trim();
        let maxYear;
        let exactEndDate = null;

        if (endDateInput) {
            const parts = endDateInput.split('/');
            if (parts.length === 3) {
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const day = parseInt(parts[2], 10);
                if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                    maxYear = year;
                    exactEndDate = new Date(year, month, day);
                }
            }
        }

        if (maxYear && exactEndDate) {
            for (let missingYear = lastProcessedYear + 1; missingYear <= maxYear; missingYear++) {
                if (!processedYears.has(missingYear)) {
                    const startOfYear = new Date(missingYear, 0, 1);
                    const endOfPeriod = (missingYear === maxYear) 
                    ? new Date(exactEndDate.getFullYear(), exactEndDate.getMonth() + 1, 0)
                    : new Date(missingYear, 11, 31);


                    const monthDiff = (endOfPeriod.getFullYear() - startOfYear.getFullYear()) * 12 +
                                      (endOfPeriod.getMonth() - startOfYear.getMonth()) + 1;

                    const rate = interestRates[missingYear] || 0;
                    let delayAmount = 0;

                    if (previousBalance > (firstBalanceAdded ? 200 : 0)) {
                        delayAmount = ((previousBalance - (firstBalanceAdded ? 200 : 0)) * rate * monthDiff) / 12 / 100;
                        totalDelay += delayAmount;
                    }

                    const missingYearRow = document.createElement('tr');
                    missingYearRow.innerHTML = `
                        <td>${formatDate(startOfYear)}</td>
                        <td>${formatDate(endOfPeriod)}</td>
                        <td></td>
                        <td>${monthDiff}/12</td>
                        <td>${rate.toFixed(2)}%</td>
                        <td>0</td>
                        <td>0</td>
                        <td>${previousBalance.toFixed(0)}</td>
                        <td>${delayAmount.toFixed(2)}</td>
                    `;
                    financialTableBody.appendChild(missingYearRow);
                    processedYears.add(missingYear);
                }
            }
        }
    }

    document.getElementById('totalDelayAmount').innerText = totalDelay.toFixed(0);
    document.getElementById("textbox4").value = totalDelay.toFixed(0);
    updateTotalBalance0();
    updateTotalAfterDelayChange(totalDelay);  
    updateTotalPaid();
    updateNetDue();
    checkBalanceTable();
    applyDiscountIfNoYearlyBalance();
    fixEndPeriodForRabetIfSadadOnly(financialTableBody);
    colorizeTableRows();
    removeZeroDelayRows();
    selectArticle45Repeated();
    fixPeriodDates();
}


// اجمالي الارصدة + الاربطة فقط
function updateTotalBalance0() {
  let total = 0;
  const rows = document.querySelectorAll("#balanceTable tbody tr");

  rows.forEach(row => {
    const amount = parseFloat(row.cells[4].innerText.replace(/,/g, ''));
    const type = row.getAttribute("data-type");

    if (!isNaN(amount)) {
      if (type === "رصيد" || type === "ربط") {
        total += amount;
      }
      // تجاهل "سداد"
    }
  });

  document.getElementById("totalbalance").innerText = total.toFixed(0);
  document.getElementById("textbox5").value = total.toFixed(0);  
}

// اجمالي المبالغ المستحقة = المقابل + الرصيد
function updateTotalAfterDelayChange(totalDelay) {
  document.getElementById("textbox4").value = totalDelay.toFixed(0);

  const delay = totalDelay || 0;
  const principal = parseFloat(document.getElementById("textbox5").value) || 0;
  const totalDue = delay + principal;

  document.getElementById("textbox6").value = totalDue.toFixed(0);
}


// إجمالي السدادات فقط
function updateTotalPaid() {
  let totalPaid = 0;
  const rows = document.querySelectorAll("#balanceTable tbody tr");

  rows.forEach(row => {
    const type = row.getAttribute("data-type");
    const amount = parseFloat(row.cells[4].innerText.replace(/,/g, ''));

    if (type === "سداد" && !isNaN(amount)) {
      totalPaid += amount;
    }
  });

  document.getElementById("textbox7").value = totalPaid.toFixed(0);
}

// صافي المبالغ المستحقة = إجمالي المستحق - إجمالي السداد
function updateNetDue() {
  const totalDue = parseFloat(document.getElementById("textbox6").value) || 0;
  const totalPaid = parseFloat(document.getElementById("textbox7").value) || 0;
  const netDue = totalDue - totalPaid;

  document.getElementById("textbox8").value = netDue.toFixed(0);
}
  
  
  
// دالة إحتساب مقابل التأخير بدون خصم 200 جنية   
function recalculateWithoutDiscount() {
    // التحقق من حالة checkbox الخصم
    const discount200Checked = document.getElementById('discount200').checked;
    
    // الحصول على جميع صفوف جدول المقابلات المالية
    const financialRows = document.querySelectorAll('#financialTable tbody tr');
    let totalDelay = 0;
    
    // إعادة حساب كل صف حسب الحالة
    financialRows.forEach(row => {
        const cells = row.cells;
        const rate = parseFloat(cells[4].textContent.replace('%', '')) || 0;
        const monthsText = cells[3].textContent;
        const months = parseFloat(monthsText.split('/')[0]) || 0;
        const balance = parseFloat(cells[7].textContent) || 0;

        // ✅ استبعاد الصف إذا كان الرصيد سالبًا
        if (balance < 0) {
            cells[8].textContent = "0.00"; // يمكن أيضًا تصفير المقابل
            return;
        }

        // حساب التأخير الجديد حسب حالة الخصم
        let newDelay;
        if (discount200Checked) {
            // حساب بدون خصم 200 جنيه
            newDelay = (balance * rate * months) / 12 / 100;
        } else {
            // استدعاء دالة الحساب الأصلية
            newDelay = calculateFinalTax();
            show1();
        }

        // تحديث خلية مقابل التأخير
        cells[8].textContent = newDelay.toFixed(2);

        // إضافة إلى المجموع الكلي
        totalDelay += newDelay;
    });

    // تحديث المجموع الكلي في الواجهة
    document.getElementById('totalDelayAmount').textContent = totalDelay.toFixed(0);
    document.getElementById("textbox4").value = totalDelay.toFixed(0);

    // تحديث الحسابات الأخرى المرتبطة
    updateTotalBalance0();
    updateTotalAfterDelayChange(totalDelay);  
    updateTotalPaid();
    updateNetDue();
    show1();
  
    // إظهار رسالة مؤقتة لمدة 1 ثانية
    const message = document.createElement('div');
    message.textContent = "تم احتساب المقابل بدون خصم 200 جنيه بنجاح";

    // تنسيق الرسالة
    message.style.position = 'fixed';
    message.style.top = '50%';
    message.style.left = '50%';
    message.style.transform = 'translate(-50%, -50%)';
    message.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    message.style.color = 'white';
    message.style.fontWeight = 'bold';
    message.style.fontSize = '17px';
    message.style.padding = '20px';
    message.style.borderRadius = '10px';
    message.style.zIndex = '9999';
    message.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    message.style.textAlign = 'center';
    message.style.minWidth = '300px';

    document.body.appendChild(message);

    // إخفاء الرسالة بعد 1 ثانية
    setTimeout(() => {
        message.style.transition = 'opacity 0.5s ease-in-out';
        message.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(message);
        }, 500);
    }, 500);
}

// إضافة مستمع حدث لتحديد خانة الاختيار
document.getElementById('discount200').addEventListener('change', recalculateWithoutDiscount);  

  
// دالة خصم 200 ج من جميع الصفوف في حالة عدم وجود صف بيانه " رصيد حتي سنة  
function applyDiscountIfNoYearlyBalance() {
    const financialTable = document.getElementById('financialTable');
    const rows = financialTable.querySelectorAll('tbody tr');
    let hasYearlyBalance = false;
    
    // التحقق من وجود صف يحتوي على "رصيد حتى سنة" في عمود البيان (العمود الثالث)
    rows.forEach(row => {
        const description = row.cells[2].textContent.trim();
        
        if (description.includes('رصيد حتى سنة')) {
            hasYearlyBalance = true;
        }
    });
    
    // إذا لم يوجد رصيد سنوي، نطبق الخصم على جميع الصفوف
    if (!hasYearlyBalance) {
        rows.forEach(row => {
            const balanceCell = row.cells[7]; // عمود الرصيد (العمود الثامن)
            let balance = parseFloat(balanceCell.textContent) || 0;
            
            // تطبيق خصم 200 جنيه مع منع القيم السالبة
            balance = Math.max(0, balance - 200);
            balanceCell.textContent = balance.toFixed(2);
            
            // إعادة حساب مقابل التأخير لكل صف
            const rate = parseFloat(row.cells[4].textContent.replace('%', '')) || 0; // معدل الفائدة (العمود الخامس)
            const monthsText = row.cells[3].textContent; // الشهور (العمود الرابع)
            const months = parseInt(monthsText) || 0;
            
            const delayAmount = balance > 0 ? (balance * rate * months) / 1200 : 0;
            row.cells[8].textContent = delayAmount.toFixed(1); // مقابل التأخير (العمود التاسع)
        });
        
        // إعادة حساب الإجمالي بعد التعديلات
        calculateTotalDelay();
        return true; // تم تطبيق الخصم
    }
    
    return false; // لم يتم تطبيق الخصم
}

// دالة مساعدة لحساب إجمالي مقابل التأخير
function calculateTotalDelay() {
    const rows = document.querySelectorAll('#financialTable tbody tr');
    let totalDelay = 0;
    
    rows.forEach(row => {
        totalDelay += parseFloat(row.cells[8].textContent) || 0;
    });
    
    document.getElementById('totalDelayAmount').textContent = totalDelay.toFixed(2);
}

// استدعاء الدالة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    applyDiscountIfNoYearlyBalance();
});
  
 
  
// دالة مهمة تستخدم اذا كان هناك سنة بها اكتر من تاريخ ربط وسداد فقط ولا يوجد بها رصيد   
function fixEndPeriodForRabetIfSadadOnly(financialTableBody) {
    const rows = financialTableBody.rows;
    const originalRows = document.querySelectorAll("#balanceTable tbody tr");

    for (let i = 0; i < rows.length - 1; i++) {
        const currentRow = rows[i];
        const nextRow = rows[i + 1];
        const currentDesc = currentRow.cells[2].innerText.trim();

        const isRabet = /ربط.*سنة/i.test(currentDesc);
        if (!isRabet) continue;

        const rabetStartDate = parseDate(currentRow.cells[0].innerText);
        const rabetYear = rabetStartDate.getFullYear();

        let sadadDate = null;

        // البحث عن أول سداد بعد تاريخ الربط وفي نفس السنة
        for (let j = 0; j < originalRows.length; j++) {
            const row = originalRows[j];
            const desc = row.cells[1].innerText.trim();
            const dateStr = row.cells[3].innerText.trim();
            const date = parseDate(dateStr);

            if (/سداد/i.test(desc) && date > rabetStartDate && date.getFullYear() === rabetYear) {
                sadadDate = date;
                break;
            }
        }

        if (!sadadDate) continue;

        // 🔒 التحقق من وجود "رصيد حتى سنة" في نفس السنة، سواء قبل أو بعد
        let rasidInSameYearExists = false;
        for (let k = 0; k < rows.length; k++) {
            const row = rows[k];
            const desc = row.cells[2].innerText.trim();
            if (/رصيد حتى سنة/i.test(desc)) {
                const rasidDate = parseDate(row.cells[0].innerText);
                if (rasidDate && rasidDate.getFullYear() === rabetYear) {
                    rasidInSameYearExists = true;
                    break;
                }
            }
        }

        if (rasidInSameYearExists) continue; // لا تعديل إذا وُجد رصيد بنفس السنة

        const oldEnd = parseDate(currentRow.cells[1].innerText);

        // تعديل نهاية صف الربط
        if (oldEnd.getTime() !== sadadDate.getTime()) {
            currentRow.cells[1].innerText = formatDate(sadadDate);
            currentRow.style.backgroundColor = "#d2b4de";
            recalculateDelays();
        }

        // تعديل بداية صف السداد التالي
        if (/سداد/i.test(nextRow.cells[2].innerText.trim())) {
            const newSadadStart = getStartOfNextMonth(sadadDate);
            nextRow.cells[0].innerText = formatDate(newSadadStart);
            nextRow.style.backgroundColor = "#abebc6";
            recalculateDelays();
        }
    }
}



 
// تلوين الصفوف 
function colorizeTableRows() {
  const table = document.getElementById("financialTable");
  const rows = table.querySelectorAll("tbody tr");
  
  rows.forEach(row => {
    // إعادة تعيين لون الخلفية أولاً
    row.style.backgroundColor = "";
    
    // الحصول على نص البيان من الخلية الثانية (الفهرس 1)
   const description = row.cells[2]?.textContent.trim() || "";
    
    // تطبيق التلوين حسب التعبيرات النمطية
if (/رصيد/i.test(description)) {
  row.style.backgroundColor = "#DAF7A6"; // أخضر مائي فاتح
} else if (/ربط/i.test(description)) {
  row.style.backgroundColor = "#d2b4de"; // أصفر كريمي فاتح
} else if (/سداد/i.test(description)) {
  row.style.backgroundColor = "#abebc6"; // وردي فاتح
}
  });
}


// دالة حساب مقابل التأخير حسب وجود صف رصيد حتي سنة من عدم وجوده  
function recalculateDelays() {
    // الحصول على جميع صفوف الجدول المالي
    const financialRows = Array.from(document.querySelectorAll('#financialTable tbody tr'));
    let totalDelay = 0;
    let firstBalanceFound = false;
    
    // مسح جميع قيم التأخير السابقة
    financialRows.forEach(row => {
        row.cells[8].innerText = '0.0';
    });
    
    // إعادة حساب كل صف
    for (let i = 0; i < financialRows.length; i++) {
        const row = financialRows[i];
        const description = row.cells[2].innerText.trim();
        
        // التحقق مما إذا كان هذا صف رصيد
        if (/رصيد/i.test(description) && !firstBalanceFound) {
            firstBalanceFound = true;
        }
        
        // الحصول على التواريخ وإعادة حساب الفرق
        const startDateStr = row.cells[0].innerText.trim();
        const endDateStr = row.cells[1].innerText.trim();
        const startDate = parseDate(startDateStr);
        const endDate = parseDate(endDateStr);
        
        if (!startDate || !endDate) continue;
        
        // إعادة حساب عدد الشهور
        const months = (endDate.getFullYear() - startDate.getFullYear()) * 12 +
                      (endDate.getMonth() - startDate.getMonth()) + 1;
        row.cells[3].innerText = `${months}/12`;
        
        // الحصول على معدل الفائدة للسنة
        const year = startDate.getFullYear();
        const rate = interestRates[year] || 0;
        row.cells[4].innerText = `${rate.toFixed(2)}%`;
        
        // الحصول على المبالغ
        const linkAmount = parseFloat(row.cells[5].innerText.trim()) || 0;
        const paymentAmount = parseFloat(row.cells[6].innerText.trim()) || 0;
        const balance = parseFloat(row.cells[7].innerText.trim()) || 0;
        
        // حساب مقابل التأخير مع مراعاة خصم 200 جنيه
        let delayAmount = 0;
        if (balance > 0) {
            const taxableBalance = firstBalanceFound ? Math.max(balance - 200, 0) : balance;
            delayAmount = (taxableBalance * rate * months) / 12 / 100;
        }
        
        // تحديث قيمة التأخير في الجدول
        row.cells[8].innerText = delayAmount.toFixed(2);
        totalDelay += delayAmount;
    }
    
    // تحديث إجمالي مقابل التأخير
    document.getElementById('totalDelayAmount').innerText = totalDelay.toFixed(0);
    document.getElementById("textbox4").value = totalDelay.toFixed(0);
    updateTotalBalance0();
    updateTotalAfterDelayChange(totalDelay);  
    updateTotalPaid();
    updateNetDue();
  
    return totalDelay;
}


  
// حذف جميع الصفوف التي تحتوي علي مقابل تاخير 0 ما عدا صف السداد   
function removeZeroDelayRows() {
    const tableBody = document.querySelector("#financialTable tbody");
    const rows = tableBody.querySelectorAll("tr");

    rows.forEach(row => {
        const cells = row.querySelectorAll("td");

        if (cells.length >= 9) {
            const description = cells[2].textContent.trim(); // ← العمود الصحيح للبيان
            const delayAmountText = cells[8].textContent.trim(); // مقابل التأخير
            const delayAmount = parseFloat(delayAmountText.replace(/,/g, ''));

            const isZero = !isNaN(delayAmount) && delayAmount === 0;
            const isPaymentStatement = /سداد/i.test(description); // تطابق مع كلمة "سداد" بأي شكل

            if (isZero && !isPaymentStatement) {
                row.remove();
            }
        }
    });
}
   

// تحديث نسبة مقابل التأخير 
function selectArticle45Repeated() {
    const select = document.getElementById('textbox12');
    for (let i = 0; i < select.options.length; i++) {
        if (select.options[i].text === 'المادة 45 مكرر') {
            select.selectedIndex = i;
            break;
        }
    }
    show1(); // استدعاء دالة التحديث بعد تغيير الاختيار
}

  
// التأكد من تواريخ بداية ونهاية كل صف 
function fixPeriodDates() {
    const rows = document.querySelectorAll("#financialTable tbody tr");

    rows.forEach((row) => {
        const startCell = row.cells[0]; // بداية الفترة
        const endCell = row.cells[1];   // نهاية الفترة

        const startText = startCell.textContent.trim();
        const endText = endCell.textContent.trim();

        const startParts = startText.split("/");
        const endParts = endText.split("/");

        if (startParts.length === 3 && endParts.length === 3) {
            let [startDay, startMonth, startYear] = startParts.map(p => parseInt(p, 10));
            let [endDay, endMonth, endYear] = endParts.map(p => parseInt(p, 10));

            // ✅ تصحيح بداية الفترة إلى 01/mm/yyyy
            if (startDay !== 1) {
                const correctedStart = `01/${String(startMonth).padStart(2, '0')}/${startYear}`;
                startCell.textContent = correctedStart;
            }

            // ✅ تصحيح نهاية الفترة إلى آخر يوم من الشهر
            const lastDay = new Date(endYear, endMonth, 0).getDate();
            if (endDay !== lastDay) {
                const correctedEnd = `${String(lastDay).padStart(2, '0')}/${String(endMonth).padStart(2, '0')}/${endYear}`;
                endCell.textContent = correctedEnd;
            }
        }
    });
}


</script>
   
 
  
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script>
    $(document).ready(function() {
        // تحديد تنسيق التاريخ
        $.datepicker.setDefaults({
            dateFormat: 'yy/mm/dd',
            changeMonth: true, // تمكين تغيير الشهر
            changeYear: true,  // تمكين تغيير السنة
            yearRange: '2005:2025', // تحديد الحد الأدنى والأقصى للسنة
            defaultDate: new Date(), // تحديد التاريخ الافتراضي ليكون تاريخ اليوم
            monthNames: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
            monthNamesShort: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
            beforeShow: function(input, inst) {
                setTimeout(function() {
                    $(input).prop('readOnly', true); // تعيين الخاصية readOnly عند فتح التقويم
                }, 0);
            },
            onClose: function(dateText, inst) {
                $(this).prop('readOnly', false); // إعادة تفعيل الإدخال بعد إغلاق التقويم
            }
        });

        // تفعيل تقويم التاريخ
        $('#endDate').datepicker();
    });
</script>
<script>
    // لتغيير اتجاه الصفحة من اليسار إلى اليمين (RTL)
    document.dir = 'rtl';

    // تبديل الوضع الليلي
    function toggleNightMode() {
        const body = document.body;
        body.classList.toggle('dark-mode');
        const nightModeToggle = document.querySelector('.night-mode-toggle');
        const isNightMode = body.classList.contains('dark-mode');
        nightModeToggle.innerHTML = isNightMode ? '☀' : '🌙';
        // حفظ تفضيل الوضع الليلي
        localStorage.setItem('darkModePreference', isNightMode ? 'true' : 'false');
    }

    // تحميل تفضيل العرض المحفوظ والوضع الليلي
    document.addEventListener('DOMContentLoaded', function() {
        const darkModePreference = localStorage.getItem('darkModePreference');
        // تطبيق الوضع الليلي إذا كان مفعلاً
        if (darkModePreference === 'true') {
            toggleNightMode();
        }
    });
// إظهار النص العائم عند تحميل الصفحة
window.onload = function () {
    clearFields();
    showFloatingText(); // استدعاء الدالة لأول مرة عند تحميل الصفحة

    // تكرار إظهار النص العائم كل 30 ثانية فقط إذا لم تكن هناك نوافذ مفتوحة
    setInterval(function () {
        showFloatingText();
    }, 30000);

    // إعادة توجيه المستخدم عند الضغط على الأيقونة العائمة
    document.getElementById("youtubeIcon").onclick = function () {
        window.location.href = "https://play.google.com/store/apps/details?id=com.mrizk.taxlawapp";
    };
};

// دالة لإظهار النص العائم مع التحقق من حالة النوافذ
function showFloatingText() {
    var floatingText = document.getElementById("floatingText");
    if (!floatingText) return;

    // لا تعرض النص إذا كانت هناك نافذة مفتوحة
    if (checkOpenModals()) {
        floatingText.style.display = "none";
        return;
    }

    // إظهار النص العائم
    floatingText.style.display = "block";

    // إخفاء النص العائم بعد 5 ثوانٍ إذا لم تظهر نوافذ خلال هذه الفترة
    setTimeout(function () {
        if (!checkOpenModals()) {
            floatingText.style.display = "none";
        }
    }, 5000);
}

// دالة التحقق من وجود نوافذ مفتوحة
function checkOpenModals() {
    return Object.values(modals).some(m =>
        m.modal && m.modal.style.display === "block"
    );
}


function clearAllFields() {
  // تفريغ جدول financialTable tbody
  const table = document.getElementById("financialTable");

  if (table) {
    const rowCount = table.rows.length;
    if (rowCount > 2) {  // إذا في أكثر من صفين (رأس + صف آخر)
      for (let i = 1; i < rowCount - 1; i++) {
        table.rows[i].style.display = "none";  // اخفي الصفوف ماعدا الرأس والأخير
      }
    }
  }

  // إعادة تعيين الحقول النصية للفراغ
  document.getElementById('textbox5').value = '';
  document.getElementById('textbox4').value = '';
  document.getElementById('textbox9').value = '';
  document.getElementById('textbox10').value = '';
  document.getElementById('textbox6').value = '';
  document.getElementById('textbox7').value = '';
  document.getElementById('textbox8').value = '';

  // إعادة تعيين قائمة نسبة التجاوز للخيار الأول
  const selectElem = document.getElementById('textbox12');
  selectElem.selectedIndex = 0;

  // إعادة تعيين الإجمالي في جدول financialTable
  const totalDelayAmount = document.getElementById("totalDelayAmount");
  if (totalDelayAmount) {
    totalDelayAmount.textContent = "0";
  }

  // إعادة تعيين الإجمالي في جدول balanceTable
  const totalBalance = document.getElementById("totalbalance");
  if (totalBalance) {
    totalBalance.textContent = "0";
  } 
  
  // ✅ إعادة تفعيل زر "إضافة رصيد سابق" إذا كان معطلاً
  const addBtn = document.getElementById("addtaxBalanceBtn");
  if (addBtn.hasAttribute("disabled")) {
    addBtn.removeAttribute("disabled");
    addBtn.classList.remove("disabled");
  }
    const checkbox = document.getElementById("discount200");
      checkbox.disabled = true; // تعطيل الـ checkbox
      checkbox.checked = false; // إعادة التحديد إلى غير محدد  
}

  
// زر افراغ البيانات 
function clearFields() {
  // إعادة تعيين قائمة الكيان القانوني
  const legalEntitySelect = document.getElementById("textbox11");
  if (legalEntitySelect) {
    legalEntitySelect.selectedIndex = 1;
  }

  // حذف جميع الصفوف من tbody جدول financialTable
  const financialTable = document.getElementById("financialTable");
  if (financialTable) {
    const tbody = financialTable.querySelector("tbody");
    if (tbody) {
      tbody.innerHTML = "";
    }
  }

  // حذف جميع الصفوف من tbody جدول balanceTable
  const balanceTable = document.getElementById("balanceTable");
  if (balanceTable) {
    const tbody = balanceTable.querySelector("tbody");
    if (tbody) {
      tbody.innerHTML = "";
    }
  }

  // تحديد الحقول النصية باستثناء endDate مؤقتًا
  const fieldsToClear = [
    'textbox5', 'textbox4', 'textbox9',
    'textbox10', 'textbox6', 'textbox7',
    'textbox8'
  ];

  fieldsToClear.forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.value = '';
  });

  // التعامل مع endDate حسب تفعيل التعيين التلقائي
  const autoDateEnabled = localStorage.getItem('autoSetTodayDate') === 'true';
  const endDateInput = document.getElementById("endDate");
  if (endDateInput) {
    if (!autoDateEnabled) {
      endDateInput.value = '';
      endDateInput.focus(); // فقط إذا لم يكن التعيين التلقائي مفعلًا
    }
    // إذا كان مفعلًا: لا تفرغ ولا تعمل فوكس
  }

  // إعادة تعيين قائمة نسبة التجاوز
  const overrideSelect = document.getElementById('textbox12');
  if (overrideSelect) {
    overrideSelect.selectedIndex = 1;
  }

  // إعادة تعيين الإجمالي في جدول financialTable
  const totalDelayAmount = document.getElementById("totalDelayAmount");
  if (totalDelayAmount) {
    totalDelayAmount.textContent = "0";
  }

  // إعادة تعيين الإجمالي في جدول balanceTable
  const totalBalance = document.getElementById("totalbalance");
  if (totalBalance) {
    totalBalance.textContent = "0";
  }

  // إعادة تفعيل زر "إضافة رصيد سابق" إذا كان معطلاً
  const addBtn = document.getElementById("addtaxBalanceBtn");
  if (addBtn && addBtn.hasAttribute("disabled")) {
    addBtn.removeAttribute("disabled");
    addBtn.classList.remove("disabled");
  }

  // تعطيل checkbox الخاص بالخصم وإلغاء تحديده
  const checkbox = document.getElementById("discount200");
  if (checkbox) {
    checkbox.disabled = true;
    checkbox.checked = false;
  }
}
</script>                     

 <script>  
 // لتغيير اتجاه الصفحة من اليسار إلى اليمين  (RTL)
document.dir = 'rtl';
  </script>  
      
<script> 
// الجزء الثابت من معرف الزيارة
const expectedVisitIDPrefix = 'Tax Law App | ';

// قائمة بالمعرفات المسموح بها
const allowedVisitIDs = [
    'Tax Law App | 24911910LTLA541',
    'Tax Law App | 24771910YTLA338'
  
    // أضف المزيد من المعرفات المسموح بها هنا
];

// التحقق من معرف الزيارة المخزن في التخزين المحلي
function checkStoredVisitID() {
    const storedVisitID = localStorage.getItem('visitID');
    const expiryTimestamp = localStorage.getItem('visitIDExpiry');
    const freeAccessPressed = localStorage.getItem(getFreeAccessKey());
    const freeAccessBtn = document.getElementById('freeAccessBtn');

    // الحصول على الوقت الحالي
    const currentTime = new Date().getTime();

    // إذا كان هناك معرف مخزن وصلاحيته لم تنتهِ، اظهار المحتوى
    if (storedVisitID && expiryTimestamp && currentTime < expiryTimestamp) {
        document.getElementById('pageContent').style.display = 'block';
        document.getElementById('visitPrompt').style.display = 'none';
    } else {
        // إظهار نافذة الإدخال
        document.getElementById('visitPrompt').style.display = 'block';
    }

    // إذا تم الضغط على زر الدخول المجاني من قبل لهذه الصفحة، قم بتعطيله
    if (freeAccessPressed === 'true') {
        freeAccessBtn.classList.add('disabled');
        freeAccessBtn.disabled = true;

        // إضافة تلميح يظهر عند التمرير على الزر
        freeAccessBtn.title = "تم الدخول مجانا من قبل .. يمكنك التواصل مع مطور التطبيق واتساب : 01030069322 لطلب معرف جديد";
    }
}

// توليد مفتاح فريد لكل صفحة بناءً على نص h2
function getFreeAccessKey() {
    const pageName = document.querySelector('h2').innerText.trim(); // الحصول على نص h2
    return `freeAccessPressed_${pageName}`; // مفتاح مميز لكل صفحة
}

// الدخول لأول مرة (مجاناً)
function firstFreeAccess() {
    // إظهار المحتوى
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('visitPrompt').style.display = 'none';
    document.getElementById('pageContent').style.display = 'block';

    // تعطيل الزر بعد الدخول لأول مرة
    const freeAccessBtn = document.getElementById('freeAccessBtn');
    freeAccessBtn.classList.add('disabled');
    freeAccessBtn.disabled = true;

    // تخزين حالة الضغط على الزر في التخزين المحلي مع مفتاح فريد لكل صفحة
    localStorage.setItem(getFreeAccessKey(), 'true');

    // إخفاء المحتوى بعد 5 دقائق وإعادة إظهار نافذة الإدخال
    setTimeout(() => {
        document.getElementById('pageContent').style.display = 'none';
        document.getElementById('visitPrompt').style.display = 'block';
    }, 300000); // 300 ثانية (5 دقائق)
}

// التحقق من معرف الزيارة المدخل
function checkVisitID() {
    const inputID = document.getElementById('visitIDInput').value.trim(); 
    const messageDiv = document.getElementById('message'); 
    const contactMessageDiv = document.getElementById('contactMessage'); 

    // إذا كان الحقل فارغًا
    if (inputID === '') {
        messageDiv.textContent = 'يرجي إدخال معرف الزيارة الخاص بك.'; 
        document.getElementById('visitIDInput').focus(); 
        return; 
    }

    // الحصول على التاريخ الحالي
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0'); 
    const month = String(today.getMonth() + 1).padStart(2, '0'); 

    // التحقق من الجزء الأول
    if (!inputID.startsWith(expectedVisitIDPrefix)) {
        messageDiv.textContent = 'عفوا معرف الزيارة الخاص بك غير صحيح .. الرجاء التواصل مع مطور التطبيق واتساب رقم :';
        contactMessageDiv.innerHTML = '<span class="whatsapp-link" onclick="openWhatsApp()">01030069322 | إنقر هنا</span>';
        return;
    }

    // الحصول على الجزء الثاني من المعرف
    const visitIDPart = inputID.slice(expectedVisitIDPrefix.length);

    // بناء التعبير المنتظم للتحقق من الشروط
    const regex = new RegExp(`^24\\d{2}${day}${month}[A-Z]TLA\\d{3}$`);

    // التحقق من الجزء الثاني باستخدام التعبير المنتظم
    if (regex.test(visitIDPart)) {
        // التحقق مما إذا كان المعرف موجودًا في قائمة المسموح بها
        if (allowedVisitIDs.includes(inputID)) {
            // التحقق مما إذا كان المعرف مطابقًا للمعرف المخزن
            const storedVisitID = localStorage.getItem('visitID');
            if (storedVisitID && storedVisitID === inputID) {
                messageDiv.textContent = 'عفوا إنتهت صلاحية معرف الزيارة الخاص بك | لطلب معرف جديد الرجاء التواصل مع مطورالتطبيق واتساب رقم :';
                contactMessageDiv.innerHTML = '<span class="whatsapp-link" onclick="openWhatsApp()">01030069322 | إنقر هنا</span>';
                return;
            } else {
                // إذا كان المعرف مختلفًا، تخزينه وإظهار المحتوى
                localStorage.setItem('visitID', inputID); 
                localStorage.setItem('visitIDExpiry', new Date().getTime() + 86400000); // 24 ساعة

                document.getElementById('overlay').style.display = 'none';
                document.getElementById('visitPrompt').style.display = 'none';
                document.getElementById('pageContent').style.display = 'block';

                // إفراغ حقل إدخال معرف الزيارة
                document.getElementById('visitIDInput').value = '';

        // إخفاء المحتوى بعد 24 ساعة وإعادة إظهار نافذة الإدخال
        setTimeout(() => {
        document.getElementById('pageContent').style.display = 'none';
        document.getElementById('visitPrompt').style.display = 'block';
        }, 86400000); // 24 ساعة
      }
        } else {
            messageDiv.textContent = 'عفوا معرف الزيارة الخاص بك غير مسموح به .. الرجاء التواصل مع مطور التطبيق واتساب رقم :';
        contactMessageDiv.innerHTML = '<span class="whatsapp-link" onclick="openWhatsApp()">01030069322 | إنقر هنا</span>';
        }
    } else {
        messageDiv.textContent = 'عفوا معرف الزيارة الخاص بك غير صحيح .. الرجاء التواصل مع مطور التطبيق واتساب رقم :';
        contactMessageDiv.innerHTML = '<span class="whatsapp-link" onclick="openWhatsApp()">01030069322 | إنقر هنا</span>';
    }
}

// لصق المعرف من الحافظة
function pasteVisitID() {
    navigator.clipboard.readText().then(text => {
        document.getElementById('visitIDInput').value = text; 
    });
}

// إفراغ حقل الإدخال
function clearVisitID() {
    document.getElementById('visitIDInput').value = ''; 
    document.getElementById('message').textContent = ''; 
    document.getElementById('contactMessage').innerHTML = ''; 
}

// فتح واتساب مع الرسالة المحددة
function openWhatsApp() {
    const visitID = document.getElementById('visitIDInput').value.trim();
    const message = `السلام عليكم ورحمة الله وبركاته .. أنا أستخدم تطبيق Tax Law App إستفساري بخصوص طلب معرف الزيارة الخاص بي لشاشة | ${document.querySelector('h2').innerText} | تكلفة المعرف لمرة واحدة ( يوم كامل 24 ساعة ) : 50 جنية معلومات الدفع : يتم دفع تكلفة المعرف إما من خلال 1- محفظة ڤودافون كاش علي الرقم التالي : ( 01030069322 ) 2- تطبيق إنستا باي علي عنوان الدفع التالي : ( mahmoudrizk16@instapay ) 3- أي تطبيق بنكي آخر محافظ إلكترونية وحسابات علي الرقم التالي : ( 01030069322 ) وإرسال صورة إيصال الدفع لتوليد معرف الزيارة الخاص بك | يرجي العلم أن صلاحية معرف الزيارة 24 ساعة فقط ولن يتم توليد المعرف إلا من خلال صورة إيصال الدفع الخاص بك.`;
    const whatsappMessage = encodeURIComponent(message); // ترميز الرسالة
    const whatsappURL = `https://wa.me/201030069322?text=${whatsappMessage}`; // إدخال الرقم مباشرة

    // فتح نافذة واتساب في نافذة جديدة
    var whatsappWindow = window.open(whatsappURL, '_blank');

    // تأخير إغلاق مربع الحوار وتفريغ حقل الإدخال لضمان فتح نافذة واتساب أولاً
    setTimeout(() => {
        // إفراغ حقل إدخال المعرف
        document.getElementById('visitIDInput').value = ''; 
        document.getElementById('message').textContent = ''; 
        document.getElementById('contactMessage').innerHTML = ''; 
    }, 1000); // 1 ثانية
}

// عند تحميل الصفحة
window.onload = () => {
    checkStoredVisitID(); // التحقق من معرف الزيارة المخزن
};   
  
  
// التحقق من التخزين المحلي عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
    checkStoredVisitID();
  
    // قراءة بيانات المستخدم من localStorage
    const user = JSON.parse(localStorage.getItem('loggedInUser'));

    if (user) {
        // الحصول على التاريخ والوقت الحاليين
        const now = new Date();
        const currentDate = new Date();
        const expiryDateParts = user.expiryDate.split('/');
        const expiryDate = new Date(expiryDateParts[2], expiryDateParts[1] - 1, expiryDateParts[0]);
        const timeDiff = expiryDate - currentDate;
        let daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

        // إذا كانت الفترة المتبقية فارغة أو أقل من أو تساوي صفر، تعيينها إلى صفر
        if (isNaN(daysDiff) || daysDiff <= 0) {
            daysDiff = 0;
        }

        // عرض اسم المستخدم والفترة المتبقية
        document.getElementById('usernameDisplay').innerHTML = `
            <p><i class="fas fa-user"></i> المستخدم الحالي : ${user.fullName}</p>
            <p><i class="fas fa-hourglass-half"></i> الفترة المتبقية : ${daysDiff} يوم</p>
        `;

        // إذا كانت الفترة المتبقية أكبر من الصفر، إخفاء نافذة إدخال المعرف       
       if (daysDiff > 0) {
            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('visitPrompt').style.display = 'none';
                document.getElementById('pageContent').style.display = 'block';
            }, 500); // الانتظار لمدة 500 ملي ثانية قبل إخفاء النافذة
        } else {
            // إذا كانت الفترة أقل من أو تساوي صفر، إظهار نافذة إدخال المعرف
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('visitPrompt').style.display = 'block';
        }
    } else {
        // إذا كانت بيانات المستخدم فارغة، إظهار نافذة إدخال المعرف
        //document.getElementById('overlay').style.display = 'block';
        document.getElementById('visitPrompt').style.display = 'block';
    }
}); 
</script>



<script>
function clickIE4() {
    if (2 == event.button) {
        return false;
    }
}

function clickNS4(e) {
    if ((document.layers || (document.getElementById && !document.all)) && (2 == e.which || 3 == e.which)) {
        return false;
    }
}

document.oncontextmenu = function () {
    return false;
};

document.onkeydown = function (e) {
    if (
        123 == e.keyCode ||
        (e.ctrlKey && 73 == e.keyCode) ||
        (e.ctrlKey && 67 == e.keyCode) ||
        (e.ctrlKey && 74 == e.keyCode) ||
        (e.ctrlKey && 80 == e.keyCode) ||
        (e.ctrlKey && 85 == e.keyCode) ||
        (e.ctrlKey && 83 == e.keyCode)
    ) {
        return false;
    }
};
</script> 